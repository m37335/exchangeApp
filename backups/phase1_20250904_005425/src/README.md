# Source Code フォルダ解説

## 📁 概要

`src/`フォルダは、Exchange Analytics USD/JPY パターン検出システムのコアソースコードを管理しています。**Clean Architecture + Domain-Driven Design**に基づいて設計され、保守性・拡張性・テスタビリティを重視した構造になっています。

## 🏗️ アーキテクチャ概要

### Clean Architecture レイヤー構造

```
src/
├── domain/          # ドメイン層（ビジネスロジック）
├── application/     # アプリケーション層（ユースケース）
├── infrastructure/  # インフラストラクチャ層（外部依存）
├── presentation/    # プレゼンテーション層（UI/API）
├── utils/           # ユーティリティ（共通機能）
└── container.py     # 依存性注入コンテナ
```

### 依存関係の方向

```
Presentation → Application → Domain ← Infrastructure
     ↓              ↓           ↑           ↑
   UI/API     Use Cases    Business    External
   Layer      Layer        Logic       Dependencies
```

## 🎯 Domain Layer - ドメイン層

**用途**: ビジネスロジック・エンティティ・値オブジェクトの定義

### 📁 entities/ - エンティティ

**ビジネスエンティティの定義**

- **`base.py`**: 基底エンティティクラス（4.7KB, 176 行）

  - 共通プロパティ・メソッド
  - ID 管理・タイムスタンプ

- **`exchange_rate.py`**: 為替レートエンティティ（5.3KB, 169 行）

  - 通貨ペア・価格・タイムスタンプ
  - 為替データの基本構造

- **`entry_signal.py`**: エントリーシグナルエンティティ（8.1KB, 281 行）

  - パターン検出結果
  - シグナル強度・信頼度

- **`notification_pattern.py`**: 通知パターンエンティティ（19KB, 456 行）

  - 通知設定・テンプレート
  - パターン検出ルール

- **`risk_alert.py`**: リスクアラートエンティティ（6.1KB, 238 行）

  - リスク評価・警告レベル
  - リスク管理ロジック

- **`analysis_cache.py`**: 分析キャッシュエンティティ（7.6KB, 261 行）

  - 分析結果のキャッシュ
  - パフォーマンス最適化

- **`api_call_history.py`**: API 呼び出し履歴エンティティ（7.7KB, 254 行）

  - 外部 API 呼び出し記録
  - レート制限管理

- **`notification_history.py`**: 通知履歴エンティティ（6.1KB, 214 行）
  - 通知送信履歴
  - 配信状況追跡

### 📁 value_objects/ - 値オブジェクト

**不変な値オブジェクトの定義**

- 通貨ペア・価格・時間範囲などの値オブジェクト
- ビジネスルールのカプセル化

### 📁 repositories/ - リポジトリインターフェース

**データアクセスの抽象化**

- エンティティの永続化インターフェース
- ドメイン層とインフラ層の分離

### 📁 services/ - ドメインサービス

**ビジネスロジックの実装**

#### 主要サービス

- **`exchange_rate_service.py`**: 為替レートサービス（11KB, 317 行）
  - 為替データの取得・処理
  - ビジネスルールの適用

#### サブディレクトリ

- **`alert_engine/`**: アラートエンジン
- **`optimization/`**: 最適化サービス
- **`performance/`**: パフォーマンス管理
- **`correlation/`**: 相関分析
- **`notification/`**: 通知サービス
- **`risk_management/`**: リスク管理

## 🔧 Application Layer - アプリケーション層

**用途**: ユースケース・アプリケーションサービス・コマンド/クエリ

### 📁 commands/ - コマンド

**書き込み操作のユースケース**

- データ更新・作成・削除のコマンド
- CQRS パターンの実装

### 📁 queries/ - クエリ

**読み取り操作のユースケース**

- データ取得・検索のクエリ
- パフォーマンス最適化

### 📁 handlers/ - ハンドラー

**コマンド・クエリの処理**

- ビジネスロジックの調整
- トランザクション管理

### 📁 services/ - アプリケーションサービス

**ユースケースの実装**

- **`technical_indicator_diff_calculator.py`**: テクニカル指標差分計算（12KB, 343 行）
  - 指標間の差分分析
  - 変化率計算

### 📁 interfaces/ - インターフェース

**アプリケーション層の抽象化**

- 外部依存のインターフェース定義
- 依存関係逆転の実装

### 📁 dto/ - データ転送オブジェクト

**層間データ転送**

- リクエスト・レスポンスの構造
- データ変換・検証

### 📁 exceptions/ - 例外

**アプリケーション例外**

- ビジネス例外の定義
- エラーハンドリング

## 🏗️ Infrastructure Layer - インフラストラクチャ層

**用途**: 外部依存・データベース・API・設定管理

### 📁 database/ - データベース

**データ永続化の実装**

#### 主要ファイル

- **`connection.py`**: データベース接続管理（12KB, 401 行）
  - 接続プール・セッション管理
  - トランザクション制御

#### サブディレクトリ

- **`models/`**: データベースモデル
- **`repositories/`**: リポジトリ実装
- **`services/`**: データベースサービス
- **`optimization/`**: クエリ最適化

### 📁 external_apis/ - 外部 API

**外部サービスの統合**

- **`yahoo_finance_client.py`**: Yahoo Finance API クライアント（14KB, 397 行）

  - 為替データ取得
  - レート制限管理

- **`openai_client.py`**: OpenAI API クライアント（16KB, 461 行）

  - AI 分析・予測
  - GPT-4 統合

- **`alpha_vantage_client.py`**: Alpha Vantage API クライアント（14KB, 446 行）

  - 株価・為替データ
  - リアルタイム情報

- **`base_client.py`**: 基底 API クライアント（12KB, 388 行）
  - 共通機能・エラーハンドリング
  - リトライ・キャッシュ

### 📁 notification/ - 通知システム

**通知機能の実装**

- **`discord_webhook_sender.py`**: Discord Webhook 送信（4.8KB, 165 行）

  - Discord 通知統合
  - メッセージフォーマット

- **`notification_manager_integration.py`**: 通知マネージャー統合（11KB, 330 行）

  - 通知システム管理
  - 複数チャンネル対応

- **`notification_cron.py`**: 通知定期実行（10KB, 309 行）
  - スケジュール通知
  - バッチ処理

### 📁 monitoring/ - 監視システム

**システム監視・メトリクス**

- パフォーマンス監視
- ヘルスチェック
- ログ管理

### 📁 performance/ - パフォーマンス管理

**パフォーマンス最適化**

- **`performance_optimizer.py`**: パフォーマンス最適化（13KB, 395 行）
  - メモリ・CPU 最適化
  - クエリ最適化

### 📁 その他のサブディレクトリ

- **`config/`**: 設定管理
- **`scheduler/`**: スケジューリング
- **`schedulers/`**: スケジューラー実装
- **`error_handling/`**: エラーハンドリング
- **`optimization/`**: 最適化
- **`messaging/`**: メッセージング
- **`cache/`**: キャッシュシステム
- **`analysis/`**: 分析機能

## 🎨 Presentation Layer - プレゼンテーション層

**用途**: ユーザーインターフェース・API・CLI

### 📁 api/ - API

**RESTful API の実装**

- **`app.py`**: API アプリケーション（7.6KB, 261 行）
  - FastAPI アプリケーション
  - ルーティング・ミドルウェア

#### サブディレクトリ

- **`routes/`**: API ルート
- **`middleware/`**: ミドルウェア

### 📁 cli/ - コマンドラインインターフェース

**CLI アプリケーション**

- **`main.py`**: CLI メインアプリケーション（6.3KB, 235 行）
  - Click ベースの CLI
  - コマンド定義

#### サブディレクトリ

- **`commands/`**: CLI コマンド

### 📁 web/ - Web UI

**Web ユーザーインターフェース**

- Streamlit ダッシュボード
- Web 管理画面

## 🛠️ Utils - ユーティリティ

**用途**: 共通機能・ヘルパー関数

### 主要ファイル

- **`logging_config.py`**: ログ設定（5.7KB, 205 行）

  - ログレベル・フォーマット
  - 構造化ログ

- **`pattern_utils.py`**: パターン検出ユーティリティ（9.7KB, 264 行）

  - パターン検出アルゴリズム
  - 数学的計算

- **`cache_utils.py`**: キャッシュユーティリティ（8.1KB, 287 行）

  - キャッシュ管理
  - パフォーマンス最適化

- **`optimization_utils.py`**: 最適化ユーティリティ（10KB, 354 行）

  - アルゴリズム最適化
  - メモリ管理

- **`progress_manager.py`**: 進捗管理（7.4KB, 225 行）
  - 処理進捗の追跡
  - ユーザーフィードバック

## 🔧 Container - 依存性注入コンテナ

**用途**: 依存関係の管理・DI コンテナ

### container.py - メインコンテナ

**依存性注入コンテナ（5.5KB, 189 行）**

**機能**:

- 設定の管理
- サービスのライフサイクル管理
- 依存関係の解決
- プラグインシステムとの統合

**設計原則**:

- SOLID 原則の D（依存関係逆転原則）
- Clean Architecture の実装
- テスタビリティの向上

## 🎯 設計思想

### 1. Clean Architecture

- **依存関係の方向**: 内側に向かって依存
- **関心の分離**: 各レイヤーの責任を明確化
- **テスタビリティ**: 単体テストの容易さ

### 2. Domain-Driven Design

- **ユビキタス言語**: ビジネス用語の統一
- **エンティティ・値オブジェクト**: ドメインモデルの表現
- **集約**: データ整合性の保証

### 3. SOLID 原則

- **単一責任原則**: 各クラスの単一責任
- **開放閉鎖原則**: 拡張に開き、修正に閉じる
- **リスコフ置換原則**: 継承の適切な使用
- **インターフェース分離原則**: 必要最小限のインターフェース
- **依存関係逆転原則**: 抽象に依存

## 📊 統計情報

- **総ファイル数**: 100+ ファイル
- **総コード行数**: 50,000+ 行
- **レイヤー数**: 4 レイヤー（Domain, Application, Infrastructure, Presentation）
- **主要エンティティ**: 8 種類
- **外部 API 統合**: 3 種類（Yahoo Finance, OpenAI, Alpha Vantage）
- **データベース**: PostgreSQL + SQLAlchemy
- **Web フレームワーク**: FastAPI
- **CLI フレームワーク**: Click

## 🚀 開発ガイドライン

### 新機能追加

1. **ドメイン層**: エンティティ・ビジネスロジックの定義
2. **アプリケーション層**: ユースケースの実装
3. **インフラ層**: 外部依存の実装
4. **プレゼンテーション層**: UI/API の実装

### テスト戦略

- **ユニットテスト**: 各レイヤーの単体テスト
- **統合テスト**: レイヤー間の統合テスト
- **E2E テスト**: エンドツーエンドテスト

### パフォーマンス最適化

- **キャッシュ**: Redis によるキャッシュ
- **非同期処理**: asyncio による非同期処理
- **データベース最適化**: クエリ最適化・インデックス

## 🚨 注意事項

1. **依存関係**: 内側のレイヤーは外側のレイヤーに依存しない
2. **インターフェース**: 抽象に依存し、具象に依存しない
3. **テスト**: 各レイヤーは独立してテスト可能
4. **設定**: 環境別設定の適切な管理
5. **ログ**: 構造化ログによる追跡可能性
