**旧ファイル名**: `api_optimization_design_2025.md`  

# 🔧 API 最適化設計書（2025 年 8 月版）

# API 制限問題解決とデータベース活用戦略

## 📋 概要

### 問題の背景

- **API 制限エラー**: Yahoo Finance API の過度な呼び出しによる制限エラー
- **実行頻度**: 現在 2 時間ごと、1 時間ごと、オープン時に実行
- **1 回の実行**: 約 9 回の API 呼び出し（通貨相関 5 回 + テクニカル指標 3 回 + AI 分析 1 回）
- **1 日の総呼び出し**: 約 171 回/日

### 解決目標

- **API 呼び出し削減**: 80%以上の削減を目指す
- **データベース活用**: 既存の ExchangeRateModel を最大限活用
- **キャッシュ戦略**: メモリ・ファイル・データベースの 3 層キャッシュ
- **通知精度維持**: データの鮮度を保ちながら API 削減

## 🏗️ アーキテクチャ設計

### 現在のアーキテクチャ

```
┌─────────────────┐    ┌─────────────────┐    ┌─────────────────┐
│   Cron Jobs     │───▶│  API Clients    │───▶│  External APIs  │
│                 │    │                 │    │                 │
│ • integrated_ai │    │ • YahooFinance  │    │ • Yahoo Finance │
│ • real_ai_v2    │    │ • OpenAI        │    │ • OpenAI        │
│ • data_scheduler│    │                 │    │                 │
└─────────────────┘    └─────────────────┘    └─────────────────┘
                                │
                                ▼
                       ┌─────────────────┐
                       │   Analysis      │
                       │                 │
                       │ • Technical     │
                       │ • Correlation   │
                       │ • AI Analysis   │
                       └─────────────────┘
```

### 最適化後のアーキテクチャ

```
┌─────────────────┐    ┌─────────────────┐    ┌─────────────────┐
│   Cron Jobs     │───▶│  Cache Layer    │───▶│  Database       │
│                 │    │                 │    │                 │
│ • integrated_ai │    │ • Memory Cache  │    │ • ExchangeRate  │
│ • real_ai_v2    │    │ • File Cache    │    │ • AnalysisCache │
│ • data_scheduler│    │ • DB Cache      │    │ • Notification  │
└─────────────────┘    └─────────────────┘    └─────────────────┘
                                │
                                ▼
                       ┌─────────────────┐    ┌─────────────────┐
                       │  API Clients    │───▶│  External APIs  │
                       │                 │    │                 │
                       │ • YahooFinance  │    │ • Yahoo Finance │
                       │ • OpenAI        │    │ • OpenAI        │
                       │ • Rate Limited  │    │                 │
                       └─────────────────┘    └─────────────────┘
```

## 📊 データフロー設計

### 現在のデータフロー

```
1. Cron実行
   ↓
2. fetch_all_currency_data()
   ├── USD/JPY API呼び出し
   ├── EUR/USD API呼び出し
   ├── GBP/USD API呼び出し
   ├── EUR/JPY API呼び出し
   └── GBP/JPY API呼び出し
   ↓
3. _fetch_technical_indicators()
   ├── D1履歴データ取得
   ├── H4履歴データ取得
   └── H1履歴データ取得
   ↓
4. generate_integrated_analysis()
   └── OpenAI API呼び出し
```

### 最適化後のデータフロー

```
1. Cron実行
   ↓
2. CacheManager.check_data_freshness()
   ├── データベースから最新データ取得
   ├── キャッシュ有効期限チェック
   └── 必要に応じてAPI呼び出し
   ↓
3. DataOptimizer.get_optimized_data()
   ├── 複数通貨ペアの一括取得
   ├── 履歴データの効率的取得
   └── 分析結果のキャッシュ
   ↓
4. AnalysisCache.get_cached_analysis()
   └── キャッシュされた分析結果の活用
```

## 🗄️ データベース設計拡張

### 既存テーブル活用

```sql
-- 既存のexchange_ratesテーブル
CREATE TABLE exchange_rates (
    id SERIAL PRIMARY KEY,
    uuid VARCHAR(36) UNIQUE NOT NULL,
    currency_pair VARCHAR(10) NOT NULL,
    rate NUMERIC(20,10) NOT NULL,
    bid_rate NUMERIC(20,10),
    ask_rate NUMERIC(20,10),
    spread NUMERIC(20,10),
    high_rate NUMERIC(20,10),
    low_rate NUMERIC(20,10),
    open_rate NUMERIC(20,10),
    close_rate NUMERIC(20,10),
    volume INTEGER,
    source VARCHAR(50) NOT NULL DEFAULT 'unknown',
    timestamp TIMESTAMP WITH TIME ZONE NOT NULL,
    extra_metadata TEXT,
    created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
    updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
    version INTEGER DEFAULT 1
);
```

### 新規テーブル追加

```sql
-- 分析結果キャッシュテーブル
CREATE TABLE analysis_cache (
    id SERIAL PRIMARY KEY,
    uuid VARCHAR(36) UNIQUE NOT NULL,
    analysis_type VARCHAR(50) NOT NULL,
    currency_pair VARCHAR(10) NOT NULL,
    timeframe VARCHAR(10),
    analysis_data JSONB NOT NULL,
    cache_key VARCHAR(255) UNIQUE NOT NULL,
    expires_at TIMESTAMP WITH TIME ZONE NOT NULL,
    created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
    updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
    version INTEGER DEFAULT 1
);

-- 通知履歴テーブル
CREATE TABLE notification_history (
    id SERIAL PRIMARY KEY,
    uuid VARCHAR(36) UNIQUE NOT NULL,
    pattern_type VARCHAR(50) NOT NULL,
    currency_pair VARCHAR(10) NOT NULL,
    notification_data JSONB NOT NULL,
    sent_at TIMESTAMP WITH TIME ZONE NOT NULL,
    discord_message_id VARCHAR(50),
    status VARCHAR(20) DEFAULT 'sent',
    created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
    updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
    version INTEGER DEFAULT 1
);

-- API呼び出し履歴テーブル
CREATE TABLE api_call_history (
    id SERIAL PRIMARY KEY,
    uuid VARCHAR(36) UNIQUE NOT NULL,
    api_name VARCHAR(50) NOT NULL,
    endpoint VARCHAR(100) NOT NULL,
    currency_pair VARCHAR(10),
    response_time_ms INTEGER,
    status_code INTEGER,
    success BOOLEAN NOT NULL,
    error_message TEXT,
    called_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
    created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
    updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
    version INTEGER DEFAULT 1
);
```

## 🔧 実装コンポーネント設計

### 1. CacheManager

```python
# src/infrastructure/cache/cache_manager.py
class CacheManager:
    """3層キャッシュ管理システム"""

    def __init__(self):
        self.memory_cache = {}  # メモリキャッシュ
        self.file_cache_path = "/app/cache"
        self.db_session = None  # データベースセッション

    async def get_cached_data(self, cache_key: str, max_age_minutes: int = 5):
        """3層キャッシュからデータ取得"""
        pass

    async def set_cached_data(self, cache_key: str, data: Any, expires_in_minutes: int = 5):
        """3層キャッシュにデータ保存"""
        pass

    async def check_data_freshness(self, currency_pair: str, timeframe: str):
        """データの鮮度チェック"""
        pass
```

### 2. DataOptimizer

```python
# src/infrastructure/optimization/data_optimizer.py
class DataOptimizer:
    """データ取得最適化システム"""

    def __init__(self, cache_manager: CacheManager):
        self.cache_manager = cache_manager
        self.yahoo_client = YahooFinanceClient()

    async def get_optimized_currency_data(self, currency_pairs: List[str]):
        """最適化された通貨データ取得"""
        pass

    async def get_optimized_historical_data(self, currency_pair: str, period: str, interval: str):
        """最適化された履歴データ取得"""
        pass

    async def bulk_fetch_with_cache(self, requests: List[Dict]):
        """一括取得とキャッシュ"""
        pass
```

### 3. AnalysisCache

```python
# src/infrastructure/cache/analysis_cache.py
class AnalysisCache:
    """分析結果キャッシュシステム"""

    def __init__(self, db_session):
        self.db_session = db_session

    async def get_cached_analysis(self, analysis_type: str, currency_pair: str, timeframe: str = None):
        """キャッシュされた分析結果取得"""
        pass

    async def cache_analysis_result(self, analysis_type: str, currency_pair: str,
                                  analysis_data: Dict, timeframe: str = None):
        """分析結果をキャッシュ"""
        pass

    async def invalidate_analysis_cache(self, currency_pair: str):
        """分析キャッシュの無効化"""
        pass
```

### 4. NotificationManager（拡張）

```python
# src/infrastructure/messaging/notification_manager.py
class NotificationManager:
    """通知管理システム（重複防止機能付き）"""

    def __init__(self, discord_client: DiscordClient, db_session):
        self.discord_client = discord_client
        self.db_session = db_session

    async def send_pattern_notification(self, pattern_data: Dict):
        """パターン通知送信（重複チェック付き）"""
        pass

    async def check_duplicate_notification(self, pattern_type: str, currency_pair: str,
                                         time_window_minutes: int = 30):
        """重複通知チェック"""
        pass

    async def log_notification(self, notification_data: Dict):
        """通知履歴記録"""
        pass
```

## 📁 ファイル構成設計

### 新規ディレクトリ・ファイル

```
src/
├── infrastructure/
│   ├── cache/
│   │   ├── __init__.py
│   │   ├── cache_manager.py          # 3層キャッシュ管理
│   │   ├── analysis_cache.py         # 分析結果キャッシュ
│   │   └── file_cache.py             # ファイルキャッシュ
│   ├── optimization/
│   │   ├── __init__.py
│   │   ├── data_optimizer.py         # データ取得最適化
│   │   ├── api_rate_limiter.py       # API制限管理
│   │   └── batch_processor.py        # バッチ処理
│   └── database/
│       ├── models/
│       │   ├── analysis_cache_model.py    # 分析キャッシュモデル
│       │   ├── notification_history_model.py  # 通知履歴モデル
│       │   └── api_call_history_model.py  # API呼び出し履歴モデル
│       └── repositories/
│           ├── analysis_cache_repository_impl.py
│           ├── notification_history_repository_impl.py
│           └── api_call_history_repository_impl.py
├── domain/
│   ├── entities/
│   │   ├── analysis_cache.py         # 分析キャッシュエンティティ
│   │   ├── notification_history.py   # 通知履歴エンティティ
│   │   └── api_call_history.py       # API呼び出し履歴エンティティ
│   └── repositories/
│       ├── analysis_cache_repository.py
│       ├── notification_history_repository.py
│       └── api_call_history_repository.py
└── utils/
    ├── cache_utils.py                # キャッシュユーティリティ
    └── optimization_utils.py         # 最適化ユーティリティ
```

### 既存ファイルの修正

```
scripts/cron/
├── integrated_ai_discord.py          # キャッシュ機能統合
├── real_ai_discord_v2.py             # キャッシュ機能統合
└── data_scheduler.py                 # 最適化機能統合

src/infrastructure/
├── external_apis/
│   └── yahoo_finance_client.py       # レート制限強化
├── analysis/
│   ├── technical_indicators.py       # キャッシュ対応
│   └── currency_correlation_analyzer.py  # 最適化対応
└── messaging/
    └── discord_client.py             # 通知履歴対応
```

## 🔄 実装フェーズ

### Phase 1: 基盤キャッシュシステム（1 週間）

1. **CacheManager 実装**

   - メモリキャッシュ
   - ファイルキャッシュ
   - データベースキャッシュ

2. **データベースモデル拡張**

   - AnalysisCacheModel
   - NotificationHistoryModel
   - ApiCallHistoryModel

3. **リポジトリ実装**
   - 各モデルに対応するリポジトリ

### Phase 2: データ最適化（1 週間）

1. **DataOptimizer 実装**

   - 一括データ取得
   - キャッシュ統合
   - 効率的な履歴データ取得

2. **AnalysisCache 実装**

   - 分析結果キャッシュ
   - キャッシュ無効化
   - 有効期限管理

3. **既存クライアント修正**
   - YahooFinanceClient 最適化
   - レート制限強化

### Phase 3: 通知システム最適化（1 週間）

1. **NotificationManager 拡張**

   - 重複防止機能
   - 通知履歴管理
   - パターン検出統合

2. **Cron スクリプト統合**

   - integrated_ai_discord.py 最適化
   - real_ai_discord_v2.py 最適化
   - data_scheduler.py 最適化

3. **テスト・検証**
   - 単体テスト
   - 統合テスト
   - パフォーマンステスト

## 📊 期待効果

### API 呼び出し削減

- **現在**: 171 回/日
- **最適化後**: 約 30 回/日（82%削減）
- **削減要因**:
  - データベースキャッシュ: 60%削減
  - 分析結果キャッシュ: 20%削減
  - 一括取得最適化: 10%削減

### パフォーマンス向上

- **レスポンス時間**: 50%短縮
- **エラー率**: 90%削減
- **システム安定性**: 大幅向上

### データ品質維持

- **データ鮮度**: 5 分以内を保証
- **分析精度**: 既存レベル維持
- **通知タイミング**: 最適化

## 🛠️ 技術的考慮事項

### 依存関係管理

```python
# requirements.txt 追加
redis==5.0.1              # メモリキャッシュ（オプション）
diskcache==5.6.3          # ディスクキャッシュ
sqlalchemy[asyncio]==2.0.23  # データベース（既存）
alembic==1.12.1           # マイグレーション（既存）
```

### 設定管理

```python
# config/cache_settings.py
CACHE_CONFIG = {
    "memory_cache": {
        "max_size": 1000,
        "ttl_seconds": 300
    },
    "file_cache": {
        "path": "/app/cache",
        "max_size_mb": 100,
        "ttl_seconds": 1800
    },
    "database_cache": {
        "ttl_minutes": 60,
        "cleanup_interval_hours": 24
    }
}
```

### エラーハンドリング

- **キャッシュ失敗時のフォールバック**
- **API 制限時の指数バックオフ**
- **データベース接続エラーの処理**
- **部分的なデータ取得失敗の処理**

### 監視・ログ

- **API 呼び出し回数の監視**
- **キャッシュヒット率の測定**
- **レスポンス時間の追跡**
- **エラー率の監視**

## 📝 実装チェックリスト

### Phase 1: 基盤キャッシュシステム

- [ ] CacheManager クラス実装
- [ ] データベースモデル作成
- [ ] マイグレーション実行
- [ ] リポジトリ実装
- [ ] 単体テスト作成

### Phase 2: データ最適化

- [ ] DataOptimizer クラス実装
- [ ] AnalysisCache クラス実装
- [ ] YahooFinanceClient 最適化
- [ ] 既存アナライザー修正
- [ ] 統合テスト作成

### Phase 3: 通知システム最適化

- [ ] NotificationManager 拡張
- [ ] Cron スクリプト統合
- [ ] パフォーマンステスト
- [ ] 本番環境デプロイ
- [ ] 監視設定

## 🔍 リスク管理

### 技術的リスク

- **キャッシュ不整合**: データベースとキャッシュの同期問題
- **メモリ不足**: 大量のキャッシュによるメモリ消費
- **データベース負荷**: キャッシュテーブルによる負荷増加

### 対策

- **定期的なキャッシュクリーンアップ**
- **メモリ使用量監視**
- **データベースインデックス最適化**
- **段階的なロールアウト**

## 📚 参考資料

- [既存設計書](./インフラ・プラグイン設計_20250809.md)
- [データベース設計](./詳細内部設計_20250809.md)
- [通知パターン実装計画](./notification_implementation_plan_2025.yaml)
- [Yahoo Finance API 制限](https://finance.yahoo.com/quote/AAPL/history)
- [SQLAlchemy 非同期サポート](https://docs.sqlalchemy.org/en/20/orm/extensions/asyncio.html)
