# 📊 基本データ取得システム改善設計書

**旧ファイル名**: `basic_data_acquisition_improvement_design_2025.md`  
**作成日**: 2025 年 1 月
**プロジェクト**: Exchange Analytics System
**対象システム**: 基本データ取得・テクニカル指標計算・パターン検出統合システム
**バージョン**: 1.0.0

## 🎯 設計目的

### 問題解決

- **人工データ問題**: データベースに保存されているデータが人工的で実際の市場データではない
- **テクニカル指標計算スキップ**: crontab スクリプトでテクニカル指標計算が実行されていない
- **データフロー不整合**: 初回データ取得と継続データ取得の処理が異なる
- **システム統合不足**: 各コンポーネントが独立して動作し、統合されていない

### システム概要

**目標**: 実際の市場データを取得し、テクニカル指標を計算して、パターン検出を行う統合システムの構築

## 🏗️ 現在のシステムアーキテクチャ

### データフロー図

```
┌─────────────────┐    ┌─────────────────┐    ┌─────────────────┐
│   Crontab       │───►│   USD/JPY Data  │───►│   DataFetcher   │
│   (5分間隔)      │    │   Cron          │    │   Service       │
└─────────────────┘    └─────────────────┘    └─────────────────┘
                              │                        │
                              ▼                        ▼
                       ┌─────────────────┐    ┌─────────────────┐
                       │   Pattern       │    │   Yahoo Finance │
                       │   Detection     │    │   Client        │
                       │   Service       │    │                 │
                       └─────────────────┘    └─────────────────┘
                              │                        │
                              ▼                        ▼
                       ┌─────────────────┐    ┌─────────────────┐
                       │   Notification  │    │   _normalize_   │
                       │   Service       │    │   ticker_data   │
                       └─────────────────┘    └─────────────────┘
                                                       │
                                                       ▼
                                              ┌─────────────────┐
                                              │   Database      │
                                              │   (人工データ)   │
                                              └─────────────────┘
```

### 主要コンポーネント

#### 1. Crontab 設定

- **ファイル**: `current_crontab.txt`
- **実行間隔**: 5 分間隔（平日 24 時間）
- **スクリプト**: `scripts/cron/usdjpy_data_cron.py`

#### 2. メイン cron スクリプト

- **ファイル**: `scripts/cron/usdjpy_data_cron.py`
- **クラス**: `USDJPYDataCron`
- **責任**: データ取得、パターン検出、通知処理

#### 3. データ取得サービス

- **ファイル**: `src/infrastructure/database/services/data_fetcher_service.py`
- **クラス**: `DataFetcherService`
- **責任**: Yahoo Finance からのデータ取得、データ正規化

#### 4. Yahoo Finance クライアント

- **ファイル**: `src/infrastructure/external_apis/yahoo_finance_client.py`
- **クラス**: `YahooFinanceClient`
- **責任**: Yahoo Finance API との通信

#### 5. テクニカル指標サービス

- **ファイル**: `src/infrastructure/database/services/technical_indicator_service.py`
- **クラス**: `TechnicalIndicatorService`
- **責任**: RSI、MACD、ボリンジャーバンドの計算

#### 6. パターン検出サービス

- **ファイル**: `src/infrastructure/database/services/pattern_detection_service.py`
- **クラス**: `PatternDetectionService`
- **責任**: 6 種類のパターン検出

## 🚨 問題点の詳細分析

### 1. 人工データ問題

#### 問題の特定

```python
# src/infrastructure/database/services/data_fetcher_service.py: _normalize_ticker_data
def _normalize_ticker_data(self, ticker_data: Dict) -> Optional[PriceDataModel]:
    if "rate" in ticker_data:
        close_price = ticker_data.get("rate", 0)
        high_price = ticker_data.get("day_high", close_price)  # 問題: 日次Highを5分足に使用
        low_price = ticker_data.get("day_low", close_price)    # 問題: 日次Lowを5分足に使用
        open_price = ticker_data.get("previous_close", close_price)  # 問題: 前日終値を5分足Openに使用
        volume = ticker_data.get("volume", 1000000)  # 問題: 固定Volume
```

#### 根本原因

- **Yahoo Finance API**: `get_current_rate()`は日次データ（day_high, day_low, previous_close）を返す
- **データ正規化**: 日次データを 5 分足データとして保存している
- **Volume**: 固定値（1,000,000）を使用

#### 影響

- パターン検出の信頼性低下
- テクニカル指標計算の不正確性
- システム全体の信頼性問題

### 2. テクニカル指標計算スキップ問題

#### 問題の特定

```python
# scripts/cron/usdjpy_data_cron.py: 164-168行目
# 2. テクニカル指標計算（簡易版）
logger.info("Step 2: Calculating technical indicators...")
# 現在はデータベースに既に計算済みのテクニカル指標があるため、
# パターン検出に必要な最小限の処理のみ実行
logger.info("Technical indicators already calculated in database")
```

#### 根本原因

- **コメントアウト**: テクニカル指標計算がコメントアウトされている
- **誤解**: "既に計算済み"という誤った前提
- **専用スクリプト**: `technical_indicators_calculator.py`が存在するが crontab で呼び出されていない

#### 影響

- テクニカル指標が更新されない
- パターン検出が正常に動作しない
- システムの機能不全

### 3. データフロー不整合問題

#### 初回データ取得 vs 継続データ取得

```python
# 初回データ取得（scripts/cron/unified_initialization.py）
df = await self.yahoo_client.get_historical_data(
    self.currency_pair, period, interval
)
# 実際の履歴データを使用

# 継続データ取得（scripts/cron/usdjpy_data_cron.py）
ticker_data = await self.yahoo_client.get_current_rate(self.currency_pair)
# 日次データを使用して人工データを作成
```

#### 根本原因

- **異なる API**: 初回は`get_historical_data()`、継続は`get_current_rate()`
- **異なるデータ形式**: 初回は実際の OHLCV、継続は人工データ
- **処理の不統一**: 同じシステムで異なる処理方法

### 4. システム統合不足問題

#### 分散したコンポーネント

- **初回データ取得**: `InitialDataLoaderService`
- **継続データ取得**: `DataFetcherService`
- **テクニカル指標計算**: `TechnicalIndicatorService`
- **パターン検出**: `PatternDetectionService`
- **通知処理**: `NotificationIntegrationService`

#### 根本原因

- **独立した実行**: 各コンポーネントが独立して動作
- **統合フロー不足**: 一連の処理フローが確立されていない
- **データ受け渡し**: コンポーネント間のデータ受け渡しが最適化されていない

## 🔧 修正案

### 1. データ取得の修正

#### 即座の修正案

```python
# src/infrastructure/database/services/data_fetcher_service.py
async def fetch_real_5m_data(self) -> Optional[PriceDataModel]:
    """実際の5分足データを取得"""
    try:
        # Yahoo Financeから5分足データを取得
        df = await self.yahoo_client.get_historical_data(
            "USD/JPY", "1d", "5m"  # 1日分の5分足データ
        )

        if df is None or df.empty:
            return None

        # 最新の5分足データを使用
        latest_row = df.iloc[-1]

        # 実際のOHLCVデータでPriceDataModel作成
        price_data = PriceDataModel(
            currency_pair="USD/JPY",
            timestamp=datetime.now(),
            open_price=float(latest_row["Open"]),
            high_price=float(latest_row["High"]),
            low_price=float(latest_row["Low"]),
            close_price=float(latest_row["Close"]),
            volume=int(latest_row["Volume"]) if latest_row["Volume"] > 0 else 1000000,
            data_source="Yahoo Finance 5m Real"
        )

        return price_data

    except Exception as e:
        logger.error(f"5分足データ取得エラー: {e}")
        return None
```

#### crontab スクリプトの修正

```python
# scripts/cron/usdjpy_data_cron.py
async def run_single_execution(self):
    # 1. データ取得（修正版）
    logger.info("Step 1: Fetching current price data...")
    data_fetcher = self.services["data_fetcher"]

    # 実際の5分足データを取得
    price_data = await data_fetcher.fetch_real_5m_data()

    if not price_data:
        raise Exception("No price data fetched")

    logger.info(f"Fetched price data: {price_data}")

    # 2. テクニカル指標計算（実際に計算）
    logger.info("Step 2: Calculating technical indicators...")
    technical_analyzer = self.services["technical_analyzer"]

    # 最新の価格データを取得して指標計算
    latest_data = await self.price_repo.find_latest_data(limit=100)
    if latest_data:
        df = self._convert_to_dataframe(latest_data)

        # RSI計算
        rsi_result = technical_analyzer.calculate_rsi(df, "5m")

        # MACD計算
        macd_result = technical_analyzer.calculate_macd(df, "5m")

        # ボリンジャーバンド計算
        bb_result = technical_analyzer.calculate_bollinger_bands(df, "5m")

        # データベースに保存
        await self._save_technical_indicators(rsi_result, macd_result, bb_result)

        logger.info(f"Calculated and saved technical indicators")
```

### 2. テクニカル指標計算の有効化

#### 専用スクリプトの crontab 追加

```bash
# current_crontab.txt に追加
# 📈 テクニカル指標計算（10分間隔、平日24時間稼働）
*/10 * * * 1-5 cd /app && export $(cat .env | grep -v '^#' | xargs) && timeout 120 python scripts/cron/technical_indicators_calculator.py >> /app/logs/technical_indicators_cron.log 2>&1
```

#### 統合 AI 分析での保存機能追加

```python
# scripts/cron/integrated_ai_discord.py
async def _fetch_technical_indicators(self, currency_pair: str):
    # 既存の計算処理...

    # データベースに保存
    await self._save_indicators_to_database(indicators_data)
```

### 3. データフローの統一

#### 統合データ取得サービス

```python
# src/infrastructure/database/services/unified_data_service.py
class UnifiedDataService:
    """統合データ取得サービス"""

    async def fetch_and_process_data(self, timeframe: str = "5m") -> Dict[str, Any]:
        """データ取得と処理を統合実行"""
        try:
            # 1. 実際のデータを取得
            if timeframe == "5m":
                price_data = await self.fetch_real_5m_data()
            else:
                price_data = await self.fetch_historical_data(timeframe)

            # 2. データベースに保存
            saved_data = await self.save_price_data(price_data)

            # 3. テクニカル指標を計算
            indicators = await self.calculate_technical_indicators(timeframe)

            # 4. パターンを検出
            patterns = await self.detect_patterns(timeframe)

            return {
                "price_data": saved_data,
                "indicators": indicators,
                "patterns": patterns
            }

        except Exception as e:
            logger.error(f"統合データ処理エラー: {e}")
            raise
```

### 4. システム統合の改善

#### 統合 cron スクリプト

```python
# scripts/cron/unified_data_cron.py
class UnifiedDataCron:
    """統合データ取得cronスクリプト"""

    async def run_single_execution(self):
        """統合実行"""
        try:
            # 1. データ取得と処理
            result = await self.unified_data_service.fetch_and_process_data()

            # 2. 通知処理
            if result["patterns"]:
                await self.notification_service.send_notifications(result["patterns"])

            # 3. 監視データ記録
            await self.monitor.record_execution(result)

            return result

        except Exception as e:
            logger.error(f"統合実行エラー: {e}")
            raise
```

## 📋 実装計画

### Phase 1: 即座の修正（1-2 日）

#### 1.1 データ取得の修正

- [ ] `DataFetcherService.fetch_real_5m_data()` メソッドの実装
- [ ] `usdjpy_data_cron.py` の修正
- [ ] テスト実行と動作確認

#### 1.2 テクニカル指標計算の有効化

- [ ] `usdjpy_data_cron.py` でテクニカル指標計算を有効化
- [ ] `technical_indicators_calculator.py` を crontab に追加
- [ ] テスト実行と動作確認

### Phase 2: システム統合（3-5 日）

#### 2.1 統合データサービスの実装

- [ ] `UnifiedDataService` クラスの実装
- [ ] データフローの統一
- [ ] エラーハンドリングの改善

#### 2.2 統合 cron スクリプトの実装

- [ ] `UnifiedDataCron` クラスの実装
- [ ] crontab 設定の更新
- [ ] 監視機能の統合

### Phase 3: 最適化と監視（1-2 日）

#### 3.1 パフォーマンス最適化

- [ ] データベースクエリの最適化
- [ ] メモリ使用量の最適化
- [ ] 処理時間の短縮

#### 3.2 監視とアラート

- [ ] システム健全性監視の実装
- [ ] エラーアラートの設定
- [ ] パフォーマンス監視の追加

## 🔍 関連ファイル一覧

### 主要ファイル

#### Crontab 関連

- `current_crontab.txt` - 現在の crontab 設定
- `scripts/cron/usdjpy_data_cron.py` - メイン cron スクリプト
- `scripts/cron/technical_indicators_calculator.py` - テクニカル指標計算スクリプト
- `scripts/cron/integrated_ai_discord.py` - 統合 AI 分析スクリプト

#### データ取得関連

- `src/infrastructure/database/services/data_fetcher_service.py` - データ取得サービス
- `src/infrastructure/external_apis/yahoo_finance_client.py` - Yahoo Finance クライアント
- `src/infrastructure/database/services/multi_timeframe_data_fetcher_service.py` - マルチタイムフレームデータ取得

#### テクニカル指標関連

- `src/infrastructure/database/services/technical_indicator_service.py` - テクニカル指標サービス
- `src/infrastructure/database/services/multi_timeframe_technical_indicator_service.py` - マルチタイムフレームテクニカル指標
- `src/infrastructure/analysis/technical_indicators.py` - テクニカル指標分析

#### パターン検出関連

- `src/infrastructure/database/services/pattern_detection_service.py` - パターン検出サービス
- `src/infrastructure/database/services/efficient_pattern_detection_service.py` - 効率的パターン検出

#### 初期化関連

- `scripts/cron/unified_initialization.py` - 統合初期化スクリプト
- `src/infrastructure/database/services/initial_data_loader_service.py` - 初回データ取得サービス
- `src/infrastructure/database/services/system_initialization_manager.py` - システム初期化マネージャー

#### 継続処理関連

- `scripts/cron/continuous_processing_cron.py` - 継続処理 cron スクリプト
- `src/infrastructure/database/services/continuous_processing_service.py` - 継続処理サービス
- `src/infrastructure/schedulers/continuous_processing_scheduler.py` - 継続処理スケジューラー

### データベース関連

#### モデル

- `src/infrastructure/database/models/price_data_model.py` - 価格データモデル
- `src/infrastructure/database/models/technical_indicator_model.py` - テクニカル指標モデル
- `src/infrastructure/database/models/pattern_detection_model.py` - パターン検出モデル

#### リポジトリ

- `src/infrastructure/database/repositories/price_data_repository_impl.py` - 価格データリポジトリ
- `src/infrastructure/database/repositories/technical_indicator_repository_impl.py` - テクニカル指標リポジトリ
- `src/infrastructure/database/repositories/pattern_detection_repository_impl.py` - パターン検出リポジトリ

### 設定・ログ関連

#### 設定

- `.env` - 環境変数設定
- `src/utils/logging_config.py` - ログ設定

#### ログ

- `/app/logs/data_cron.log` - データ取得ログ
- `/app/logs/technical_indicators_cron.log` - テクニカル指標計算ログ
- `/app/logs/integrated_ai_cron.log` - 統合 AI 分析ログ

## 📊 期待される効果

### 1. データ品質の向上

- **実際の市場データ**: 人工データから実際の市場データへの移行
- **正確なテクニカル指標**: 実際のデータに基づく正確な指標計算
- **信頼性の向上**: システム全体の信頼性向上

### 2. システム機能の完全化

- **テクニカル指標計算**: 継続的な指標計算の実現
- **パターン検出**: 正確なデータに基づくパターン検出
- **通知機能**: 重要なパターンの適切な通知

### 3. 運用効率の向上

- **統合フロー**: 一連の処理フローの確立
- **エラーハンドリング**: 包括的なエラーハンドリング
- **監視機能**: システム健全性の監視

### 4. 保守性の向上

- **コード統合**: 分散したコンポーネントの統合
- **データフロー明確化**: 処理フローの明確化
- **テスト容易性**: 統合されたシステムのテスト容易性

## 🎯 次のステップ

### 即座に実行すべき項目

1. **データ取得の修正**: `fetch_real_5m_data()` メソッドの実装
2. **crontab スクリプトの修正**: テクニカル指標計算の有効化
3. **テスト実行**: 修正後の動作確認

### 中期的な改善項目

1. **システム統合**: 統合データサービスの実装
2. **監視機能**: システム健全性監視の実装
3. **最適化**: パフォーマンス最適化

### 長期的な改善項目

1. **拡張性**: 他の通貨ペアへの対応
2. **高度な分析**: 機械学習による分析機能の追加
3. **リアルタイム処理**: より高速なリアルタイム処理の実現

---

**作成者**: AI Assistant
**最終更新**: 2025 年 1 月
**ステータス**: 設計完了、実装準備中
