# モジュール設計思想とフォルダ構成

**作成日**: 2025 年 8 月 9 日
**対象**: 為替分析アプリ開発
**設計思想**: モジュール型・アップデート容易性重視

## 1. 設計思想・原則

### 1.1 SOLID 原則の適用

#### **S - Single Responsibility Principle（単一責任原則）**

- 各モジュール・クラスは単一の責任を持つ
- データ取得、分析、通知など機能ごとに分離

#### **O - Open/Closed Principle（開放閉鎖原則）**

- 拡張に対して開かれている（プラグインシステム）
- 修正に対して閉じている（既存コードを変更せずに拡張）

#### **L - Liskov Substitution Principle（リスコフの置換原則）**

- プラグインの基底クラスによる統一インターフェース
- 派生クラスは基底クラスと置換可能

#### **I - Interface Segregation Principle（インターフェース分離原則）**

- 小さく特化したインターフェースを定義
- 使わない機能への依存を避ける

#### **D - Dependency Inversion Principle（依存関係逆転原則）**

- 抽象に依存し、具象に依存しない
- DI コンテナによる依存性注入

### 1.2 レイヤードアーキテクチャ

```
┌─────────────────────────────────────────────────────────┐
│                    Presentation Layer                   │  # API・UI層
├─────────────────────────────────────────────────────────┤
│                    Application Layer                    │  # アプリケーション層
├─────────────────────────────────────────────────────────┤
│                      Domain Layer                       │  # ドメイン層
├─────────────────────────────────────────────────────────┤
│                   Infrastructure Layer                  │  # インフラ層
└─────────────────────────────────────────────────────────┘
```

### 1.3 プラグインアーキテクチャ

```
Core System (不変)
├── Plugin Interface (契約)
├── Plugin Manager (管理)
└── Plugins (可変・拡張可能)
    ├── Technical Indicators
    ├── Analysis Algorithms
    └── Report Templates
```

## 2. 推奨フォルダ構成

### 2.1 ルートレベル構成

```
exchangeApp/
├── src/                           # ソースコード（本体）
├── plugins/                       # プラグインシステム
├── config/                        # 設定ファイル群
├── database/                      # データベース関連
├── tests/                         # テスト群
├── docs/                          # ドキュメント
├── scripts/                       # 運用スクリプト
├── deployment/                    # デプロイ設定
├── monitoring/                    # 監視・ログ設定
└── tools/                         # 開発ツール
```

### 2.2 詳細フォルダ構成

```
exchangeApp/
├── src/                           # === ソースコード本体 ===
│   ├── main.py                    # アプリケーションエントリーポイント
│   ├── core/                      # === コアシステム ===
│   │   ├── __init__.py
│   │   ├── application.py         # アプリケーション初期化
│   │   ├── container.py           # DIコンテナ
│   │   ├── events.py              # イベントシステム
│   │   └── exceptions.py          # カスタム例外
│   ├── domain/                    # === ドメイン層 ===
│   │   ├── __init__.py
│   │   ├── entities/              # エンティティ
│   │   │   ├── __init__.py
│   │   │   ├── exchange_rate.py
│   │   │   ├── technical_indicator.py
│   │   │   ├── analysis_report.py
│   │   │   └── alert.py
│   │   ├── value_objects/         # 値オブジェクト
│   │   │   ├── __init__.py
│   │   │   ├── currency_pair.py
│   │   │   ├── time_frame.py
│   │   │   └── price.py
│   │   ├── repositories/          # リポジトリインターフェース
│   │   │   ├── __init__.py
│   │   │   ├── base.py
│   │   │   ├── exchange_rate_repository.py
│   │   │   └── analysis_repository.py
│   │   └── services/              # ドメインサービス
│   │       ├── __init__.py
│   │       ├── analysis_service.py
│   │       └── signal_service.py
│   ├── application/               # === アプリケーション層 ===
│   │   ├── __init__.py
│   │   ├── commands/              # コマンド（書き込み）
│   │   │   ├── __init__.py
│   │   │   ├── base.py
│   │   │   ├── generate_report_command.py
│   │   │   └── create_alert_command.py
│   │   ├── queries/               # クエリ（読み込み）
│   │   │   ├── __init__.py
│   │   │   ├── base.py
│   │   │   ├── get_rates_query.py
│   │   │   └── get_analysis_query.py
│   │   ├── handlers/              # ハンドラー
│   │   │   ├── __init__.py
│   │   │   ├── command_handlers.py
│   │   │   └── query_handlers.py
│   │   └── interfaces/            # アプリケーションインターフェース
│   │       ├── __init__.py
│   │       ├── data_fetcher_interface.py
│   │       ├── ai_analyzer_interface.py
│   │       └── notifier_interface.py
│   ├── infrastructure/            # === インフラ層 ===
│   │   ├── __init__.py
│   │   ├── database/              # データベース実装
│   │   │   ├── __init__.py
│   │   │   ├── models.py          # SQLAlchemyモデル
│   │   │   ├── repositories/      # リポジトリ実装
│   │   │   │   ├── __init__.py
│   │   │   │   ├── base_repository.py
│   │   │   │   ├── exchange_rate_repository_impl.py
│   │   │   │   └── analysis_repository_impl.py
│   │   │   └── migrations/        # マイグレーション
│   │   ├── external_apis/         # 外部API実装
│   │   │   ├── __init__.py
│   │   │   ├── base_api_client.py
│   │   │   ├── alpha_vantage_client.py
│   │   │   ├── openai_client.py
│   │   │   └── github_client.py
│   │   ├── messaging/             # メッセージング・通知
│   │   │   ├── __init__.py
│   │   │   ├── discord_notifier.py
│   │   │   ├── email_notifier.py
│   │   │   └── webhook_handler.py
│   │   ├── cache/                 # キャッシュ実装
│   │   │   ├── __init__.py
│   │   │   ├── redis_cache.py
│   │   │   └── memory_cache.py
│   │   └── monitoring/            # モニタリング
│   │       ├── __init__.py
│   │       ├── logger.py
│   │       └── metrics.py
│   ├── presentation/              # === プレゼンテーション層 ===
│   │   ├── __init__.py
│   │   ├── api/                   # REST API
│   │   │   ├── __init__.py
│   │   │   ├── app.py             # Flask アプリ
│   │   │   ├── middleware/        # ミドルウェア
│   │   │   │   ├── __init__.py
│   │   │   │   ├── auth.py
│   │   │   │   ├── rate_limit.py
│   │   │   │   └── error_handler.py
│   │   │   ├── routes/            # ルート定義
│   │   │   │   ├── __init__.py
│   │   │   │   ├── health.py
│   │   │   │   ├── rates.py
│   │   │   │   ├── analysis.py
│   │   │   │   ├── alerts.py
│   │   │   │   ├── ai_reports.py
│   │   │   │   ├── plugins.py
│   │   │   │   └── github.py
│   │   │   └── schemas/           # リクエスト・レスポンススキーマ
│   │   │       ├── __init__.py
│   │   │       ├── base.py
│   │   │       ├── rates_schema.py
│   │   │       └── analysis_schema.py
│   │   ├── web/                   # Webフロントエンド
│   │   │   ├── __init__.py
│   │   │   ├── static/
│   │   │   │   ├── css/
│   │   │   │   ├── js/
│   │   │   │   └── img/
│   │   │   ├── templates/
│   │   │   └── controllers/
│   │   └── cli/                   # CLI インターフェース
│   │       ├── __init__.py
│   │       ├── commands.py
│   │       └── db_commands.py
│   └── shared/                    # === 共通モジュール ===
│       ├── __init__.py
│       ├── utils/                 # ユーティリティ
│       │   ├── __init__.py
│       │   ├── date_utils.py
│       │   ├── validation.py
│       │   ├── formatters.py
│       │   └── decorators.py
│       ├── constants/             # 定数
│       │   ├── __init__.py
│       │   ├── currency_pairs.py
│       │   ├── time_frames.py
│       │   └── api_limits.py
│       └── types/                 # 型定義
│           ├── __init__.py
│           ├── common_types.py
│           └── api_types.py
├── plugins/                       # === プラグインシステム ===
│   ├── __init__.py
│   ├── registry.py                # プラグイン登録管理
│   ├── loader.py                  # プラグインローダー
│   ├── interfaces/                # プラグインインターフェース
│   │   ├── __init__.py
│   │   ├── base_plugin.py
│   │   ├── technical_indicator_plugin.py
│   │   ├── analysis_plugin.py
│   │   └── report_plugin.py
│   ├── core/                      # コアプラグイン（標準実装）
│   │   ├── technical/             # テクニカル指標プラグイン
│   │   │   ├── __init__.py
│   │   │   ├── sma_plugin.py
│   │   │   ├── ema_plugin.py
│   │   │   ├── rsi_plugin.py
│   │   │   ├── macd_plugin.py
│   │   │   └── bollinger_bands_plugin.py
│   │   ├── analysis/              # 分析アルゴリズムプラグイン
│   │   │   ├── __init__.py
│   │   │   ├── trend_analysis_plugin.py
│   │   │   ├── signal_generator_plugin.py
│   │   │   └── ai_analysis_plugin.py
│   │   └── reports/               # レポートプラグイン
│   │       ├── __init__.py
│   │       ├── daily_report_plugin.py
│   │       └── event_report_plugin.py
│   ├── custom/                    # カスタムプラグイン
│   │   ├── technical/
│   │   ├── analysis/
│   │   └── reports/
│   └── marketplace/               # 外部プラグイン（将来）
├── config/                        # === 設定ファイル群 ===
│   ├── __init__.py
│   ├── base.py                    # 基本設定
│   ├── development.py             # 開発環境設定
│   ├── production.py              # 本番環境設定
│   ├── testing.py                 # テスト環境設定
│   ├── logging.yaml               # ログ設定
│   ├── plugins.yaml               # プラグイン設定
│   └── monitoring.yaml            # 監視設定
├── database/                      # === データベース関連 ===
│   ├── migrations/                # マイグレーション
│   │   ├── versions/
│   │   └── alembic.ini
│   ├── seeds/                     # 初期データ
│   │   ├── currency_pairs.sql
│   │   └── default_plugins.sql
│   └── backups/                   # バックアップ
├── tests/                         # === テスト群 ===
│   ├── __init__.py
│   ├── unit/                      # ユニットテスト
│   │   ├── domain/
│   │   ├── application/
│   │   ├── infrastructure/
│   │   └── plugins/
│   ├── integration/               # 統合テスト
│   │   ├── api/
│   │   ├── database/
│   │   └── external_apis/
│   ├── e2e/                       # E2Eテスト
│   ├── fixtures/                  # テストデータ
│   └── conftest.py                # pytest設定
├── docs/                          # === ドキュメント ===
│   ├── architecture/              # アーキテクチャドキュメント
│   ├── api/                       # API仕様書
│   ├── plugins/                   # プラグイン開発ガイド
│   ├── deployment/                # デプロイガイド
│   └── user_guides/               # ユーザーガイド
├── scripts/                       # === 運用スクリプト ===
│   ├── setup/                     # セットアップスクリプト
│   ├── migration/                 # マイグレーションスクリプト
│   ├── backup/                    # バックアップスクリプト
│   └── monitoring/                # 監視スクリプト
├── deployment/                    # === デプロイ設定 ===
│   ├── docker/
│   │   ├── Dockerfile.dev
│   │   ├── Dockerfile.prod
│   │   └── docker-compose.yml
│   ├── kubernetes/
│   ├── terraform/
│   └── ansible/
├── monitoring/                    # === 監視・ログ設定 ===
│   ├── grafana/
│   ├── prometheus/
│   └── logs/
└── tools/                         # === 開発ツール ===
    ├── code_generators/           # コード生成ツール
    ├── validators/                # バリデーションツール
    └── profilers/                 # パフォーマンス測定ツール
```

## 3. モジュール間の依存関係

### 3.1 依存関係の方向

```
Presentation → Application → Domain ← Infrastructure
     ↓              ↓           ↑           ↑
  Plugins ←  Shared/Utils  →  Config  →  Database
```

### 3.2 依存関係のルール

1. **内側の層は外側の層に依存しない**
2. **Infrastructure は抽象（Interface）に依存**
3. **Plugins は独立性を保つ**
4. **Shared は他の層から使用されるが、他に依存しない**

## 4. ファイル命名規則

### 4.1 Python ファイル

```python
# ファイル名: snake_case
user_service.py
exchange_rate_repository.py

# クラス名: PascalCase
class UserService:
class ExchangeRateRepository:

# 関数・変数名: snake_case
def get_latest_rate():
current_price = 150.25

# 定数: UPPER_SNAKE_CASE
MAX_RETRY_COUNT = 3
DEFAULT_CURRENCY_PAIR = "USD/JPY"
```

### 4.2 設定ファイル

```yaml
# 環境別設定: 環境名.拡張子
development.py
production.py
testing.py

# 機能別設定: 機能名.拡張子
logging.yaml
plugins.yaml
database.yaml
```

### 4.3 プラグインファイル

```python
# プラグインディレクトリ: snake_case
sma_plugin/
custom_analysis/

# プラグインメインファイル: 統一命名
plugin.py          # メイン実装
config.json        # 設定定義
metadata.yaml      # メタデータ
requirements.txt   # 依存関係
```

## 5. モジュール設計のベストプラクティス

### 5.1 疎結合の実現

#### インターフェース設計

```python
# 抽象インターフェース
from abc import ABC, abstractmethod

class DataFetcherInterface(ABC):
    @abstractmethod
    async def fetch_rates(self, currency_pair: str) -> Dict:
        pass

# 具象実装
class AlphaVantageDataFetcher(DataFetcherInterface):
    async def fetch_rates(self, currency_pair: str) -> Dict:
        # Alpha Vantage API実装
        pass
```

#### 依存性注入

```python
# DIコンテナ
class Container:
    def __init__(self):
        self._services = {}
        self._singletons = {}

    def register(self, interface, implementation, singleton=True):
        self._services[interface] = (implementation, singleton)

    def resolve(self, interface):
        if interface in self._singletons:
            return self._singletons[interface]

        implementation, is_singleton = self._services[interface]
        instance = implementation()

        if is_singleton:
            self._singletons[interface] = instance

        return instance
```

### 5.2 設定駆動開発

#### 外部化された設定

```python
# config/base.py
class BaseConfig:
    # 環境変数から取得
    SECRET_KEY = os.getenv('SECRET_KEY')
    DATABASE_URL = os.getenv('DATABASE_URL')

    # デフォルト値を持つ設定
    MAX_RETRY_COUNT = int(os.getenv('MAX_RETRY_COUNT', '3'))
    REQUEST_TIMEOUT = int(os.getenv('REQUEST_TIMEOUT', '30'))

# config/plugins.yaml
plugins:
  technical_indicators:
    - name: "sma_plugin"
      enabled: true
      config:
        periods: [5, 20, 50, 200]
    - name: "rsi_plugin"
      enabled: true
      config:
        period: 14
        overbought: 70
        oversold: 30
```

### 5.3 イベント駆動アーキテクチャ

#### イベントシステム

```python
# core/events.py
class Event:
    def __init__(self, event_type: str, data: Dict):
        self.event_type = event_type
        self.data = data
        self.timestamp = datetime.now()

class EventBus:
    def __init__(self):
        self._handlers = defaultdict(list)

    def subscribe(self, event_type: str, handler):
        self._handlers[event_type].append(handler)

    def publish(self, event: Event):
        for handler in self._handlers[event.event_type]:
            handler(event)

# 使用例
event_bus.publish(Event("rate_updated", {"pair": "USD/JPY", "rate": 150.25}))
```

## 6. アップデート戦略

### 6.1 ローリングアップデート対応

#### バージョン管理

```python
# shared/version.py
class Version:
    def __init__(self, major: int, minor: int, patch: int):
        self.major = major
        self.minor = minor
        self.patch = patch

    def is_compatible(self, other: 'Version') -> bool:
        # セマンティックバージョニング
        return self.major == other.major

# プラグインの互換性チェック
plugin_version = Version(1, 2, 0)
core_version = Version(1, 3, 0)
is_compatible = plugin_version.is_compatible(core_version)
```

#### ホットリロード対応

```python
# plugins/loader.py
class PluginLoader:
    def reload_plugin(self, plugin_name: str):
        # 既存プラグインのアンロード
        self.unload_plugin(plugin_name)

        # 新しいプラグインのロード
        self.load_plugin(plugin_name)

        # 依存関係の再構築
        self.rebuild_dependencies()
```

### 6.2 後方互換性の維持

#### API バージョニング

```python
# presentation/api/routes/rates.py
@api.route('/v1/rates/<currency_pair>')
def get_rates_v1(currency_pair):
    # バージョン1の実装
    pass

@api.route('/v2/rates/<currency_pair>')
def get_rates_v2(currency_pair):
    # バージョン2の実装（新機能追加）
    pass
```

#### データベースマイグレーション

```python
# database/migrations/
"""add_confidence_score_to_reports

Revision ID: 001
Revises:
Create Date: 2025-08-09

"""

def upgrade():
    op.add_column('ai_market_reports',
                  sa.Column('confidence_score', sa.DECIMAL(3,2)))

def downgrade():
    op.drop_column('ai_market_reports', 'confidence_score')
```

## 7. 開発ワークフロー

### 7.1 機能追加の流れ

1. **設計フェーズ**

   ```
   docs/architecture/ に設計書作成
   ↓
   tests/ にテストケース作成
   ↓
   src/domain/ にドメインモデル定義
   ```

2. **実装フェーズ**

   ```
   src/infrastructure/ に実装
   ↓
   src/application/ にユースケース実装
   ↓
   src/presentation/ にAPI実装
   ```

3. **プラグイン対応**
   ```
   plugins/interfaces/ にインターフェース定義
   ↓
   plugins/core/ に標準実装
   ↓
   config/plugins.yaml に設定追加
   ```

### 7.2 品質保証

#### 自動テスト

```bash
# ユニットテスト
pytest tests/unit/ -v

# 統合テスト
pytest tests/integration/ -v

# プラグインテスト
pytest tests/plugins/ -v

# カバレッジ測定
pytest --cov=src/ --cov-report=html
```

#### 静的解析

```bash
# 型チェック
mypy src/

# コード品質
flake8 src/
black src/
isort src/

# セキュリティチェック
bandit -r src/
```

この設計思想により、為替分析アプリは高いモジュール性とアップデート容易性を実現できます。
