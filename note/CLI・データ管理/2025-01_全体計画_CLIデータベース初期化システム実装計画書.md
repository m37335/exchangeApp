# CLI データベース初期化システム実装計画書

**旧ファイル名**: `CLIデータベース初期化システム実装計画書_2025.md`  

## 📋 概要

### 目的

- 実装仕様書に基づく具体的な実装計画の策定
- 基盤データを基準とした差分更新システムの段階的開発
- タスク管理とマイルストーンの定義
- 品質保証とテスト計画の策定

### 基本方針

- **段階的実装**: Phase 1 から 5 まで順次実装
- **基盤データ活用**: Phase 2 で取得したデータを基準として活用
- **差分更新**: 基盤データ以降の差分データのみを取得
- **品質重視**: 各 Phase 完了時にテストとレビュー
- **既存システム活用**: テクニカル指標は既存システムを活用
- **保守性確保**: コード品質とドキュメント整備

## 🗓️ 実装スケジュール

### 全体スケジュール

```
Phase 1: 基盤整備 (1-2日) - 完了
├── データベースクリーンアップ実装
├── CLIコマンド基本構造更新
└── 基盤テスト

Phase 2: データ処理 (2-3日) - 完了
├── データ取得処理実装
├── 基盤データの確立
└── データ処理テスト

Phase 3: 差分更新処理 (2-3日)
├── 基盤データ復元実装
├── 差分データ更新実装
└── 差分更新テスト

Phase 4: 分析処理 (1-2日)
├── 既存テクニカル指標システム統合
├── 一括実行スクリプト実装
└── 統合テスト

Phase 5: 統合・テスト (1-2日)
├── 全処理統合テスト
├── エラーハンドリング強化
└── ドキュメント更新
```

## 📋 Phase 1: 基盤整備（完了）

### 期間: 1-2 日

#### タスク 1.1: データベースクリーンアップ実装

**担当**: 開発者
**期間**: 0.5 日
**優先度**: 高
**ステータス**: 完了

**詳細タスク**:

- [x] `scripts/cron/database_cleanup.py`の作成
- [x] `DatabaseCleanup`クラスの実装
  - [x] `cleanup_database()`メソッド
  - [x] `create_tables()`メソッド
  - [x] `verify_cleanup()`メソッド
  - [x] `initialize_session()`メソッド
- [x] エラーハンドリングの実装
- [x] ログ出力の実装

**成果物**:

- `scripts/cron/database_cleanup.py`
- 単体テストファイル

**受け入れ基準**:

- [x] データベースファイルの完全削除
- [x] テーブル構造の正しい作成
- [x] エラー時の適切な処理

#### タスク 1.2: CLI コマンド基本構造更新

**担当**: 開発者
**期間**: 0.5 日
**優先度**: 高
**ステータス**: 完了

**詳細タスク**:

- [x] `src/presentation/cli/commands/data_commands.py`の更新
- [x] `init`コマンドの簡素化（クリーンアップのみ）
- [x] 新しいコマンド構造の実装
  - [x] `restore`コマンドの準備
  - [x] `update`コマンドの準備
  - [x] `calculate`コマンドの準備
  - [x] `setup`コマンドの準備
- [x] ヘルプメッセージの更新

**成果物**:

- 更新された`data_commands.py`
- CLI ヘルプの更新

**受け入れ基準**:

- [x] `exchange-analytics data init`が正常に動作
- [x] 各コマンドのヘルプが表示される
- [x] エラー時の適切なメッセージ表示

#### タスク 1.3: 基盤テスト

**担当**: 開発者
**期間**: 0.5 日
**優先度**: 中
**ステータス**: 完了

**詳細タスク**:

- [x] データベースクリーンアップの単体テスト
- [x] CLI コマンドの動作テスト
- [x] エラーケースのテスト
- [x] パフォーマンステスト

**成果物**:

- テスト結果レポート
- バグ修正（必要に応じて）

**受け入れ基準**:

- [x] 全テストケースが成功
- [x] パフォーマンス要件を満たす
- [x] エラーケースが適切に処理される

### Phase 1 完了基準

- [x] データベースクリーンアップが正常に動作
- [x] CLI コマンドが正常に動作
- [x] 全テストが成功
- [x] コードレビュー完了

## 📋 Phase 2: データ処理（完了）

### 期間: 2-3 日

#### タスク 2.1: データ取得処理実装

**担当**: 開発者
**期間**: 1 日
**優先度**: 高
**ステータス**: 完了

**詳細タスク**:

- [x] `scripts/cron/data_loader.py`の作成
- [x] `DataLoader`クラスの実装
  - [x] `load_multi_timeframe_data()`メソッド
  - [x] `load_timeframe_data()`メソッド
  - [x] `verify_data_quality()`メソッド
  - [x] `_fetch_and_save_timeframe()`メソッド
- [x] 個別取得設定の実装
  - [x] 5 分足: 60 日分
  - [x] 1 時間足: 60 日分
  - [x] 4 時間足: 365 日分
  - [x] 日足: 365 日分
- [x] データ品質検証の実装
- [x] エラーハンドリングの実装

**成果物**:

- `scripts/cron/data_loader.py`
- 単体テストファイル

**受け入れ基準**:

- [x] 各時間足の個別取得が正常に動作
- [x] データ品質の検証が機能する
- [x] エラー時の適切な処理

#### タスク 2.2: 基盤データの確立

**担当**: 開発者
**期間**: 1 日
**優先度**: 高
**ステータス**: 完了

**詳細タスク**:

- [x] 全時間足データの取得完了
- [x] データ品質の確認
- [x] 基盤データのバックアップ作成
- [x] 基盤データ仕様書の作成

**成果物**:

- `data/exchange_analytics_phase2_complete_2025-08-14.db`
- `data/README_phase2_complete_2025-08-14.md`

**受け入れ基準**:

- [x] 全時間足のデータが正常に取得されている
- [x] データ品質が基準を満たしている
- [x] バックアップが正常に作成されている

#### タスク 2.3: データ処理テスト

**担当**: 開発者
**期間**: 0.5 日
**優先度**: 中
**ステータス**: 完了

**詳細タスク**:

- [x] データ取得処理の単体テスト
- [x] 統合テスト
- [x] パフォーマンステスト
- [x] データ品質テスト

**成果物**:

- テスト結果レポート
- バグ修正（必要に応じて）

**受け入れ基準**:

- [x] 全テストケースが成功
- [x] データ品質が基準を満たす
- [x] パフォーマンス要件を満たす

### Phase 2 完了基準

- [x] データ取得処理が正常に動作
- [x] 基盤データが確立されている
- [x] 全テストが成功
- [x] データ品質が基準を満たす
- [x] コードレビュー完了

## 📋 Phase 3: 差分更新処理

### 期間: 2-3 日

#### タスク 3.1: 基盤データ復元実装

**担当**: 開発者
**期間**: 1 日
**優先度**: 高

**詳細タスク**:

- [ ] `scripts/cron/base_data_restorer.py`の作成
- [ ] `BaseDataRestorer`クラスの実装
  - [ ] `restore_base_data()`メソッド
  - [ ] `_backup_current_database()`メソッド
  - [ ] `_restore_from_backup()`メソッド
  - [ ] `_verify_restoration()`メソッド
  - [ ] `_get_data_counts()`メソッド
- [ ] 基盤データパスの設定
- [ ] エラーハンドリングの実装
- [ ] 復元確認機能の実装

**成果物**:

- `scripts/cron/base_data_restorer.py`
- 単体テストファイル

**受け入れ基準**:

- [ ] 基盤データの正常な復元
- [ ] 復元結果の正確な確認
- [ ] エラー時の適切な処理

#### タスク 3.2: 差分データ更新実装

**担当**: 開発者
**期間**: 1 日
**優先度**: 高

**詳細タスク**:

- [ ] `scripts/cron/differential_updater.py`の作成
- [ ] `DifferentialUpdater`クラスの実装
  - [ ] `update_all_timeframes()`メソッド
  - [ ] `update_timeframe()`メソッド
  - [ ] `_calculate_differential_period()`メソッド
  - [ ] `_get_latest_timestamp()`メソッド
  - [ ] `_fetch_differential_data()`メソッド
  - [ ] `_save_dataframe_to_db()`メソッド
- [ ] 差分期間計算ロジックの実装
- [ ] データ取得と保存の実装
- [ ] 重複チェック機能の実装

**成果物**:

- `scripts/cron/differential_updater.py`
- 単体テストファイル

**受け入れ基準**:

- [ ] 差分期間の正確な計算
- [ ] 差分データの正常な取得
- [ ] 重複データの適切な処理

#### タスク 3.3: 差分更新テスト

**担当**: 開発者
**期間**: 0.5 日
**優先度**: 中

**詳細タスク**:

- [ ] 基盤データ復元の単体テスト
- [ ] 差分データ更新の単体テスト
- [ ] 統合テスト
- [ ] 差分データの正確性テスト
- [ ] パフォーマンステスト

**成果物**:

- テスト結果レポート
- バグ修正（必要に応じて）

**受け入れ基準**:

- [ ] 全テストケースが成功
- [ ] 差分データの正確性が確認される
- [ ] パフォーマンス要件を満たす

### Phase 3 完了基準

- [ ] 基盤データ復元が正常に動作
- [ ] 差分データ更新が正常に動作
- [ ] 全テストが成功
- [ ] 差分データの正確性が確認される
- [ ] コードレビュー完了

## 📋 Phase 4: 分析処理

### 期間: 1-2 日

#### タスク 4.1: 既存テクニカル指標システム統合

**担当**: 開発者
**期間**: 0.5 日
**優先度**: 高

**詳細タスク**:

- [ ] 既存システムの動作確認
  - [ ] `scripts/cron/technical_indicators_calculator.py`
  - [ ] `src/infrastructure/analysis/technical_indicators.py`
  - [ ] `src/infrastructure/database/services/multi_timeframe_technical_indicator_service.py`
- [ ] 統合用ラッパークラスの作成
- [ ] CLI コマンドとの連携実装
- [ ] エラーハンドリングの調整

**成果物**:

- 統合用ラッパークラス
- 更新された CLI コマンド

**受け入れ基準**:

- [ ] 既存システムが正常に動作
- [ ] CLI コマンドから実行可能
- [ ] エラー時に適切な処理が実行される

#### タスク 4.2: 一括実行スクリプト実装

**担当**: 開発者
**期間**: 1 日
**優先度**: 高

**詳細タスク**:

- [ ] `scripts/cron/unified_setup.py`の更新
- [ ] `UnifiedSetup`クラスの更新
  - [ ] `run_full_setup()`メソッドの更新
  - [ ] `_execute_step()`メソッドの更新
  - [ ] `_generate_report()`メソッドの更新
- [ ] 新しいワークフローへの対応
- [ ] エラーハンドリングと復旧機能
- [ ] 進捗表示の実装

**成果物**:

- 更新された`scripts/cron/unified_setup.py`
- 統合テストファイル

**受け入れ基準**:

- [ ] 新しいワークフローでの一括実行が正常に動作
- [ ] 段階的実行が正常に動作
- [ ] エラー時の適切な処理と復旧

#### タスク 4.3: 統合テスト

**担当**: 開発者
**期間**: 0.5 日
**優先度**: 中

**詳細タスク**:

- [ ] 全コンポーネントの統合テスト
- [ ] エンドツーエンドテスト
- [ ] パフォーマンステスト
- [ ] エラーケースのテスト

**成果物**:

- 統合テスト結果レポート
- バグ修正（必要に応じて）

**受け入れ基準**:

- [ ] 全統合テストが成功
- [ ] エンドツーエンドテストが成功
- [ ] パフォーマンス要件を満たす

### Phase 4 完了基準

- [ ] 既存テクニカル指標システムが統合されている
- [ ] 一括実行スクリプトが正常に動作
- [ ] 全統合テストが成功
- [ ] コードレビュー完了

## 📋 Phase 5: 統合・テスト

### 期間: 1-2 日

#### タスク 5.1: 全処理統合テスト

**担当**: 開発者
**期間**: 1 日
**優先度**: 高

**詳細タスク**:

- [ ] 全システムの統合テスト
- [ ] 各 CLI コマンドの動作確認
- [ ] データフローの検証
- [ ] エラーケースの包括的テスト
- [ ] パフォーマンステスト

**成果物**:

- 統合テスト結果レポート
- バグ修正（必要に応じて）

**受け入れ基準**:

- [ ] 全システムが正常に動作
- [ ] 全 CLI コマンドが正常に動作
- [ ] パフォーマンス要件を満たす

#### タスク 5.2: エラーハンドリング強化

**担当**: 開発者
**期間**: 0.5 日
**優先度**: 中

**詳細タスク**:

- [ ] エラーメッセージの改善
- [ ] ログ出力の最適化
- [ ] 復旧機能の強化
- [ ] ユーザーフレンドリーなエラー表示

**成果物**:

- 改善されたエラーハンドリング
- ログ設定の最適化

**受け入れ基準**:

- [ ] エラーが適切に処理される
- [ ] ユーザーが理解しやすいエラーメッセージ
- [ ] 適切なログ出力

#### タスク 5.3: ドキュメント更新

**担当**: 開発者
**期間**: 0.5 日
**優先度**: 中

**詳細タスク**:

- [ ] README ファイルの更新
- [ ] CLI コマンドの使用方法ドキュメント
- [ ] トラブルシューティングガイド
- [ ] API 仕様書の更新（必要に応じて）

**成果物**:

- 更新されたドキュメント
- 使用方法ガイド

**受け入れ基準**:

- [ ] ドキュメントが最新の状態
- [ ] 使用方法が明確に記載されている
- [ ] トラブルシューティング情報が充実

### Phase 5 完了基準

- [ ] 全システムが正常に動作
- [ ] エラーハンドリングが適切に機能
- [ ] ドキュメントが最新の状態
- [ ] 最終コードレビュー完了

## 🎯 マイルストーン

### マイルストーン 1: 基盤完成（完了）

**目標日**: Phase 1 完了時
**成果物**:

- データベースクリーンアップ機能
- 基本 CLI コマンド構造

### マイルストーン 2: データ処理完成（完了）

**目標日**: Phase 2 完了時
**成果物**:

- データ取得機能
- 基盤データの確立

### マイルストーン 3: 差分更新完成

**目標日**: Phase 3 完了時
**成果物**:

- 基盤データ復元機能
- 差分データ更新機能

### マイルストーン 4: 分析機能完成

**目標日**: Phase 4 完了時
**成果物**:

- テクニカル指標計算機能
- 一括実行機能

### マイルストーン 5: システム完成

**目標日**: Phase 5 完了時
**成果物**:

- 完全な CLI データベース初期化システム
- 包括的なドキュメント

## 📊 品質保証計画

### テスト戦略

1. **単体テスト**: 各コンポーネントの個別テスト
2. **統合テスト**: コンポーネント間の連携テスト
3. **エンドツーエンドテスト**: 全システムの動作テスト
4. **パフォーマンステスト**: 処理時間とリソース使用量のテスト
5. **差分更新テスト**: 差分データの正確性テスト

### コーディングルール

#### コード品質基準

**1. 行長制限**

- **最大行長**: 88 文字（Black フォーマッタのデフォルト）
- **推奨行長**: 80 文字以下
- **例外**: 長い URL、ファイルパス、コメントは可

**2. インポート文の整理**

- 標準ライブラリ → サードパーティ → ローカルモジュールの順
- 各グループ間に空行を挿入
- 未使用インポートの削除

**3. 文字列フォーマット**

- f-string の使用を推奨
- 長い文字列は複数行に分割
- 文字列連結は`+`ではなく`join()`を使用

**4. 関数・メソッド定義**

- 引数が多い場合は複数行に分割
- 型ヒントの使用
- デフォルト引数の適切な配置

**5. 条件文・ループ**

- 長い条件は複数行に分割
- ネストは 3 レベル以下
- 早期リターンの使用

#### 実装時のチェックリスト

**コード作成時**

- [ ] 行長が 88 文字以下であることを確認
- [ ] インポート文が整理されている
- [ ] 未使用の変数・インポートがない
- [ ] 適切な型ヒントが付いている
- [ ] エラーハンドリングが適切

**コードレビュー時**

- [ ] 行長制限の遵守
- [ ] コードの可読性
- [ ] 命名規則の統一
- [ ] ドキュメンテーションの充実
- [ ] テストカバレッジの確認

#### 自動化ツール

**1. フォーマッタ**

- **Black**: コードフォーマットの自動化
- **isort**: インポート文の自動整理
- **autopep8**: PEP8 準拠の自動修正

**2. リント**

- **flake8**: コード品質チェック
- **pylint**: 包括的なコード分析
- **mypy**: 型チェック

**3. 設定ファイル**

```toml
# pyproject.toml
[tool.black]
line-length = 88
target-version = ['py39']

[tool.isort]
profile = "black"
line_length = 88

[tool.flake8]
max-line-length = 88
extend-ignore = ["E203", "W503"]
```

#### 実装前の準備

**1. 開発環境の設定**

- [ ] Black フォーマッタのインストール
- [ ] isort のインストール
- [ ] flake8 のインストール
- [ ] エディタの設定（自動フォーマット）

**2. プレコミットフック**

- [ ] コードフォーマットの自動実行
- [ ] リントチェックの自動実行
- [ ] 型チェックの自動実行

**3. CI/CD パイプライン**

- [ ] 自動フォーマットチェック
- [ ] リントエラーの検出
- [ ] テストの自動実行

### コードレビュー

- 各 Phase 完了時にコードレビューを実施
- コード品質、保守性、拡張性を評価
- セキュリティとベストプラクティスの確認
- **行長制限の遵守を重点的にチェック**

### 受け入れテスト

- 各 Phase の完了基準に基づく受け入れテスト
- ユーザー要件の満足度確認
- パフォーマンス要件の確認
- **コード品質基準の確認**

## 🚨 リスク管理

### 技術的リスク

1. **Yahoo Finance API 制限**: API 制限による差分データ取得失敗
   - **対策**: エラーハンドリングと再試行機能の実装
2. **データベース競合**: 同時実行時の競合状態
   - **対策**: 適切なロック機構の実装
3. **メモリ不足**: 大量データ処理時のメモリ不足
   - **対策**: バッチ処理とメモリ最適化
4. **基盤データの破損**: 基盤データの整合性問題
   - **対策**: 基盤データのバックアップと検証機能

### スケジュールリスク

1. **開発遅延**: 予想以上の開発時間
   - **対策**: バッファ時間の確保と優先度の調整
2. **依存関係の問題**: 既存システムとの互換性問題
   - **対策**: 早期の統合テストと段階的実装

### 品質リスク

1. **バグの発生**: 実装時のバグ
   - **対策**: 包括的なテストとコードレビュー
2. **パフォーマンス問題**: 処理時間の遅延
   - **対策**: 早期のパフォーマンステストと最適化
3. **差分データの不整合**: 差分更新時のデータ不整合
   - **対策**: 差分データの検証機能とロールバック機能

## 📈 成功指標

### 技術的指標

- **テストカバレッジ**: 90%以上
- **バグ密度**: 1000 行あたり 1 バグ以下
- **処理時間**: 各処理が 5 分以内で完了
- **成功率**: 95%以上の成功率
- **差分更新精度**: 100%の正確性

### ユーザビリティ指標

- **使いやすさ**: 直感的な CLI コマンド
- **エラー処理**: 分かりやすいエラーメッセージ
- **ドキュメント**: 充実した使用方法ガイド

### 保守性指標

- **コード品質**: 読みやすく保守しやすいコード
- **拡張性**: 新機能追加が容易な設計
- **ドキュメント**: 最新で正確なドキュメント

## 🎯 新しいワークフローの利点

### 効率性

- 基盤データを毎回再取得する必要がない
- 差分データのみを取得することで処理時間を短縮
- API 制限への影響を最小化

### 継続性

- 基盤データとの連続性を保つ
- 時系列データの整合性を維持
- データの信頼性を向上

### 実用性

- 定期的な差分更新が可能
- 基盤データへの簡単な復旧が可能
- 運用コストの削減

### 保守性

- 基盤データを基準とした明確な管理
- 差分データの追跡が容易
- 問題発生時の原因特定が容易

---

**作成日**: 2025 年 1 月
**バージョン**: 2.0
**作成者**: AI Assistant
**承認者**: ユーザー
**更新日**: 2025 年 8 月 14 日
**更新内容**: 新しいワークフロー（基盤データ復元 → 差分更新）への対応
