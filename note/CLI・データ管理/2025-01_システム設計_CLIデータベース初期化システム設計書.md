# CLI データベース初期化システム設計書

**旧ファイル名**: `CLIデータベース初期化システム設計書_2025.md`  

## 📋 概要

### 目的

- データベース初期化プロセスを明確で使いやすいシステムに改善
- 基盤データを基準とした効率的な差分更新システムの構築
- 各処理の責任を分離し、保守性と拡張性を向上
- ユーザビリティの向上とエラーハンドリングの強化

### 設計原則

1. **単一責任の原則**: 各コマンド・スクリプトは明確な責任を持つ
2. **基盤データ活用**: Phase 2 で取得したデータを基盤として活用
3. **差分更新**: 基盤データ以降の差分データのみを取得
4. **段階的実行**: 処理を段階的に実行可能
5. **柔軟性**: 必要に応じて部分的な実行が可能
6. **透明性**: 各処理の進捗と結果が明確

## 🏗️ システム構成

### CLI コマンド構成

```bash
exchange-analytics data init              # データベースクリーンアップ
exchange-analytics data restore           # 基盤データの復元
exchange-analytics data update            # 差分データの更新
exchange-analytics data calculate         # テクニカル指標計算
exchange-analytics data setup             # 全処理を一括実行
```

### 処理フロー

```
データベース初期化 → 基盤データ復元 → 差分データ更新 → テクニカル指標計算
```

## 📁 ファイル構成

### 新規作成ファイル

```
scripts/cron/
├── database_cleanup.py           # データベースクリーンアップ（既存）
├── base_data_restorer.py         # 基盤データ復元（新規）
├── differential_updater.py       # 差分データ更新（新規）
├── technical_calculator.py       # テクニカル指標計算（新規）
└── unified_setup.py             # 一括実行スクリプト（更新）
```

### 基盤データ

```
data/
├── exchange_analytics_phase2_complete_2025-08-14.db  # 基盤データバックアップ
└── README_phase2_complete_2025-08-14.md             # 基盤データ仕様書
```

## 🔧 各コンポーネントの詳細設計

### 1. データベースクリーンアップ (`database_cleanup.py`)

#### 責任

- データベースファイルの削除
- テーブル構造の再作成
- クリーンな環境の提供

#### クラス設計

```python
class DatabaseCleanup:
    async def cleanup_database(self) -> bool:
        """データベースをクリーンアップ"""

    async def create_tables(self) -> bool:
        """テーブル構造を作成"""

    async def verify_cleanup(self) -> bool:
        """クリーンアップの確認"""
```

#### CLI コマンド

```bash
exchange-analytics data init [--force]
```

### 2. 基盤データ復元 (`base_data_restorer.py`)

#### 責任

- Phase 2 完了時のバックアップデータの復元
- 基盤データの整合性確認
- 復元結果の検証

#### クラス設計

```python
class BaseDataRestorer:
    async def restore_base_data(self) -> bool:
        """基盤データを復元"""

    async def _backup_current_database(self) -> None:
        """現在のデータベースをバックアップ"""

    async def _restore_from_backup(self) -> None:
        """バックアップから復元"""

    async def _verify_restoration(self) -> bool:
        """復元の確認"""
```

#### CLI コマンド

```bash
exchange-analytics data restore [--backup-path PATH]
```

### 3. 差分データ更新 (`differential_updater.py`)

#### 責任

- 基盤データ以降の差分データの取得
- 各時間足（5 分足、1 時間足、4 時間足、日足）の差分更新
- データの整合性と連続性の保証

#### クラス設計

```python
class DifferentialUpdater:
    async def update_all_timeframes(self) -> Dict[str, int]:
        """全時間足の差分データを更新"""

    async def update_timeframe(self, timeframe: str) -> int:
        """特定時間足の差分データを更新"""

    async def _calculate_differential_period(self, timeframe: str) -> Tuple[Optional[str], Optional[str]]:
        """差分期間を計算"""

    async def _get_latest_timestamp(self, timeframe: str) -> Optional[datetime]:
        """データベース内の最新タイムスタンプを取得"""

    async def _fetch_differential_data(self, timeframe: str, start_date: str, end_date: str) -> int:
        """差分データを取得して保存"""
```

#### CLI コマンド

```bash
exchange-analytics data update [--timeframe 5m|1h|4h|1d|all]
```

### 4. テクニカル指標計算 (`technical_calculator.py`)

#### 責任

- 既存テクニカル指標システムの統合
- 移動平均線、ボリンジャーバンド、RSI、MACD 等の計算
- 計算結果のデータベース保存

#### クラス設計

```python
class TechnicalCalculator:
    async def calculate_all_indicators(self) -> Dict[str, int]:
        """全テクニカル指標を計算"""

    async def calculate_timeframe_indicators(self, timeframe: str) -> int:
        """特定時間足の指標を計算"""

    async def _initialize_existing_systems(self) -> bool:
        """既存システムの初期化"""
```

#### CLI コマンド

```bash
exchange-analytics data calculate [--timeframe 5m|1h|4h|1d|all] [--indicator ma|bb|rsi|macd|all]
```

### 5. 一括実行スクリプト (`unified_setup.py`)

#### 責任

- 全処理の一括実行
- 処理間の依存関係管理
- エラーハンドリングと復旧

#### クラス設計

```python
class UnifiedSetup:
    async def run_full_setup(self) -> bool:
        """全処理を一括実行"""

    async def run_step_by_step(self) -> bool:
        """段階的に実行"""

    async def handle_errors(self, step: str, error: Exception) -> bool:
        """エラーハンドリング"""

    async def _execute_step(self, step_name: str, step_func: Callable) -> bool:
        """個別ステップの実行"""

    async def _generate_report(self) -> dict:
        """実行結果レポートの生成"""
```

#### CLI コマンド

```bash
exchange-analytics data setup [--step-by-step] [--skip-update]
```

## 🔄 処理フロー詳細

### 1. データベースクリーンアップ

```
1. 既存データベースファイルの削除
2. データベース接続の初期化
3. テーブル構造の作成
4. クリーンアップの確認
```

### 2. 基盤データ復元

```
1. 基盤データバックアップの存在確認
2. 現在のデータベースのバックアップ（存在する場合）
3. 基盤データの復元
4. 復元結果の確認
   - データ件数の確認
   - 各時間足の件数確認
   - データの整合性確認
```

### 3. 差分データ更新

```
1. 各時間足の最新タイムスタンプを取得
2. 差分期間の計算
   - 5分足: 最新タイムスタンプ + 5分 ～ 現在
   - 1時間足: 最新タイムスタンプ + 1時間 ～ 現在
   - 4時間足: 最新タイムスタンプ + 4時間 ～ 現在
   - 日足: 最新タイムスタンプ + 1日 ～ 現在
3. 差分データの取得
4. データの検証と保存
5. 重複チェックと更新
```

### 4. テクニカル指標計算

```
1. 既存テクニカル指標システムの初期化
2. 各時間足のデータ確認
3. 移動平均線の計算
   - SMA: 5, 10, 20, 50, 100, 200期間
   - EMA: 12, 26期間
4. ボリンジャーバンドの計算
5. RSI、MACD等の計算
6. 計算結果の保存
```

## 🛠️ 実装計画

### Phase 1: 基盤整備

1. **データベースクリーンアップ** (`database_cleanup.py`) - 完了
2. **CLI コマンドの基本構造** (`data_commands.py`の更新) - 完了

### Phase 2: データ処理

3. **データ取得処理** (`data_loader.py`) - 完了
4. **基盤データの確立** - 完了

### Phase 3: 差分更新処理

5. **基盤データ復元** (`base_data_restorer.py`)
6. **差分データ更新** (`differential_updater.py`)

### Phase 4: 分析処理

7. **テクニカル指標計算** (`technical_calculator.py`)
8. **一括実行スクリプト** (`unified_setup.py`)

### Phase 5: 統合・テスト

9. **全処理の統合テスト**
10. **エラーハンドリングの強化**
11. **ドキュメントの更新**

## 📊 エラーハンドリング戦略

### エラー分類

1. **軽微なエラー**: 警告として処理を継続
2. **重要なエラー**: 処理を停止し、ユーザーに選択を求める
3. **致命的なエラー**: 処理を完全に停止

### 復旧オプション

- **再試行**: 同じ処理を再実行
- **スキップ**: 問題のある処理をスキップ
- **ロールバック**: 前の状態に戻す
- **基盤データ復元**: 基盤データから再開始

## 🔍 品質保証

### テスト戦略

1. **単体テスト**: 各コンポーネントの個別テスト
2. **統合テスト**: 処理間の連携テスト
3. **エンドツーエンドテスト**: 全フローのテスト
4. **差分更新テスト**: 差分データの正確性テスト

### 監視項目

- データ取得成功率
- 差分更新の正確性
- 処理時間
- エラー発生率
- データ品質指標

## 📈 将来の拡張性

### 追加可能な機能

1. **自動差分更新スケジューリング**
2. **複数通貨ペア対応**
3. **リアルタイムデータ取得**
4. **データ品質監視ダッシュボード**
5. **基盤データの定期更新**

### 設定の外部化

- データベース設定
- API 設定
- 処理パラメータ
- ログ設定
- 基盤データパス設定

## 📝 移行計画

### 段階的移行

1. **新システムの並行開発**
2. **段階的な機能移行**
3. **旧システムの段階的廃止**
4. **完全移行の確認**

### データ移行

- 基盤データの保持
- 差分データの継続性確保
- 移行スクリプトの提供

## 🎯 新しいワークフローの利点

### 効率性

- 基盤データを毎回再取得する必要がない
- 差分データのみを取得することで処理時間を短縮
- API 制限への影響を最小化

### 継続性

- 基盤データとの連続性を保つ
- 時系列データの整合性を維持
- データの信頼性を向上

### 実用性

- 定期的な差分更新が可能
- 基盤データへの簡単な復旧が可能
- 運用コストの削減

### 保守性

- 基盤データを基準とした明確な管理
- 差分データの追跡が容易
- 問題発生時の原因特定が容易

---

**作成日**: 2025 年 1 月
**バージョン**: 2.0
**作成者**: AI Assistant
**承認者**: ユーザー
**更新日**: 2025 年 8 月 14 日
**更新内容**: 新しいワークフロー（基盤データ復元 → 差分更新）への対応
