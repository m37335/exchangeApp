**旧ファイル名**: `基本設計書_20250809.md`  

# 為替分析アプリ 基本設計書

**作成日**: 2025 年 8 月 9 日
**バージョン**: 1.0.0
**対象システム**: Exchange Analytics App

## 1. 使っている技術スタック

### Backend

- **Python 3.11**: メイン開発言語
- **Flask 2.3.3**: Web フレームワーク
- **SQLite/PostgreSQL**: データベース（開発/本番）
- **SQLAlchemy**: ORM ライブラリ（将来実装予定）

### AI・分析技術

- **OpenAI GPT-4 API**: 市場分析レポート生成
- **pandas 2.0.3**: データ分析・処理
- **numpy 1.24.3**: 数値計算
- **ta 0.10.2**: テクニカル分析ライブラリ

### 外部 API・データ取得

- **Alpha Vantage API**: 為替データ取得
- **Yahoo Finance API**: 補助データ取得
- **GitHub API**: 自動更新機能

### 通知・連携

- **Discord Webhook**: レポート・アラート配信
- **APScheduler 3.10.4**: 定期実行スケジューラー

### インフラ・デプロイ

- **Docker**: コンテナ化
- **Docker Compose**: 開発環境構築
- **GitHub Actions**: CI/CD（予定）

### フロントエンド

- **HTML5 + CSS3**: 基本 UI
- **JavaScript + Chart.js**: チャート表示
- **Bootstrap**: レスポンシブデザイン（予定）

## 2. 機能の概要

### 2.1 主要機能

1. **リアルタイム為替データ取得・表示**

   - 主要通貨ペア（USD/JPY, EUR/JPY, GBP/JPY 等）の価格取得
   - 1 分間隔での自動更新
   - 過去 1 年分の履歴データ蓄積

2. **AI 市場分析レポート**

   - ChatGPT-4 による総合的な市場分析
   - 毎朝 8 時の定期レポート自動生成
   - Discord 自動配信（Embed 形式）

3. **テクニカル分析**

   - 移動平均（SMA, EMA）
   - モメンタム指標（RSI, MACD, ストキャスティクス）
   - ボラティリティ指標（ボリンジャーバンド, ATR）
   - サポート・レジスタンス自動検出

4. **アラート・通知機能**

   - 価格ベースアラート
   - テクニカル指標ベースアラート
   - Discord/メール通知

5. **プラグインシステム**

   - テクニカル指標の動的追加
   - 分析アルゴリズムのカスタマイズ
   - レポートテンプレートの拡張

6. **GitHub 自動更新機能**
   - Webhook による自動デプロイ
   - セキュアな署名検証
   - 手動更新 API

### 2.2 API エンドポイント

```
# データ取得
GET  /api/rates/{pair}              # 最新レート取得
GET  /api/rates/{pair}/history      # 履歴データ取得
GET  /api/rates/all                 # 全通貨ペア取得

# 分析
GET  /api/analysis/{pair}/technical # テクニカル指標
GET  /api/analysis/{pair}/signals   # 売買シグナル

# AI分析レポート
POST /api/ai/report/generate        # レポート生成
GET  /api/ai/reports                # レポート一覧
GET  /api/ai/report/latest          # 最新レポート

# アラート管理
GET  /api/alerts                    # アラート一覧
POST /api/alerts                    # アラート作成
PUT  /api/alerts/{id}               # アラート更新

# プラグイン管理
GET  /api/plugins                   # プラグイン一覧
PUT  /api/plugins/{name}/config     # プラグイン設定更新

# GitHub連携
POST /api/github/webhook            # Webhook受信
GET  /api/github/info               # 連携状況確認
POST /api/github/update             # 手動更新
```

## 3. 背景・目的

### 3.1 背景

- 為替市場の複雑性と 24 時間取引の特性
- 手動分析の限界と人的ミスの回避
- リアルタイム情報処理の必要性
- AI 技術を活用した高度な分析需要

### 3.2 目的

- **投資判断支援**: データドリブンな意思決定
- **分析効率化**: 自動化による時間短縮
- **リスク管理**: 適切なタイミングでのアラート
- **継続的学習**: AI 分析による市場理解向上
- **拡張性確保**: 将来的な機能追加への対応

## 4. コンポーネント設計

### 4.1 アーキテクチャ概要

```
┌─────────────────┐    ┌─────────────────┐    ┌─────────────────┐
│   Frontend      │    │   Flask API     │    │  External APIs  │
│  (Chart.js)     │◄──►│   (Backend)     │◄──►│ (Alpha Vantage) │
└─────────────────┘    └─────────────────┘    └─────────────────┘
                              │
                       ┌─────────────────┐
                       │   Database      │
                       │  (SQLite/PG)    │
                       └─────────────────┘
                              │
                       ┌─────────────────┐
                       │ Plugin System   │
                       │ (Extensible)    │
                       └─────────────────┘
                              │
                       ┌─────────────────┐
                       │ Discord/GitHub  │
                       │  (Integrations) │
                       └─────────────────┘
```

### 4.2 プラグインシステム

```
分析エンジンコア
├── Plugin Manager      # プラグイン管理
├── Config Manager      # 設定管理
├── Signal Aggregator   # シグナル統合
├── Technical Plugins   # テクニカル指標
├── Analysis Plugins    # 分析アルゴリズム
└── Report Templates    # レポートテンプレート
```

### 4.3 データフロー

1. **データ取得**: Alpha Vantage API → データベース保存
2. **分析処理**: テクニカル指標計算 → シグナル生成
3. **AI 分析**: 市場データ → ChatGPT-4 → レポート生成
4. **通知配信**: Discord Webhook → ユーザー通知
5. **設定管理**: 動的設定変更 → プラグインリロード

## 5. できること・制限事項

### 5.1 できること

#### データ分析

- リアルタイム為替レート監視
- 過去 1 年分のデータ分析
- 15 種類以上のテクニカル指標計算
- AI による総合的な市場分析
- カスタム分析アルゴリズムの追加

#### 自動化機能

- 毎朝 8 時の定期レポート生成
- 価格・指標ベースのアラート
- Discord への自動通知
- GitHub プッシュ時の自動デプロイ

#### 拡張機能

- プラグインによる機能追加
- カスタムレポートテンプレート
- 動的設定変更（運用中）
- 通貨ペア別個別設定

### 5.2 制限事項

#### API 制限

- **Alpha Vantage**: 無料版は 1 分 5 回、1 日 500 回
- **OpenAI**: レート制限とコスト（GPT-4 使用）
- **Discord**: Webhook レート制限

#### データ制限

- **履歴データ**: 過去 1 年分（拡張可能）
- **更新頻度**: 1 分間隔（API 制限による）
- **対象通貨**: 主要 7 ペア（拡張可能）

#### 技術制限

- **リアルタイム性**: 1 分遅延
- **分析精度**: 過去データベースの予測
- **可用性**: 外部 API の依存性

## 6. コンポーネント使用時のオプション

### 6.1 環境変数設定

```bash
# 必須設定
OPENAI_API_KEY=your-openai-key
ALPHA_VANTAGE_API_KEY=your-alpha-vantage-key
DISCORD_WEBHOOK_URL=your-discord-webhook

# オプション設定
AI_REPORT_SCHEDULE=08:00          # レポート生成時刻
OPENAI_MODEL=gpt-4               # AIモデル選択
DATABASE_URL=sqlite:///app.db     # データベース設定
```

### 6.2 プラグイン設定例

```python
# テクニカル指標プラグイン
{
    "name": "custom_sma",
    "type": "technical",
    "config": {
        "period": 20,
        "currency_pairs": ["USD/JPY", "EUR/JPY"],
        "enabled": true
    }
}

# AI分析プラグイン
{
    "name": "trend_predictor",
    "type": "analysis",
    "config": {
        "model": "gpt-4",
        "confidence_threshold": 0.7,
        "prompt_template": "custom_analysis_v2"
    }
}
```

### 6.3 レポートテンプレート設定

```json
{
  "template_id": "daily_report",
  "sections": [
    { "type": "summary", "title": "市場概況" },
    { "type": "technical", "title": "テクニカル分析" },
    { "type": "ai_analysis", "title": "AI分析" },
    { "type": "signals", "title": "売買シグナル" }
  ],
  "style": {
    "discord_color": "0x3498db",
    "max_field_length": 1024
  }
}
```

## 7. 関連ファイル・ディレクトリ構造

### 7.1 プロジェクト構造

```
exchangeApp/
├── app.py                          # メインアプリケーション
├── config/                         # 設定管理
│   ├── settings.py
│   ├── database.py
│   └── plugins.py
├── models/                         # データモデル
│   ├── exchange_rate.py
│   ├── technical_indicator.py
│   ├── ai_report.py
│   └── plugin_config.py
├── services/                       # ビジネスロジック
│   ├── data_fetcher.py
│   ├── analysis_engine.py
│   ├── ai_analyzer.py
│   ├── discord_notifier.py
│   └── scheduler.py
├── plugins/                        # プラグインシステム
│   ├── base/                      # 基底クラス
│   ├── technical/                 # テクニカル指標
│   ├── analysis/                  # 分析アルゴリズム
│   └── reports/                   # レポートテンプレート
├── api/                           # API エンドポイント
│   └── routes/
├── frontend/                      # フロントエンド
│   ├── static/
│   └── templates/
├── database/                      # データベース関連
│   ├── migrations/
│   └── seeds/
├── tests/                         # テスト
├── docs/                          # ドキュメント
│   ├── DESIGN.md
│   ├── PROJECT_STRUCTURE.md
│   └── API.md
└── note/                          # 作業ノート
    └── 基本設計書_20250809.md     # このファイル
```

### 7.2 重要な設定ファイル

- **app.py**: メインアプリケーション、ルーティング定義
- **.env**: 環境変数設定（API キー等）
- **requirements.txt**: Python 依存関係
- **docker-compose.yml**: 開発環境設定
- **DESIGN.md**: 詳細設計書（711 行）
- **PROJECT_STRUCTURE.md**: プロジェクト構造詳細

### 7.3 データベーステーブル

```sql
-- 為替レートデータ
exchange_rates (id, currency_pair, timestamp, ohlcv, created_at)

-- テクニカル指標
technical_indicators (id, currency_pair, indicator_type, value, timestamp)

-- AI分析レポート
ai_market_reports (id, report_date, market_summary, technical_analysis, recommendations)

-- アラート設定
alerts (id, currency_pair, alert_type, condition_data, is_active)

-- プラグイン設定
plugin_configs (id, plugin_name, plugin_type, config_data, is_enabled)
```

## 8. 注意点

### 8.1 セキュリティ

- **API キー管理**: 環境変数で管理、GitHub にコミットしない
- **Webhook 署名検証**: HMAC-SHA256 による検証必須
- **レート制限**: Flask-Limiter 実装推奨
- **入力検証**: 全 API エンドポイントで実装

### 8.2 パフォーマンス

- **API 呼び出し最適化**: ローカルキャッシュ活用
- **データベース最適化**: インデックス設定
- **メモリ使用量**: 大量データ処理時の注意
- **非同期処理**: 重い処理はバックグラウンド実行

### 8.3 運用・保守

- **ログ記録**: 全重要処理のログ出力
- **エラーハンドリング**: 外部 API 障害への対応
- **データバックアップ**: 定期的な DB バックアップ
- **監視**: API 応答時間・エラー率の監視

### 8.4 開発・拡張

- **プラグイン開発**: 基底クラスの継承必須
- **設定変更**: 動的リロード対応
- **テスト**: 新機能追加時のテストケース作成
- **ドキュメント**: 機能追加時のドキュメント更新

### 8.5 外部依存

- **Alpha Vantage API**: 障害時の代替案準備
- **OpenAI API**: コスト管理と使用量監視
- **Discord**: Webhook URL の適切な管理
- **GitHub**: 認証情報の定期的な更新

### 8.6 費用・制限

- **OpenAI API**: GPT-4 使用時の高コスト
- **Alpha Vantage**: 有料版への移行検討
- **インフラ**: 本番環境のサーバー費用
- **データストレージ**: 長期データ保存の容量計画

---

**次回更新予定**: 実装完了後（Phase 1 終了時）
**関連ドキュメント**: DESIGN.md, PROJECT_STRUCTURE.md
**作成者**: AI Assistant
**レビュー状況**: 未レビュー
