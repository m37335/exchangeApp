**旧ファイル名**: `フォルダ構成実装ガイド_20250809.md`  

# フォルダ構成実装ガイド

**作成日**: 2025 年 8 月 9 日
**目的**: モジュール型フォルダ構成の段階的実装

## 1. 実装順序（優先度順）

### Phase 1: 基盤構築（最重要）

```bash
# 1. コアディレクトリ作成
mkdir -p src/{core,domain,application,infrastructure,presentation,shared}
mkdir -p src/domain/{entities,value_objects,repositories,services}
mkdir -p src/application/{commands,queries,handlers,interfaces}
mkdir -p src/infrastructure/{database,external_apis,messaging,cache}
mkdir -p src/presentation/{api,web,cli}

# 2. プラグインシステム基盤
mkdir -p plugins/{interfaces,core,custom}
mkdir -p plugins/core/{technical,analysis,reports}

# 3. 設定・テスト
mkdir -p config tests/{unit,integration,e2e,fixtures}
mkdir -p database/{migrations,seeds}
```

### Phase 2: API・ビジネスロジック

```bash
# 4. API構造
mkdir -p src/presentation/api/{middleware,routes,schemas}
mkdir -p src/shared/{utils,constants,types}

# 5. 外部API連携
mkdir -p src/infrastructure/external_apis
mkdir -p src/infrastructure/messaging
```

### Phase 3: 運用・監視

```bash
# 6. 運用関連
mkdir -p {scripts,deployment,monitoring,tools}
mkdir -p deployment/docker
mkdir -p docs/{architecture,api,plugins,deployment}
```

## 2. 必須ファイル作成順序

### Step 1: 基本構造ファイル

```python
# src/__init__.py
"""
為替分析アプリケーション
モジュール型アーキテクチャ
"""
__version__ = "1.0.0"

# src/main.py
"""アプリケーションエントリーポイント"""
from src.core.application import create_app

def main():
    app = create_app()
    app.run()

if __name__ == "__main__":
    main()

# src/core/__init__.py
# src/core/application.py
"""アプリケーション初期化"""
from flask import Flask
from src.core.container import Container

def create_app() -> Flask:
    app = Flask(__name__)
    container = Container()

    # 依存性注入設定
    container.wire(modules=["src.presentation.api.routes"])

    # ルート登録
    from src.presentation.api.routes import register_routes
    register_routes(app)

    return app

# src/core/container.py
"""DIコンテナ"""
from dependency_injector import containers, providers

class Container(containers.DeclarativeContainer):
    wiring_config = containers.WiringConfiguration(
        modules=["src.presentation.api.routes"]
    )

    # 設定
    config = providers.Configuration()

    # データベース
    db = providers.Singleton(
        "src.infrastructure.database.connection.Database",
        config.database_url
    )
```

### Step 2: ドメイン層基盤

```python
# src/domain/entities/__init__.py
# src/domain/entities/base.py
"""エンティティ基底クラス"""
from abc import ABC
from dataclasses import dataclass
from datetime import datetime
from typing import Optional

@dataclass
class BaseEntity(ABC):
    id: Optional[int] = None
    created_at: Optional[datetime] = None
    updated_at: Optional[datetime] = None

# src/domain/entities/exchange_rate.py
"""為替レートエンティティ"""
from dataclasses import dataclass
from datetime import datetime
from decimal import Decimal
from .base import BaseEntity

@dataclass
class ExchangeRate(BaseEntity):
    currency_pair: str
    timestamp: datetime
    open_price: Decimal
    high_price: Decimal
    low_price: Decimal
    close_price: Decimal
    volume: Optional[int] = None
```

### Step 3: プラグインシステム基盤

```python
# plugins/__init__.py
# plugins/interfaces/__init__.py
# plugins/interfaces/base_plugin.py
"""プラグイン基底クラス"""
from abc import ABC, abstractmethod
from typing import Dict, Any, List

class BasePlugin(ABC):
    def __init__(self, name: str, version: str, config: Dict = None):
        self.name = name
        self.version = version
        self.config = config or {}
        self.enabled = True

    @abstractmethod
    def initialize(self) -> None:
        """プラグイン初期化"""
        pass

    @abstractmethod
    def execute(self, data: Any) -> Any:
        """プラグイン実行"""
        pass

    def validate_config(self) -> bool:
        """設定値検証"""
        return True

# plugins/interfaces/technical_indicator_plugin.py
"""テクニカル指標プラグインインターフェース"""
import pandas as pd
from .base_plugin import BasePlugin

class TechnicalIndicatorPlugin(BasePlugin):
    @abstractmethod
    def calculate(self, price_data: pd.DataFrame) -> pd.Series:
        """指標計算"""
        pass

    @abstractmethod
    def get_signals(self, values: pd.Series) -> List[Dict]:
        """シグナル生成"""
        pass

# plugins/registry.py
"""プラグイン登録管理"""
from typing import Dict, Type
from .interfaces.base_plugin import BasePlugin

class PluginRegistry:
    def __init__(self):
        self._plugins: Dict[str, Type[BasePlugin]] = {}
        self._instances: Dict[str, BasePlugin] = {}

    def register(self, plugin_class: Type[BasePlugin]):
        """プラグイン登録"""
        self._plugins[plugin_class.__name__] = plugin_class

    def get_plugin(self, name: str) -> BasePlugin:
        """プラグインインスタンス取得"""
        if name not in self._instances:
            plugin_class = self._plugins[name]
            self._instances[name] = plugin_class()
        return self._instances[name]
```

## 3. 設定ファイル作成

### config/base.py

```python
"""基本設定"""
import os
from typing import Optional

class BaseConfig:
    # 基本設定
    SECRET_KEY: str = os.getenv('SECRET_KEY', 'dev-secret-key')
    DEBUG: bool = os.getenv('DEBUG', 'False').lower() == 'true'

    # データベース
    DATABASE_URL: str = os.getenv('DATABASE_URL', 'sqlite:///exchange_app.db')

    # 外部API
    ALPHA_VANTAGE_API_KEY: Optional[str] = os.getenv('ALPHA_VANTAGE_API_KEY')
    OPENAI_API_KEY: Optional[str] = os.getenv('OPENAI_API_KEY')

    # Discord
    DISCORD_WEBHOOK_URL: Optional[str] = os.getenv('DISCORD_WEBHOOK_URL')

    # GitHub
    GITHUB_TOKEN: Optional[str] = os.getenv('GITHUB_TOKEN')
    GITHUB_WEBHOOK_SECRET: Optional[str] = os.getenv('GITHUB_WEBHOOK_SECRET')
```

### config/plugins.yaml

```yaml
plugins:
  technical_indicators:
    sma_plugin:
      enabled: true
      config:
        periods: [5, 20, 50, 200]
        currency_pairs: ["USD/JPY", "EUR/JPY", "GBP/JPY"]

    rsi_plugin:
      enabled: true
      config:
        period: 14
        overbought_threshold: 70
        oversold_threshold: 30

  analysis:
    trend_analysis:
      enabled: true
      config:
        lookback_period: 50
        confidence_threshold: 0.7

    ai_analysis:
      enabled: true
      config:
        model: "gpt-4"
        max_tokens: 2000
        temperature: 0.3

  reports:
    daily_report:
      enabled: true
      config:
        schedule: "08:00"
        sections: ["summary", "technical", "ai_analysis", "signals"]
```

## 4. 実装チェックリスト

### ✅ Phase 1: 基盤構築

- [ ] ディレクトリ構造作成
- [ ] 基本**init**.py ファイル作成
- [ ] DI コンテナ実装
- [ ] プラグインシステム基盤
- [ ] 設定システム実装
- [ ] ドメインエンティティ定義

### ✅ Phase 2: コア機能

- [ ] データベースリポジトリ実装
- [ ] 外部 API クライアント実装
- [ ] テクニカル指標プラグイン実装
- [ ] AI 分析サービス実装
- [ ] Discord 通知実装

### ✅ Phase 3: API 層

- [ ] REST API エンドポイント実装
- [ ] リクエスト/レスポンススキーマ定義
- [ ] ミドルウェア実装
- [ ] エラーハンドリング

### ✅ Phase 4: 運用・テスト

- [ ] ユニットテスト実装
- [ ] 統合テスト実装
- [ ] Docker 設定
- [ ] CI/CD 設定

## 5. 実装時の注意点

### 5.1 依存関係管理

```python
# requirements/base.txt（最小構成）
flask==2.3.3
python-dotenv==1.0.0
dependency-injector==4.41.0

# requirements/dev.txt（開発用追加）
-r base.txt
pytest==7.4.3
black==23.11.0
mypy==1.5.1

# requirements/prod.txt（本番用追加）
-r base.txt
gunicorn==21.2.0
```

### 5.2 環境変数管理

```bash
# .env.example
# 基本設定
SECRET_KEY=your-secret-key-here
DEBUG=true
DATABASE_URL=sqlite:///exchange_app.db

# 外部API
ALPHA_VANTAGE_API_KEY=your-api-key
OPENAI_API_KEY=your-openai-key
DISCORD_WEBHOOK_URL=your-webhook-url

# GitHub連携
GITHUB_TOKEN=your-github-token
GITHUB_WEBHOOK_SECRET=your-webhook-secret
```

### 5.3 ログ設定

```yaml
# config/logging.yaml
version: 1
disable_existing_loggers: false

formatters:
  standard:
    format: "%(asctime)s [%(levelname)s] %(name)s: %(message)s"

handlers:
  console:
    class: logging.StreamHandler
    level: INFO
    formatter: standard
    stream: ext://sys.stdout

  file:
    class: logging.FileHandler
    level: DEBUG
    formatter: standard
    filename: logs/app.log
    mode: a

loggers:
  src:
    level: DEBUG
    handlers: [console, file]
    propagate: false

  plugins:
    level: DEBUG
    handlers: [console, file]
    propagate: false

root:
  level: INFO
  handlers: [console]
```

## 6. 開発開始手順

### 6.1 初期セットアップ

```bash
# 1. 仮想環境作成
python -m venv venv
source venv/bin/activate  # Linux/Mac
# または
venv\Scripts\activate  # Windows

# 2. 基本依存関係インストール
pip install -r requirements/dev.txt

# 3. 環境変数設定
cp .env.example .env
# .envファイルを編集

# 4. データベース初期化
python scripts/setup_db.py

# 5. 開発サーバー起動
python src/main.py
```

### 6.2 開発ワークフロー

```bash
# 1. 機能ブランチ作成
git checkout -b feature/new-indicator

# 2. テスト駆動開発
# tests/unit/plugins/technical/test_new_indicator.py を作成
pytest tests/unit/plugins/technical/test_new_indicator.py

# 3. プラグイン実装
# plugins/core/technical/new_indicator_plugin.py を実装

# 4. 設定追加
# config/plugins.yaml に設定追加

# 5. 統合テスト
pytest tests/integration/

# 6. コード品質チェック
black src/ plugins/
mypy src/
flake8 src/

# 7. コミット・プッシュ
git add .
git commit -m "feat: 新しいテクニカル指標プラグイン追加"
git push origin feature/new-indicator
```

この実装ガイドに従って段階的に構築することで、保守性と拡張性の高いモジュール型アプリケーションを構築できます。
