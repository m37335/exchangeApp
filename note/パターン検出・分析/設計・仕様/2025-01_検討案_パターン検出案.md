**旧ファイル名**: `パターン検出検討案.md`  

# パターン検出検討案 - 総合分析

## 📊 概要

本資料は、USD/JPY 為替分析システムにおけるパターン検出機能の包括的な検討案です。
現在実装済みの 6 パターンから、新規提案パターンまで、信頼度、実装難易度、必要なコード構造を分析し、
段階的な実装計画を提示します。

---

## 🎯 実装済みパターン（現在 6 パターン）

### パターン 1: 強力なトレンド転換シグナル

- **信頼度**: 85-95%
- **実装難易度**: 中
- **優先度**: HIGH (100)
- **検出器**: `TrendReversalDetector`

#### 検出条件

- **D1**: RSI > 70 かつ MACD デッドクロス
- **H4**: RSI > 70 かつ ボリンジャーバンド +2σ タッチ
- **H1**: RSI > 70 かつ ボリンジャーバンド +2σ タッチ
- **M5**: RSI > 70 かつ ヒゲ形成

#### 実装クラス構造

```python
class TrendReversalDetector:
    def __init__(self):
        self.pattern = NotificationPattern.create_pattern_1()
        self.utils = PatternUtils()

    def detect(self, multi_timeframe_data: Dict[str, Any]) -> Optional[Dict[str, Any]]:
        # 全時間軸条件チェック
        # 信頼度スコア計算
        # 検出結果返却

    def _check_d1_conditions(self, data: Dict) -> Dict[str, Any]:
        # D1条件検証

    def _check_h4_conditions(self, data: Dict) -> Dict[str, Any]:
        # H4条件検証

    def _check_h1_conditions(self, data: Dict) -> Dict[str, Any]:
        # H1条件検証

    def _check_m5_conditions(self, data: Dict) -> Dict[str, Any]:
        # M5条件検証
```

### パターン 2: 押し目買いチャンス

- **信頼度**: 75-85%
- **実装難易度**: 中
- **優先度**: MEDIUM (70)
- **検出器**: `PullbackDetector`

#### 検出条件

- **D1**: RSI 30-50 かつ MACD 上昇継続
- **H4**: RSI 30-40 かつ ボリンジャーバンド -2σ タッチ
- **H1**: RSI 30-35 かつ ボリンジャーバンド -2σ タッチ
- **M5**: RSI 30 以下 かつ 反発サイン

### パターン 3: ダイバージェンス警戒

- **信頼度**: 80-90%
- **実装難易度**: 高
- **優先度**: MEDIUM (70)
- **検出器**: `DivergenceDetector`

#### 検出条件

- 価格新高値 + RSI 前回高値未達
- 価格上昇 + RSI 下降

#### 実装メソッド

```python
def _detect_divergence(self, price_data: pd.Series, rsi_data: pd.Series) -> Dict[str, bool]:
    # 価格とRSIの乖離検出
    # ベアリッシュ/ブルリッシュダイバージェンス判定
```

### パターン 4: ブレイクアウト狙い

- **信頼度**: 70-80%
- **実装難易度**: 中
- **優先度**: MEDIUM (70)
- **検出器**: `BreakoutDetector`

#### 検出条件

- **RSI**: 50-70 + MACD 上昇
- **ボリンジャーバンド**: +2σ 突破

### パターン 5: RSI50 ライン攻防

- **信頼度**: 60-70%
- **実装難易度**: 低
- **優先度**: LOW (50)
- **検出器**: `RSIBattleDetector`

#### 検出条件

- **RSI**: 45-55 範囲での攻防
- **MACD**: ゼロライン付近

### パターン 6: 複合シグナル強化

- **信頼度**: 90-95%
- **実装難易度**: 高
- **優先度**: VERY_HIGH (90)
- **検出器**: `CompositeSignalDetector`

#### 検出条件

- RSI + MACD + 価格 3 つ一致
- RSI + ボリンジャーバンド 2 つ一致

---

## 🆕 新規提案パターン

### Phase 1: ローソク足パターン（実装容易・高信頼度）

#### パターン 7: つつみ足検出

- **信頼度**: 85-90%
- **実装難易度**: 低
- **優先度**: HIGH (85)
- **検出器**: `EngulfingPatternDetector`

##### パターン特徴

- **陽のつつみ足**: 前の陰線を完全に包み込む陽線（買いシグナル）
- **陰のつつみ足**: 前の陽線を完全に包み込む陰線（売りシグナル）

##### 実装クラス構造

```python
class EngulfingPatternDetector:
    def __init__(self):
        self.pattern = NotificationPattern.create_pattern_7()
        self.utils = PatternUtils()

    def detect(self, price_data: pd.DataFrame) -> Optional[Dict[str, Any]]:
        # つつみ足パターン検出
        # 信頼度スコア計算
        # 検出結果返却

    def _detect_bullish_engulfing(self, price_data: pd.DataFrame) -> bool:
        # 陽のつつみ足検出
        # 前の陰線の実体を完全に包み込む陽線を検出

    def _detect_bearish_engulfing(self, price_data: pd.DataFrame) -> bool:
        # 陰のつつみ足検出
        # 前の陽線の実体を完全に包み込む陰線を検出

    def _calculate_engulfing_confidence(self, pattern_data: Dict) -> float:
        # つつみ足の信頼度計算
        # ボリューム確認、トレンド方向確認
```

##### 必要なメソッド

```python
def _validate_candlestick_data(self, price_data: pd.DataFrame) -> bool:
    # ローソク足データの妥当性チェック
    # OHLCVデータの存在確認

def _calculate_body_size(self, open_price: float, close_price: float) -> float:
    # 実体サイズ計算

def _calculate_wick_size(self, high: float, low: float, body_high: float, body_low: float) -> Dict[str, float]:
    # ヒゲサイズ計算（上ヒゲ、下ヒゲ）
```

#### パターン 8: 赤三兵検出

- **信頼度**: 80-85%
- **実装難易度**: 低
- **優先度**: HIGH (80)
- **検出器**: `RedThreeSoldiersDetector`

##### パターン特徴

- 3 本連続の陽線で終値が前の足より高く更新
- 強い上昇トレンドの開始を示唆

##### 実装クラス構造

```python
class RedThreeSoldiersDetector:
    def __init__(self):
        self.pattern = NotificationPattern.create_pattern_8()
        self.utils = PatternUtils()

    def detect(self, price_data: pd.DataFrame) -> Optional[Dict[str, Any]]:
        # 赤三兵パターン検出

    def _check_three_consecutive_bullish_candles(self, price_data: pd.DataFrame) -> bool:
        # 3本連続陽線チェック

    def _check_higher_closes(self, price_data: pd.DataFrame) -> bool:
        # 終値の高値更新チェック

    def _check_body_size_consistency(self, price_data: pd.DataFrame) -> bool:
        # 実体サイズの一貫性チェック
```

#### パターン 9: 大陽線/大陰線引け坊主

- **信頼度**: 75-80%
- **実装難易度**: 低
- **優先度**: MEDIUM (75)
- **検出器**: `MarubozuDetector`

##### パターン特徴

- ヒゲがないか非常に短い大陽線/大陰線
- 非常に強い買い/売りの勢い

##### 実装クラス構造

```python
class MarubozuDetector:
    def __init__(self):
        self.pattern = NotificationPattern.create_pattern_9()
        self.utils = PatternUtils()

    def detect(self, price_data: pd.DataFrame) -> Optional[Dict[str, Any]]:
        # 引け坊主パターン検出

    def _detect_bullish_marubozu(self, price_data: pd.DataFrame) -> bool:
        # 大陽線引け坊主検出

    def _detect_bearish_marubozu(self, price_data: pd.DataFrame) -> bool:
        # 大陰線引け坊主検出

    def _check_wick_absence(self, high: float, low: float, open_price: float, close_price: float) -> bool:
        # ヒゲの欠如チェック
```

### Phase 2: チャートパターン（中実装難易度・高信頼度）

#### パターン 10: ダブルトップ/ボトム

- **信頼度**: 85-90%
- **実装難易度**: 中
- **優先度**: HIGH (85)
- **検出器**: `DoubleTopBottomDetector`

##### パターン特徴

- **ダブルトップ**: 同じくらいの高値を 2 回つけ、M 字のような形
- **ダブルボトム**: 同じくらいの安値を 2 回つけ、W 字のような形

##### 実装クラス構造

```python
class DoubleTopBottomDetector:
    def __init__(self):
        self.pattern = NotificationPattern.create_pattern_10()
        self.utils = PatternUtils()
        self.price_tolerance = 0.002  # 価格許容範囲（0.2%）
        self.min_distance = 5  # 最小距離（日）
        self.max_distance = 30  # 最大距離（日）

    def detect(self, price_data: pd.DataFrame) -> Optional[Dict[str, Any]]:
        # ダブルトップ/ボトム検出

    def _find_local_extrema(self, price_data: pd.DataFrame) -> Dict[str, List[int]]:
        # ローカル極値（ピーク/ボトム）検出

    def _find_similar_price_levels(self, extrema: List[int], price_data: pd.DataFrame) -> List[List[int]]:
        # 類似価格レベルの極値グループ化

    def _validate_pattern_timing(self, extrema_group: List[int], price_data: pd.DataFrame) -> bool:
        # パターンの時間間隔検証

    def _check_neckline_breakout(self, pattern_data: Dict, price_data: pd.DataFrame) -> bool:
        # ネックライン突破確認
```

##### 必要なメソッド

```python
def _calculate_price_similarity(self, price1: float, price2: float) -> bool:
    # 価格類似性チェック

def _find_neckline_level(self, tops: List[int], bottoms: List[int], price_data: pd.DataFrame) -> float:
    # ネックラインレベル計算

def _detect_breakout(self, current_price: float, neckline: float, pattern_type: str) -> bool:
    # ブレイクアウト検出
```

#### パターン 11: トリプルトップ/ボトム

- **信頼度**: 90-95%
- **実装難易度**: 中
- **優先度**: HIGH (90)
- **検出器**: `TripleTopBottomDetector`

##### パターン特徴

- **トリプルトップ**: 同じくらいの高値を 3 回つける
- **トリプルボトム**: 同じくらいの安値を 3 回つける
- ダブルトップ/ボトムより強い反転シグナル

##### 実装クラス構造

```python
class TripleTopBottomDetector:
    def __init__(self):
        self.pattern = NotificationPattern.create_pattern_11()
        self.utils = PatternUtils()
        self.price_tolerance = 0.002
        self.min_distance = 5
        self.max_distance = 45  # トリプルはより長い期間

    def detect(self, price_data: pd.DataFrame) -> Optional[Dict[str, Any]]:
        # トリプルトップ/ボトム検出

    def _find_triple_patterns(self, extrema: List[int], price_data: pd.DataFrame) -> List[List[int]]:
        # 3つの類似価格レベルの極値検出

    def _validate_triple_timing(self, extrema_group: List[int], price_data: pd.DataFrame) -> bool:
        # トリプルパターンの時間間隔検証
```

#### パターン 12: フラッグパターン

- **信頼度**: 80-85%
- **実装難易度**: 中
- **優先度**: HIGH (80)
- **検出器**: `FlagPatternDetector`

##### パターン特徴

- **上昇フラッグ**: 上昇トレンド後の下向き平行四辺形
- **下降フラッグ**: 下降トレンド後の上向き平行四辺形

##### 実装クラス構造

```python
class FlagPatternDetector:
    def __init__(self):
        self.pattern = NotificationPattern.create_pattern_12()
        self.utils = PatternUtils()

    def detect(self, price_data: pd.DataFrame) -> Optional[Dict[str, Any]]:
        # フラッグパターン検出

    def _detect_flagpole(self, price_data: pd.DataFrame) -> Optional[Dict[str, Any]]:
        # フラッグポール（強いトレンド）検出

    def _detect_flag_formation(self, price_data: pd.DataFrame, trend_direction: str) -> bool:
        # フラッグ形成（平行四辺形）検出

    def _check_breakout_direction(self, flag_data: Dict, price_data: pd.DataFrame) -> str:
        # ブレイクアウト方向確認
```

### Phase 3: 高度なパターン（高実装難易度・高信頼度）

#### パターン 13: 三尊天井/逆三尊

- **信頼度**: 85-90%
- **実装難易度**: 高
- **優先度**: HIGH (85)
- **検出器**: `HeadAndShouldersDetector`

##### パターン特徴

- **三尊天井**: 中央の山が最も高い 3 つの山
- **逆三尊**: 三尊天井を逆にした底値パターン

##### 実装クラス構造

```python
class HeadAndShouldersDetector:
    def __init__(self):
        self.pattern = NotificationPattern.create_pattern_13()
        self.utils = PatternUtils()

    def detect(self, price_data: pd.DataFrame) -> Optional[Dict[str, Any]]:
        # 三尊天井/逆三尊検出

    def _detect_head_and_shoulders(self, price_data: pd.DataFrame) -> Optional[Dict[str, Any]]:
        # 三尊天井検出

    def _detect_inverse_head_and_shoulders(self, price_data: pd.DataFrame) -> Optional[Dict[str, Any]]:
        # 逆三尊検出

    def _find_shoulder_head_shoulder(self, peaks: List[int], price_data: pd.DataFrame) -> Optional[List[int]]:
        # 肩-頭-肩パターン検出

    def _calculate_neckline(self, pattern_points: List[int], price_data: pd.DataFrame) -> float:
        # ネックライン計算
```

#### パターン 14: ウェッジパターン

- **信頼度**: 75-80%
- **実装難易度**: 高
- **優先度**: MEDIUM (75)
- **検出器**: `WedgePatternDetector`

##### パターン特徴

- **上昇ウェッジ**: 先端が徐々に狭まる上向き三角形
- **下降ウェッジ**: 先端が徐々に狭まる下向き三角形

##### 実装クラス構造

```python
class WedgePatternDetector:
    def __init__(self):
        self.pattern = NotificationPattern.create_pattern_14()
        self.utils = PatternUtils()

    def detect(self, price_data: pd.DataFrame) -> Optional[Dict[str, Any]]:
        # ウェッジパターン検出

    def _detect_rising_wedge(self, price_data: pd.DataFrame) -> Optional[Dict[str, Any]]:
        # 上昇ウェッジ検出

    def _detect_falling_wedge(self, price_data: pd.DataFrame) -> Optional[Dict[str, Any]]:
        # 下降ウェッジ検出

    def _calculate_trendline_convergence(self, highs: List[int], lows: List[int], price_data: pd.DataFrame) -> bool:
        # トレンドライン収束チェック
```

### Phase 4: ライン分析パターン（最高実装難易度・高信頼度）

#### パターン 15: レジスタンス/サポートライン

- **信頼度**: 75-80%
- **実装難易度**: 最高
- **優先度**: MEDIUM (75)
- **検出器**: `SupportResistanceDetector`

##### パターン特徴

- **レジスタンスライン**: 価格上昇を止める水平線
- **サポートライン**: 価格下落を支える水平線

##### 実装クラス構造

```python
class SupportResistanceDetector:
    def __init__(self):
        self.pattern = NotificationPattern.create_pattern_15()
        self.utils = PatternUtils()
        self.touch_threshold = 3  # タッチ回数閾値

    def detect(self, price_data: pd.DataFrame) -> Optional[Dict[str, Any]]:
        # サポート/レジスタンスライン検出

    def _find_support_levels(self, price_data: pd.DataFrame) -> List[float]:
        # サポートレベル検出

    def _find_resistance_levels(self, price_data: pd.DataFrame) -> List[float]:
        # レジスタンスレベル検出

    def _validate_level_strength(self, level: float, price_data: pd.DataFrame) -> float:
        # レベル強度検証

    def _detect_breakout_breakdown(self, current_price: float, levels: List[float]) -> Optional[Dict[str, Any]]:
        # ブレイクアウト/ブレイクダウン検出
```

#### パターン 16: ロールリバーサル

- **信頼度**: 80-85%
- **実装難易度**: 最高
- **優先度**: MEDIUM (80)
- **検出器**: `RoleReversalDetector`

##### パターン特徴

- レジスタンスラインを上抜けた後、サポートラインとして機能
- サポートラインを下抜けた後、レジスタンスラインとして機能

##### 実装クラス構造

```python
class RoleReversalDetector:
    def __init__(self):
        self.pattern = NotificationPattern.create_pattern_16()
        self.utils = PatternUtils()

    def detect(self, price_data: pd.DataFrame) -> Optional[Dict[str, Any]]:
        # ロールリバーサル検出

    def _detect_support_to_resistance(self, price_data: pd.DataFrame) -> Optional[Dict[str, Any]]:
        # サポート→レジスタンス転換検出

    def _detect_resistance_to_support(self, price_data: pd.DataFrame) -> Optional[Dict[str, Any]]:
        # レジスタンス→サポート転換検出
```

---

## 🗄️ データベース拡張計画

### パターン検出結果テーブル拡張

```sql
-- 既存テーブルの拡張
ALTER TABLE pattern_detections ADD COLUMN pattern_category VARCHAR(50);
ALTER TABLE pattern_detections ADD COLUMN pattern_subtype VARCHAR(50);
ALTER TABLE pattern_detections ADD COLUMN pattern_strength DECIMAL(3,2);
ALTER TABLE pattern_detections ADD COLUMN volume_confirmation BOOLEAN DEFAULT FALSE;
ALTER TABLE pattern_detections ADD COLUMN breakout_confirmation BOOLEAN DEFAULT FALSE;

-- 新しいパターン設定
INSERT INTO system_config (config_key, config_value, config_type, description) VALUES
('pattern_7_settings', '{"name": "Engulfing Pattern", "category": "candlestick", "priority": 85, "color": "#FF6B6B"}', 'json', 'つつみ足設定'),
('pattern_8_settings', '{"name": "Red Three Soldiers", "category": "candlestick", "priority": 80, "color": "#4ECDC4"}', 'json', '赤三兵設定'),
('pattern_9_settings', '{"name": "Marubozu", "category": "candlestick", "priority": 75, "color": "#45B7D1"}', 'json', '引け坊主設定'),
('pattern_10_settings', '{"name": "Double Top/Bottom", "category": "chart_pattern", "priority": 85, "color": "#96CEB4"}', 'json', 'ダブルトップ/ボトム設定'),
('pattern_11_settings', '{"name": "Triple Top/Bottom", "category": "chart_pattern", "priority": 90, "color": "#FFEAA7"}', 'json', 'トリプルトップ/ボトム設定'),
('pattern_12_settings', '{"name": "Flag Pattern", "category": "chart_pattern", "priority": 80, "color": "#DDA0DD"}', 'json', 'フラッグパターン設定');
```

### パターン検出履歴テーブル

```sql
CREATE TABLE pattern_detection_history (
    id BIGSERIAL PRIMARY KEY,
    pattern_number INTEGER NOT NULL,
    currency_pair VARCHAR(10) NOT NULL,
    detection_time TIMESTAMP WITH TIME ZONE NOT NULL,
    pattern_category VARCHAR(50),
    pattern_subtype VARCHAR(50),
    confidence_score DECIMAL(3,2) NOT NULL,
    pattern_strength DECIMAL(3,2),
    volume_confirmation BOOLEAN,
    breakout_confirmation BOOLEAN,
    price_at_detection DECIMAL(10,5),
    target_price DECIMAL(10,5),
    stop_loss_price DECIMAL(10,5),
    actual_outcome VARCHAR(20), -- SUCCESS, FAILURE, PENDING
    profit_loss_pips INTEGER,
    created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);
```

---

## 🔧 実装優先順位とスケジュール

### Phase 1: ローソク足パターン（1-2 週間）

1. **パターン 7**: つつみ足検出
2. **パターン 8**: 赤三兵検出
3. **パターン 9**: 大陽線/大陰線引け坊主

### Phase 2: チャートパターン（2-3 週間）

4. **パターン 10**: ダブルトップ/ボトム
5. **パターン 11**: トリプルトップ/ボトム
6. **パターン 12**: フラッグパターン

### Phase 3: 高度なパターン（3-4 週間）

7. **パターン 13**: 三尊天井/逆三尊
8. **パターン 14**: ウェッジパターン

### Phase 4: ライン分析（4-5 週間）

9. **パターン 15**: レジスタンス/サポートライン
10. **パターン 16**: ロールリバーサル

---

## 📊 期待効果

### 短期効果（Phase 1-2 完了後）

- **検出精度向上**: ローソク足パターンによる短期的なエントリータイミング改善
- **信頼度向上**: チャートパターンによる中期的な方向性判断精度向上
- **通知品質向上**: より具体的で実用的なトレードシグナル提供

### 長期効果（全 Phase 完了後）

- **包括的分析**: 16 パターンによる多角的な市場分析
- **リスク管理**: 複数パターンの組み合わせによる偽シグナル軽減
- **学習効果**: パターン認識能力の向上とトレード成績改善

---

## ⚠️ 実装上の注意点

### 技術的考慮事項

1. **パフォーマンス**: 複雑なパターン検出による処理負荷増加
2. **メモリ使用量**: 大量の履歴データ保持によるメモリ消費
3. **データ品質**: 十分なデータポイント確保の必要性

### 運用上の考慮事項

1. **偽シグナル**: 複数パターンの組み合わせによるフィルタリング
2. **市場環境**: 異なる市場環境でのパターン有効性の変化
3. **継続的改善**: パターン検出精度の定期的な評価と調整

---

## 🎯 次のステップ

1. **Phase 1 実装開始**: ローソク足パターンの実装
2. **テスト環境構築**: 新パターンの検証環境準備
3. **通知テンプレート作成**: 各パターン用の Discord 通知テンプレート
4. **統合テスト**: 既存システムとの統合テスト実施
5. **本番展開**: 段階的な本番環境への展開
