# パターン検出システム仕様書

**旧ファイル名**: `パターン検出仕様書.md`  

## 📋 概要

### システム概要

USD/JPY 特化のマルチタイムフレームパターン検出システム。6 つの通知パターンを自動検出し、Discord 通知を送信する。

### 主要機能

- **6 つのパターン検出**: トレンド転換、プルバック、ダイバージェンス、ブレイクアウト、RSI 戦い、複合シグナル
- **マルチタイムフレーム分析**: 5 分足、1 時間足、4 時間足、日足の統合分析
- **自動実行**: 5 分間隔での継続的なパターン検出
- **Discord 通知**: 検出されたパターンの自動通知
- **データ永続化**: 検出結果のデータベース保存

---

## 🏗️ アーキテクチャ

### クリーンアーキテクチャ構成

```
┌─────────────────────────────────────────────────────────────┐
│                    Presentation Layer                       │
│  ┌─────────────────┐  ┌─────────────────┐  ┌─────────────┐ │
│  │ Discord Client  │  │ Notification    │  │ Templates   │ │
│  │                 │  │ Manager         │  │             │ │
│  └─────────────────┘  └─────────────────┘  └─────────────┘ │
└─────────────────────────────────────────────────────────────┘
┌─────────────────────────────────────────────────────────────┐
│                    Application Layer                        │
│  ┌─────────────────┐  ┌─────────────────┐  ┌─────────────┐ │
│  │ Pattern         │  │ Technical       │  │ Continuous  │ │
│  │ Detection       │  │ Indicator       │  │ Processing  │ │
│  │ Service         │  │ Service         │  │ Service     │ │
│  └─────────────────┘  └─────────────────┘  └─────────────┘ │
└─────────────────────────────────────────────────────────────┘
┌─────────────────────────────────────────────────────────────┐
│                    Domain Layer                             │
│  ┌─────────────────┐  ┌─────────────────┐  ┌─────────────┐ │
│  │ Notification    │  │ Pattern         │  │ Pattern     │ │
│  │ Pattern         │  │ Priority        │  │ Utils       │ │
│  │ Entity          │  │ Value Object    │  │             │ │
│  └─────────────────┘  └─────────────────┘  └─────────────┘ │
└─────────────────────────────────────────────────────────────┘
┌─────────────────────────────────────────────────────────────┐
│                    Infrastructure Layer                     │
│  ┌─────────────────┐  ┌─────────────────┐  ┌─────────────┐ │
│  │ Pattern         │  │ Database        │  │ Repository  │ │
│  │ Detectors       │  │ Models          │  │ Impl        │ │
│  └─────────────────┘  └─────────────────┘  └─────────────┘ │
└─────────────────────────────────────────────────────────────┘
```

---

## 📁 ファイル構成

### 1. パターン検出器（Detectors）

```
src/infrastructure/analysis/pattern_detectors/
├── __init__.py                           # モジュール初期化
├── trend_reversal_detector.py            # パターン1: トレンド転換
├── pullback_detector.py                  # パターン2: プルバック
├── divergence_detector.py                # パターン3: ダイバージェンス
├── breakout_detector.py                  # パターン4: ブレイクアウト
├── rsi_battle_detector.py                # パターン5: RSI戦い
└── composite_signal_detector.py          # パターン6: 複合シグナル
```

### 2. 分析エンジン

```
src/infrastructure/analysis/
├── notification_pattern_analyzer.py      # メイン分析エンジン
├── technical_indicators.py               # テクニカル指標計算
└── currency_correlation_analyzer.py      # 相関分析
```

### 3. サービス層

```
src/infrastructure/database/services/
├── efficient_pattern_detection_service.py    # 効率的パターン検出
├── pattern_detection_service.py             # 基本パターン検出
├── technical_indicator_service.py           # テクニカル指標
├── multi_timeframe_technical_indicator_service.py
├── continuous_processing_service.py         # 継続処理
└── notification_integration_service.py      # 通知統合
```

### 4. リポジトリ層

```
src/infrastructure/database/repositories/
├── pattern_detection_repository_impl.py     # パターン検出データ
├── technical_indicator_repository_impl.py   # テクニカル指標データ
├── price_data_repository_impl.py           # 価格データ
└── notification_history_repository_impl.py  # 通知履歴
```

### 5. モデル層

```
src/infrastructure/database/models/
├── pattern_detection_model.py              # パターン検出エンティティ
├── technical_indicator_model.py            # テクニカル指標エンティティ
├── price_data_model.py                     # 価格データエンティティ
└── notification_history_model.py           # 通知履歴エンティティ
```

### 6. 通知システム

```
src/infrastructure/messaging/
├── discord_client.py                       # Discordクライアント
├── notification_manager.py                 # 通知管理
└── templates/
    ├── pattern_1_template.py              # パターン1通知テンプレート
    ├── pattern_2_template.py              # パターン2通知テンプレート
    ├── pattern_3_template.py              # パターン3通知テンプレート
    ├── pattern_4_template.py              # パターン4通知テンプレート
    ├── pattern_5_template.py              # パターン5通知テンプレート
    └── pattern_6_template.py              # パターン6通知テンプレート
```

### 7. 実行スクリプト

```
scripts/cron/
├── continuous_processing_cron.py           # 継続処理メイン
├── technical_analysis_cron.py              # テクニカル分析
├── usdjpy_data_cron.py                    # USD/JPYデータ取得
└── integrated_ai_discord.py               # AI統合分析
```

---

## 🔄 実行フロー

### メイン実行フロー

```
1. データ取得 (5分間隔)
   ├── USD/JPY価格データ取得
   └── データベース保存

2. テクニカル指標計算
   ├── RSI計算 (14期間)
   ├── MACD計算 (12,26,9)
   ├── ボリンジャーバンド計算 (20期間,2σ)
   └── マルチタイムフレーム集計

3. パターン検出
   ├── パターン1: トレンド転換検出
   ├── パターン2: プルバック検出
   ├── パターン3: ダイバージェンス検出
   ├── パターン4: ブレイクアウト検出
   ├── パターン5: RSI戦い検出
   └── パターン6: 複合シグナル検出

4. 結果保存
   ├── 検出結果をデータベースに保存
   └── 重複チェック・通知状態管理

5. 通知送信
   ├── 未通知パターンの取得
   ├── Discord通知テンプレート生成
   └── Discord Webhook送信
```

### 詳細実行タイミング

#### Cron 設定

```bash
# 継続処理システム（5分間隔、平日24時間稼働）
*/5 * * * 1-5 cd /app && export $(cat .env | grep -v '^#' | xargs) && timeout 300 python scripts/cron/continuous_processing_cron.py --mode system_cycle >> /app/logs/continuous_processing_cron.log 2>&1
```

#### 実行モード

- **system_cycle**: システム初期化チェック + 継続処理
- **single_cycle**: 単一サイクル実行
- **health-check-only**: 健全性チェックのみ

---

## 📊 パターン定義

### パターン 1: トレンド転換検出

- **説明**: 強力なトレンド転換シグナル
- **条件**:
  - D1: RSI 30 以下 + MACD 上昇
  - H4: RSI 35 以下 + 価格上昇
  - H1: RSI 40 以下 + ボリンジャーバンド-2σ
  - M5: RSI 45 以下 + 価格形状
- **優先度**: HIGH
- **通知色**: #FF6B6B

### パターン 2: プルバック検出

- **説明**: 押し目買いチャンス
- **条件**:
  - D1: RSI 30-50 + MACD 上昇継続
  - H4: RSI 35-55 + 価格反発
  - H1: RSI 40-60 + ボリンジャーバンド-2σ タッチ
  - M5: RSI 45-65 + 反発サイン
- **優先度**: MEDIUM
- **通知色**: #4ECDC4

### パターン 3: ダイバージェンス検出

- **説明**: ダイバージェンス警戒
- **条件**:
  - D1: 価格新高値 + RSI 前回高値未達
  - H4: 価格上昇 + RSI 下降
  - H1: 価格上昇 + RSI 下降
  - M5: 価格上昇 + RSI 下降
- **優先度**: HIGH
- **通知色**: #FFE66D

### パターン 4: ブレイクアウト検出

- **説明**: ブレイクアウト狙い
- **条件**:
  - D1: RSI 50-70 + MACD 上昇
  - H4: RSI 55-75 + 価格突破
  - H1: RSI 60-80 + ボリンジャーバンド+2σ 突破
  - M5: RSI 65-85 + ブレイクアウト強度
- **優先度**: MEDIUM
- **通知色**: #45B7D1

### パターン 5: RSI 戦い検出

- **説明**: RSI50 ライン攻防
- **条件**:
  - D1: RSI 45-55 + 価格横ばい
  - H4: RSI 48-52 + 価格変動
  - H1: RSI 49-51 + ボリンジャーバンド中央
  - M5: RSI 49.5-50.5 + 価格形状
- **優先度**: LOW
- **通知色**: #96CEB4

### パターン 6: 複合シグナル検出

- **説明**: 複合シグナル強化
- **条件**:
  - D1: RSI + MACD + 価格 3 つ一致
  - H4: RSI + ボリンジャーバンド 2 つ一致
  - H1: RSI + ボリンジャーバンド 2 つ一致
  - M5: RSI + 価格形状 2 つ一致
- **優先度**: HIGH
- **通知色**: #800080

---

## 🛠️ 技術仕様

### データベース設計

#### pattern_detections テーブル

```sql
CREATE TABLE pattern_detections (
    id BIGSERIAL PRIMARY KEY,
    pattern_number INTEGER NOT NULL,
    currency_pair VARCHAR(10) NOT NULL,
    detection_time TIMESTAMP WITH TIME ZONE NOT NULL,
    confidence_score DECIMAL(3,2) NOT NULL,
    direction VARCHAR(10), -- BUY, SELL, HOLD
    timeframe VARCHAR(10), -- 5m, 1h, 4h, 1d
    detection_data JSONB, -- 詳細検出データ
    notification_sent BOOLEAN DEFAULT FALSE,
    notification_time TIMESTAMP WITH TIME ZONE,
    created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);
```

### テクニカル指標仕様

#### RSI (Relative Strength Index)

- **期間**: 14
- **計算式**: 100 - (100 / (1 + RS))
- **RS**: 平均上昇幅 / 平均下降幅

#### MACD (Moving Average Convergence Divergence)

- **短期 EMA**: 12 期間
- **長期 EMA**: 26 期間
- **シグナル**: 9 期間 EMA
- **ヒストグラム**: MACD - シグナル

#### ボリンジャーバンド

- **期間**: 20
- **標準偏差**: 2σ
- **計算式**: SMA ± (2 × 標準偏差)

### パフォーマンス仕様

#### 実行時間制限

- **データ取得**: 300 秒（5 分）
- **指標計算**: 60 秒（1 分）
- **パターン検出**: 120 秒（2 分）
- **通知送信**: 30 秒（30 秒）

#### リトライ設定

- **最大リトライ回数**: 3 回
- **リトライ間隔**: 30 秒
- **連続失敗制限**: 5 回

---

## 🔧 設定・環境変数

### 必須環境変数

```bash
# データベース
DATABASE_URL=postgresql+asyncpg://user:password@localhost/dbname

# Discord通知
DISCORD_WEBHOOK_URL=https://discord.com/api/webhooks/...

# API設定
ALPHA_VANTAGE_API_KEY=your_api_key_here

# システム設定
CURRENCY_PAIR=USD/JPY
PATTERN_DETECTION_INTERVAL=300
NOTIFICATION_COOLDOWN=3600
```

### 設定ファイル

```yaml
# src/infrastructure/config/system_config_manager.py
pattern_detection:
  interval: 300 # 5分
  max_retries: 3
  retry_delay: 30
  confidence_threshold: 0.6
  notification_cooldown: 3600
```

---

## 🧪 テスト仕様

### 単体テスト

```
tests/unit/
├── test_technical_indicators.py       # テクニカル指標テスト
└── test_indicators_extended.py        # 拡張指標テスト
```

### 統合テスト

```
tests/integration/
├── test_notification_integration.py   # 通知統合テスト
├── test_new_pattern_detectors.py      # 新パターン検出器テスト
├── test_notification_patterns.py      # 通知パターンテスト
├── test_continuous_processing_service.py
└── test_pattern5_completion.py        # パターン5完了テスト
```

### テスト実行

```bash
# 全テスト実行
pytest tests/

# 特定テスト実行
pytest tests/integration/test_notification_integration.py

# カバレッジ付き実行
pytest --cov=src tests/
```

---

## 📈 監視・ログ

### ログファイル

```
logs/
├── continuous_processing_cron.log     # 継続処理ログ
├── technical_analysis_cron.log        # テクニカル分析ログ
├── data_cron.log                     # データ取得ログ
├── notification_cron.log              # 通知ログ
└── error_alert.log                   # エラーアラートログ
```

### 監視項目

- **処理時間**: 各段階の実行時間
- **成功率**: パターン検出成功率
- **エラー率**: エラー発生率
- **データ量**: 処理データ量
- **通知数**: 送信通知数

### アラート設定

- **処理時間超過**: 5 分以上
- **成功率低下**: 80%未満
- **連続失敗**: 3 回以上
- **データ不足**: 1 件未満

---

## 🔄 開発・保守

### 新パターン追加手順

1. **パターン検出器作成**: `src/infrastructure/analysis/pattern_detectors/`
2. **通知テンプレート作成**: `src/infrastructure/messaging/templates/`
3. **サービス統合**: `efficient_pattern_detection_service.py`
4. **テスト作成**: `tests/integration/`
5. **ドキュメント更新**: `note/pattern_analysis/`

### デバッグ方法

```bash
# 単一パターン検出テスト
python scripts/test/test_pattern_detection.py

# 統合テスト実行
python scripts/test/test_integrated_scheduler.py

# ログ確認
tail -f logs/continuous_processing_cron.log
```

### パフォーマンス最適化

- **データベースインデックス**: 検索速度向上
- **キャッシュ活用**: 重複計算回避
- **非同期処理**: 並列実行
- **バッチ処理**: 一括処理

---

## 📚 関連ドキュメント

### 設計書

- `note/pattern_analysis/パターン検出案.md` - 基本設計
- `note/pattern_analysis/パターン検出検討案.md` - 詳細検討
- `note/pattern_analysis/パターン検出実装計画書_phase*.yaml` - 実装計画

### 実装状況

- `note/implementation_status/notification_implementation_status_2025.md`
- `note/implementation_status/current_situation_analysis_2025.md`

### API 仕様

- `docs/api/` - API 仕様書
- `docs/database/` - データベース設計書

---

## 🚀 今後の拡張計画

### Phase 1: ローソク足パターン

- パターン 7: つつみ足検出
- パターン 8: 赤三兵検出
- パターン 9: 大陽線/大陰線引け坊主

### Phase 2: チャートパターン

- パターン 10: ダブルトップ/ボトム
- パターン 11: トリプルトップ/ボトム
- パターン 12: フラッグパターン

### Phase 3: 高度なパターン

- パターン 13: 三尊天井/逆三尊
- パターン 14: ウェッジパターン

### Phase 4: ライン分析

- パターン 15: レジスタンス/サポートライン
- パターン 16: ロールリバーサル

---

## 📞 サポート・連絡先

### 開発チーム

- **プロジェクトリーダー**: [担当者名]
- **テクニカルリード**: [担当者名]
- **QA 担当**: [担当者名]

### 緊急時連絡先

- **システム障害**: [連絡先]
- **データ不整合**: [連絡先]
- **通知不具合**: [連絡先]

---

**最終更新日**: 2025 年 1 月
**バージョン**: 1.0.0
**作成者**: [作成者名]
