**旧ファイル名**: `パターン検出実装計画書_phase2.md`  

# パターン検出実装計画書\_phase2 - チャートパターン（パターン 10-12）

## 📋 Phase 2 概要

### 目的

- チャートパターン（パターン 10-12）の実装
- Phase 1 で実装したローソク足パターンに加えて、より高度なチャートパターンを追加
- 各パターン実装後のテスト実行、Git 更新、GitHub 同期の自動化

### 実装期間

- **期間**: 2-3 週間
- **対象パターン**: パターン 10（ダブルトップ/ボトム）、パターン 11（トリプルトップ/ボトム）、パターン 12（フラッグパターン）

### 実装方針

- 段階的実装（パターン 10 → パターン 11 → パターン 12）
- 各パターン実装後の即座テスト実行
- Git コミット・プッシュの自動化
- 既存システムとの統合テスト

---

## 🏗️ パターン 10: ダブルトップ/ボトム検出

### 実装ファイル

- **メインファイル**: `src/infrastructure/analysis/pattern_detectors/double_top_bottom_detector.py`
- **テストファイル**: `tests/unit/test_double_top_bottom_detector.py`
- **統合テスト**: `tests/integration/test_phase2_patterns.py`

### クラス構造

```python
class DoubleTopBottomDetector:
    def __init__(self):
        self.pattern = NotificationPattern.create_pattern_10()
        self.utils = PatternUtils()
        self.min_peak_distance = 5  # ピーク間の最小距離
        self.peak_tolerance = 0.02  # ピークの許容誤差（2%）
        self.neckline_tolerance = 0.01  # ネックラインの許容誤差（1%）

    def detect(self, price_data: pd.DataFrame) -> Optional[Dict[str, Any]]:
        """ダブルトップ/ボトムパターン検出"""
        pass

    def _detect_double_top(self, price_data: pd.DataFrame) -> bool:
        """ダブルトップ検出"""
        pass

    def _detect_double_bottom(self, price_data: pd.DataFrame) -> bool:
        """ダブルボトム検出"""
        pass

    def _find_peaks(self, price_data: pd.DataFrame, window: int = 5) -> List[int]:
        """ピーク検出"""
        pass

    def _validate_neckline(self, price_data: pd.DataFrame, peaks: List[int]) -> bool:
        """ネックライン検証"""
        pass

    def _calculate_pattern_confidence(self, pattern_data: Dict) -> float:
        """パターン信頼度計算"""
        pass
```

### 実装タスク

- [ ] クラス定義とメソッド実装
- [ ] ダブルトップ検出ロジック
- [ ] ダブルボトム検出ロジック
- [ ] ピーク検出アルゴリズム
- [ ] ネックライン検証
- [ ] 信頼度計算アルゴリズム
- [ ] 単体テスト作成
- [ ] 統合テスト実行
- [ ] Git コミット・プッシュ

### パターン特徴

- **ダブルトップ**: 2 つの高値がほぼ同じレベルで形成される売りシグナル
- **ダブルボトム**: 2 つの安値がほぼ同じレベルで形成される買いシグナル
- **信頼度**: 80-85%
- **実装難易度**: 中
- **優先度**: HIGH (80)

---

## 🏗️ パターン 11: トリプルトップ/ボトム検出

### 実装ファイル

- **メインファイル**: `src/infrastructure/analysis/pattern_detectors/triple_top_bottom_detector.py`
- **テストファイル**: `tests/unit/test_triple_top_bottom_detector.py`

### クラス構造

```python
class TripleTopBottomDetector:
    def __init__(self):
        self.pattern = NotificationPattern.create_pattern_11()
        self.utils = PatternUtils()
        self.min_peak_distance = 5  # ピーク間の最小距離
        self.peak_tolerance = 0.015  # ピークの許容誤差（1.5%）
        self.neckline_tolerance = 0.008  # ネックラインの許容誤差（0.8%）

    def detect(self, price_data: pd.DataFrame) -> Optional[Dict[str, Any]]:
        """トリプルトップ/ボトムパターン検出"""
        pass

    def _detect_triple_top(self, price_data: pd.DataFrame) -> bool:
        """トリプルトップ検出"""
        pass

    def _detect_triple_bottom(self, price_data: pd.DataFrame) -> bool:
        """トリプルボトム検出"""
        pass

    def _find_three_peaks(self, price_data: pd.DataFrame, window: int = 5) -> List[int]:
        """3つのピーク検出"""
        pass

    def _validate_triple_pattern(self, price_data: pd.DataFrame, peaks: List[int]) -> bool:
        """トリプルパターン検証"""
        pass

    def _calculate_triple_confidence(self, pattern_data: Dict) -> float:
        """トリプルパターン信頼度計算"""
        pass
```

### 実装タスク

- [ ] クラス定義とメソッド実装
- [ ] トリプルトップ検出ロジック
- [ ] トリプルボトム検出ロジック
- [ ] 3 つのピーク検出アルゴリズム
- [ ] トリプルパターン検証
- [ ] 信頼度計算アルゴリズム
- [ ] 単体テスト作成
- [ ] 統合テスト実行
- [ ] Git コミット・プッシュ

### パターン特徴

- **トリプルトップ**: 3 つの高値がほぼ同じレベルで形成される強力な売りシグナル
- **トリプルボトム**: 3 つの安値がほぼ同じレベルで形成される強力な買いシグナル
- **信頼度**: 85-90%
- **実装難易度**: 中
- **優先度**: HIGH (85)

---

## 🏗️ パターン 12: フラッグパターン検出

### 実装ファイル

- **メインファイル**: `src/infrastructure/analysis/pattern_detectors/flag_pattern_detector.py`
- **テストファイル**: `tests/unit/test_flag_pattern_detector.py`

### クラス構造

```python
class FlagPatternDetector:
    def __init__(self):
        self.pattern = NotificationPattern.create_pattern_12()
        self.utils = PatternUtils()
        self.min_flag_length = 3  # フラッグの最小長さ
        self.max_flag_length = 15  # フラッグの最大長さ
        self.flag_angle_tolerance = 30  # フラッグ角度の許容誤差（度）

    def detect(self, price_data: pd.DataFrame) -> Optional[Dict[str, Any]]:
        """フラッグパターン検出"""
        pass

    def _detect_bull_flag(self, price_data: pd.DataFrame) -> bool:
        """ブルフラッグ検出"""
        pass

    def _detect_bear_flag(self, price_data: pd.DataFrame) -> bool:
        """ベアフラッグ検出"""
        pass

    def _identify_flagpole(self, price_data: pd.DataFrame) -> Dict[str, Any]:
        """フラッグポール識別"""
        pass

    def _identify_flag(self, price_data: pd.DataFrame, pole_end: int) -> Dict[str, Any]:
        """フラッグ識別"""
        pass

    def _validate_flag_breakout(self, price_data: pd.DataFrame, flag_data: Dict) -> bool:
        """フラッグブレイクアウト検証"""
        pass

    def _calculate_flag_confidence(self, pattern_data: Dict) -> float:
        """フラッグパターン信頼度計算"""
        pass
```

### 実装タスク

- [ ] クラス定義とメソッド実装
- [ ] ブルフラッグ検出ロジック
- [ ] ベアフラッグ検出ロジック
- [ ] フラッグポール識別
- [ ] フラッグ識別
- [ ] ブレイクアウト検証
- [ ] 信頼度計算アルゴリズム
- [ ] 単体テスト作成
- [ ] 統合テスト実行
- [ ] Git コミット・プッシュ

### パターン特徴

- **ブルフラッグ**: 上昇トレンド後の一時的な調整（買いシグナル）
- **ベアフラッグ**: 下降トレンド後の一時的な調整（売りシグナル）
- **信頼度**: 75-80%
- **実装難易度**: 高
- **優先度**: MEDIUM (75)

---

## 🔧 共通実装コンポーネント

### 1. パターン定義更新

#### ファイル: `src/domain/entities/notification_pattern.py`

```python
@classmethod
def create_pattern_10(cls) -> "NotificationPattern":
    """パターン10: ダブルトップ/ボトム検出を作成"""
    return cls(
        pattern_number=10,
        name="ダブルトップ/ボトム検出",
        description="2つの高値/安値が同じレベルで形成されるパターン",
        priority=PatternPriority.HIGH,
        conditions={
            "D1": ["ダブルトップ", "ダブルボトム"],
            "H4": ["ダブルトップ", "ダブルボトム"],
            "H1": ["ダブルトップ", "ダブルボトム"],
            "M5": ["ダブルトップ", "ダブルボトム"],
        },
        notification_title="🔄 ダブルトップ/ボトムパターン検出",
        notification_color="0x4ECDC4",
        take_profit="+100pips",
        stop_loss="-50pips",
        confidence="高（80-85%）",
    )

@classmethod
def create_pattern_11(cls) -> "NotificationPattern":
    """パターン11: トリプルトップ/ボトム検出を作成"""
    return cls(
        pattern_number=11,
        name="トリプルトップ/ボトム検出",
        description="3つの高値/安値が同じレベルで形成される強力なパターン",
        priority=PatternPriority.HIGH,
        conditions={
            "D1": ["トリプルトップ", "トリプルボトム"],
            "H4": ["トリプルトップ", "トリプルボトム"],
            "H1": ["トリプルトップ", "トリプルボトム"],
            "M5": ["トリプルトップ", "トリプルボトム"],
        },
        notification_title="🔄 トリプルトップ/ボトムパターン検出",
        notification_color="0xFF6B6B",
        take_profit="+120pips",
        stop_loss="-60pips",
        confidence="高（85-90%）",
    )

@classmethod
def create_pattern_12(cls) -> "NotificationPattern":
    """パターン12: フラッグパターン検出を作成"""
    return cls(
        pattern_number=12,
        name="フラッグパターン検出",
        description="トレンド継続を示すフラッグパターン",
        priority=PatternPriority.MEDIUM,
        conditions={
            "D1": ["ブルフラッグ", "ベアフラッグ"],
            "H4": ["ブルフラッグ", "ベアフラッグ"],
            "H1": ["ブルフラッグ", "ベアフラッグ"],
            "M5": ["ブルフラッグ", "ベアフラッグ"],
        },
        notification_title="🔄 フラッグパターン検出",
        notification_color="0x45B7D1",
        take_profit="+80pips",
        stop_loss="-40pips",
        confidence="中（75-80%）",
    )
```

### 2. 分析エンジン統合

#### ファイル: `src/infrastructure/analysis/notification_pattern_analyzer.py`

```python
from .pattern_detectors.double_top_bottom_detector import DoubleTopBottomDetector
from .pattern_detectors.triple_top_bottom_detector import TripleTopBottomDetector
from .pattern_detectors.flag_pattern_detector import FlagPatternDetector

def __init__(self):
    # 既存の検出器
    self.detectors = {
        # ... 既存の検出器 ...

        # Phase 2 新規検出器
        "DoubleTopBottomDetector": DoubleTopBottomDetector(),
        "TripleTopBottomDetector": TripleTopBottomDetector(),
        "FlagPatternDetector": FlagPatternDetector(),
    }

    # パターン定義
    self.patterns = {
        # ... 既存のパターン ...

        # Phase 2 新規パターン
        10: NotificationPattern.create_pattern_10(),
        11: NotificationPattern.create_pattern_11(),
        12: NotificationPattern.create_pattern_12(),
    }
```

### 3. モジュール初期化更新

#### ファイル: `src/infrastructure/analysis/pattern_detectors/__init__.py`

```python
"""
パターン検出器モジュール

12個のパターン検出器を提供
"""

from .double_top_bottom_detector import DoubleTopBottomDetector
from .triple_top_bottom_detector import TripleTopBottomDetector
from .flag_pattern_detector import FlagPatternDetector

__all__ = [
    # 既存の検出器
    "EngulfingPatternDetector",
    "RedThreeSoldiersDetector",
    "MarubozuDetector",

    # Phase 2 新規検出器
    "DoubleTopBottomDetector",
    "TripleTopBottomDetector",
    "FlagPatternDetector",
]
```

---

## 🧪 テスト戦略

### 単体テスト

#### ダブルトップ/ボトム検出器テスト

- ダブルトップ検出テスト
- ダブルボトム検出テスト
- ピーク検出アルゴリズムテスト
- ネックライン検証テスト
- 信頼度計算テスト
- エッジケーステスト

#### トリプルトップ/ボトム検出器テスト

- トリプルトップ検出テスト
- トリプルボトム検出テスト
- 3 つのピーク検出テスト
- トリプルパターン検証テスト
- 信頼度計算テスト
- エッジケーステスト

#### フラッグパターン検出器テスト

- ブルフラッグ検出テスト
- ベアフラッグ検出テスト
- フラッグポール識別テスト
- フラッグ識別テスト
- ブレイクアウト検証テスト
- 信頼度計算テスト

### 統合テスト

#### Phase 2 統合テスト

- 全パターンの統合テスト
- 検出器の状態確認
- エラーハンドリング
- パフォーマンステスト

---

## 🚀 自動化スクリプト

### 1. Phase 2 自動化スクリプト

#### ファイル: `scripts/run_phase2.py`

```python
PHASE2_PATTERNS = [10, 11, 12]

PATTERN_INFO = {
    10: {
        "name": "ダブルトップ/ボトム検出",
        "detector_file": "src/infrastructure/analysis/pattern_detectors/double_top_bottom_detector.py",
        "test_file": "tests/unit/test_double_top_bottom_detector.py",
        "class_name": "DoubleTopBottomDetector"
    },
    11: {
        "name": "トリプルトップ/ボトム検出",
        "detector_file": "src/infrastructure/analysis/pattern_detectors/triple_top_bottom_detector.py",
        "test_file": "tests/unit/test_triple_top_bottom_detector.py",
        "class_name": "TripleTopBottomDetector"
    },
    12: {
        "name": "フラッグパターン検出",
        "detector_file": "src/infrastructure/analysis/pattern_detectors/flag_pattern_detector.py",
        "test_file": "tests/unit/test_flag_pattern_detector.py",
        "class_name": "FlagPatternDetector"
    }
}

def run_phase2():
    """Phase 2 実行"""
    for pattern in PHASE2_PATTERNS:
        implement_phase2_pattern(pattern)
    run_phase2_integration_test()
```

---

## 📊 実装スケジュール

### Week 1

- パターン 10 実装（ダブルトップ/ボトム検出）
- パターン 11 実装（トリプルトップ/ボトム検出）
- 各パターンの単体テスト

### Week 2

- パターン 12 実装（フラッグパターン検出）
- Phase 2 統合テスト
- 既存システムとの統合テスト

### Week 3

- パフォーマンス最適化
- ドキュメント更新
- 運用環境での検証

---

## 🎯 成功指標

### 技術指標

- **単体テスト通過率**: 100%
- **統合テスト通過率**: 100%
- **コードカバレッジ**: 90%以上
- **性能劣化**: 既存システムの 5%以内

### 品質指標

- **バグ率**: 1%以下
- **コードレビュー通過率**: 100%
- **ドキュメント完成度**: 100%

### 運用指標

- **通知精度向上**: 既存比 20%向上
- **システム安定性**: 99.9%稼働率維持
- **開発効率**: 自動化により 70%向上

---

## ⚠️ リスク管理

### 技術リスク

- **複雑性**: チャートパターン検出の複雑性
  - **対策**: 段階的実装と十分なテスト
- **性能影響**: 複雑なパターン検出による性能劣化
  - **対策**: 効率的なアルゴリズム実装

### 運用リスク

- **偽シグナル**: チャートパターンによる偽シグナル
  - **対策**: 信頼度閾値の調整と複数条件の組み合わせ
- **検出遅延**: 複雑なパターンによる検出遅延
  - **対策**: 最適化されたアルゴリズム

---

## 📝 次のステップ

1. **Phase 2 開始**: チャートパターンの実装開始
2. **自動化スクリプト準備**: Phase 2 用自動化スクリプト作成
3. **テスト環境構築**: 新パターンの検証環境準備
4. **監視システム強化**: パフォーマンス監視の強化
5. **ドキュメント更新**: 実装状況の継続的更新
6. **Phase 3 準備**: 高度なパターン実装の準備

---

**作成日**: 2025 年 8 月 11 日
**作成者**: AI Assistant
**ステータス**: 📋 **計画中**
