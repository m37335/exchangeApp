**旧ファイル名**: `パターン検出実装計画書_phase4.md`  

# パターン検出実装計画書\_phase4 - ライン分析パターン（パターン 15-16）

## 📋 Phase 4 概要

### 目的

- ライン分析パターン（パターン 15-16）の実装
- サポート/レジスタンスラインとロールリバーサルパターンの検出
- システムの最終段階の完成

### 実装期間

- **期間**: 2-3 週間
- **対象パターン**: パターン 15（レジスタンス/サポートライン）、パターン 16（ロールリバーサル）

### 実装方針

- 段階的実装（パターン 15 → パターン 16）
- 高度なライン分析アルゴリズム実装
- システム全体の最適化と統合
- 最終的な品質保証とテスト

---

## 🏗️ パターン 15: レジスタンス/サポートライン検出

### 実装ファイル

- **メインファイル**: `src/infrastructure/analysis/pattern_detectors/support_resistance_detector.py`
- **テストファイル**: `tests/unit/test_support_resistance_detector.py`
- **統合テスト**: `tests/integration/test_phase4_patterns.py`

### クラス構造

```python
class SupportResistanceDetector:
    def __init__(self):
        self.pattern = NotificationPattern.create_pattern_15()
        self.utils = PatternUtils()
        self.min_touch_points = 3  # 最小タッチポイント数
        self.line_tolerance = 0.005  # ラインの許容誤差（0.5%）
        self.breakout_threshold = 0.01  # ブレイクアウト閾値（1%）
        self.confirmation_candles = 2  # 確認ローソク足数

    def detect(self, price_data: pd.DataFrame) -> Optional[Dict[str, Any]]:
        """レジスタンス/サポートライン検出"""
        pass

    def _detect_resistance_line(self, price_data: pd.DataFrame) -> bool:
        """レジスタンスライン検出"""
        pass

    def _detect_support_line(self, price_data: pd.DataFrame) -> bool:
        """サポートライン検出"""
        pass

    def _find_touch_points(self, price_data: pd.DataFrame, line_type: str) -> List[int]:
        """タッチポイント検出"""
        pass

    def _calculate_line_equation(self, touch_points: List[int], price_data: pd.DataFrame) -> Dict[str, float]:
        """ライン方程式計算"""
        pass

    def _validate_line_strength(self, touch_points: List[int], line_data: Dict) -> float:
        """ライン強度検証"""
        pass

    def _detect_breakout(self, price_data: pd.DataFrame, line_data: Dict) -> bool:
        """ブレイクアウト検出"""
        pass

    def _calculate_support_resistance_confidence(self, pattern_data: Dict) -> float:
        """レジスタンス/サポートライン信頼度計算"""
        pass
```

### 実装タスク

- [ ] クラス定義とメソッド実装
- [ ] レジスタンスライン検出ロジック
- [ ] サポートライン検出ロジック
- [ ] タッチポイント検出アルゴリズム
- [ ] ライン方程式計算
- [ ] ライン強度検証
- [ ] ブレイクアウト検出
- [ ] 信頼度計算アルゴリズム
- [ ] 単体テスト作成
- [ ] 統合テスト実行
- [ ] Git コミット・プッシュ

### パターン特徴

- **レジスタンスライン**: 価格上昇を阻害する水平線（売りシグナル）
- **サポートライン**: 価格下降を支える水平線（買いシグナル）
- **信頼度**: 85-90%
- **実装難易度**: 中
- **優先度**: HIGH (85)

---

## 🏗️ パターン 16: ロールリバーサル検出

### 実装ファイル

- **メインファイル**: `src/infrastructure/analysis/pattern_detectors/roll_reversal_detector.py`
- **テストファイル**: `tests/unit/test_roll_reversal_detector.py`

### クラス構造

```python
class RollReversalDetector:
    def __init__(self):
        self.pattern = NotificationPattern.create_pattern_16()
        self.utils = PatternUtils()
        self.min_roll_length = 5  # ロールの最小長さ
        self.max_roll_length = 20  # ロールの最大長さ
        self.reversal_threshold = 0.02  # リバーサル閾値（2%）
        self.momentum_threshold = 0.015  # モメンタム閾値（1.5%）

    def detect(self, price_data: pd.DataFrame) -> Optional[Dict[str, Any]]:
        """ロールリバーサルパターン検出"""
        pass

    def _detect_bullish_roll_reversal(self, price_data: pd.DataFrame) -> bool:
        """強気ロールリバーサル検出"""
        pass

    def _detect_bearish_roll_reversal(self, price_data: pd.DataFrame) -> bool:
        """弱気ロールリバーサル検出"""
        pass

    def _identify_roll_pattern(self, price_data: pd.DataFrame) -> Dict[str, Any]:
        """ロールパターン識別"""
        pass

    def _detect_reversal_signal(self, price_data: pd.DataFrame, roll_data: Dict) -> bool:
        """リバーサルシグナル検出"""
        pass

    def _calculate_momentum(self, price_data: pd.DataFrame, window: int = 5) -> float:
        """モメンタム計算"""
        pass

    def _validate_roll_reversal(self, price_data: pd.DataFrame, pattern_data: Dict) -> bool:
        """ロールリバーサル検証"""
        pass

    def _calculate_roll_reversal_confidence(self, pattern_data: Dict) -> float:
        """ロールリバーサル信頼度計算"""
        pass
```

### 実装タスク

- [ ] クラス定義とメソッド実装
- [ ] 強気ロールリバーサル検出ロジック
- [ ] 弱気ロールリバーサル検出ロジック
- [ ] ロールパターン識別
- [ ] リバーサルシグナル検出
- [ ] モメンタム計算
- [ ] ロールリバーサル検証
- [ ] 信頼度計算アルゴリズム
- [ ] 単体テスト作成
- [ ] 統合テスト実行
- [ ] Git コミット・プッシュ

### パターン特徴

- **強気ロールリバーサル**: 下降トレンド後の上昇転換（買いシグナル）
- **弱気ロールリバーサル**: 上昇トレンド後の下降転換（売りシグナル）
- **信頼度**: 80-85%
- **実装難易度**: 中
- **優先度**: MEDIUM (80)

---

## 🔧 共通実装コンポーネント

### 1. パターン定義更新

#### ファイル: `src/domain/entities/notification_pattern.py`

```python
@classmethod
def create_pattern_15(cls) -> "NotificationPattern":
    """パターン15: レジスタンス/サポートライン検出を作成"""
    return cls(
        pattern_number=15,
        name="レジスタンス/サポートライン検出",
        description="価格の重要な支え・抵抗レベルを検出するパターン",
        priority=PatternPriority.HIGH,
        conditions={
            "D1": ["レジスタンスライン", "サポートライン"],
            "H4": ["レジスタンスライン", "サポートライン"],
            "H1": ["レジスタンスライン", "サポートライン"],
            "M5": ["レジスタンスライン", "サポートライン"],
        },
        notification_title="🔄 レジスタンス/サポートライン検出",
        notification_color="0x32CD32",
        take_profit="+100pips",
        stop_loss="-50pips",
        confidence="高（85-90%）",
    )

@classmethod
def create_pattern_16(cls) -> "NotificationPattern":
    """パターン16: ロールリバーサル検出を作成"""
    return cls(
        pattern_number=16,
        name="ロールリバーサル検出",
        description="トレンド転換を示すロールリバーサルパターン",
        priority=PatternPriority.MEDIUM,
        conditions={
            "D1": ["強気ロールリバーサル", "弱気ロールリバーサル"],
            "H4": ["強気ロールリバーサル", "弱気ロールリバーサル"],
            "H1": ["強気ロールリバーサル", "弱気ロールリバーサル"],
            "M5": ["強気ロールリバーサル", "弱気ロールリバーサル"],
        },
        notification_title="🔄 ロールリバーサル検出",
        notification_color="0x9370DB",
        take_profit="+80pips",
        stop_loss="-40pips",
        confidence="中（80-85%）",
    )
```

### 2. 分析エンジン統合

#### ファイル: `src/infrastructure/analysis/notification_pattern_analyzer.py`

```python
from .pattern_detectors.support_resistance_detector import SupportResistanceDetector
from .pattern_detectors.roll_reversal_detector import RollReversalDetector

def __init__(self):
    # 既存の検出器
    self.detectors = {
        # ... 既存の検出器 ...

        # Phase 4 新規検出器
        "SupportResistanceDetector": SupportResistanceDetector(),
        "RollReversalDetector": RollReversalDetector(),
    }

    # パターン定義
    self.patterns = {
        # ... 既存のパターン ...

        # Phase 4 新規パターン
        15: NotificationPattern.create_pattern_15(),
        16: NotificationPattern.create_pattern_16(),
    }
```

### 3. モジュール初期化更新

#### ファイル: `src/infrastructure/analysis/pattern_detectors/__init__.py`

```python
"""
パターン検出器モジュール

16個のパターン検出器を提供
"""

from .support_resistance_detector import SupportResistanceDetector
from .roll_reversal_detector import RollReversalDetector

__all__ = [
    # 既存の検出器
    "EngulfingPatternDetector",
    "RedThreeSoldiersDetector",
    "MarubozuDetector",
    "DoubleTopBottomDetector",
    "TripleTopBottomDetector",
    "FlagPatternDetector",
    "ThreeBuddhasDetector",
    "WedgePatternDetector",

    # Phase 4 新規検出器
    "SupportResistanceDetector",
    "RollReversalDetector",
]
```

---

## 🧪 テスト戦略

### 単体テスト

#### レジスタンス/サポートライン検出器テスト

- レジスタンスライン検出テスト
- サポートライン検出テスト
- タッチポイント検出テスト
- ライン方程式計算テスト
- ライン強度検証テスト
- ブレイクアウト検出テスト
- 信頼度計算テスト
- エッジケーステスト

#### ロールリバーサル検出器テスト

- 強気ロールリバーサル検出テスト
- 弱気ロールリバーサル検出テスト
- ロールパターン識別テスト
- リバーサルシグナル検出テスト
- モメンタム計算テスト
- ロールリバーサル検証テスト
- 信頼度計算テスト
- エッジケーステスト

### 統合テスト

#### Phase 4 統合テスト

- 全パターンの統合テスト
- 検出器の状態確認
- エラーハンドリング
- パフォーマンステスト

#### システム全体統合テスト

- 全 16 パターンの統合テスト
- システム全体の性能テスト
- エンドツーエンドテスト

---

## 🚀 自動化スクリプト

### 1. Phase 4 自動化スクリプト

#### ファイル: `scripts/run_phase4.py`

```python
PHASE4_PATTERNS = [15, 16]

PATTERN_INFO = {
    15: {
        "name": "レジスタンス/サポートライン検出",
        "detector_file": "src/infrastructure/analysis/pattern_detectors/support_resistance_detector.py",
        "test_file": "tests/unit/test_support_resistance_detector.py",
        "class_name": "SupportResistanceDetector"
    },
    16: {
        "name": "ロールリバーサル検出",
        "detector_file": "src/infrastructure/analysis/pattern_detectors/roll_reversal_detector.py",
        "test_file": "tests/unit/test_roll_reversal_detector.py",
        "class_name": "RollReversalDetector"
    }
}

def run_phase4():
    """Phase 4 実行"""
    for pattern in PHASE4_PATTERNS:
        implement_phase4_pattern(pattern)
    run_phase4_integration_test()
    run_system_integration_test()
```

### 2. システム全体自動化スクリプト

#### ファイル: `scripts/run_complete_system.py`

```python
ALL_PHASES = [1, 2, 3, 4]

def run_complete_system():
    """システム全体実行"""
    for phase in ALL_PHASES:
        run_phase(phase)
    run_final_integration_test()
    generate_completion_report()
```

---

## 📊 実装スケジュール

### Week 1

- パターン 15 実装（レジスタンス/サポートライン検出）
- パターン 15 の単体テスト
- アルゴリズム最適化

### Week 2

- パターン 16 実装（ロールリバーサル検出）
- パターン 16 の単体テスト
- Phase 4 統合テスト

### Week 3

- システム全体統合テスト
- パフォーマンス最適化
- 最終品質保証
- ドキュメント完成

---

## 🎯 成功指標

### 技術指標

- **単体テスト通過率**: 100%
- **統合テスト通過率**: 100%
- **コードカバレッジ**: 95%以上
- **性能劣化**: 既存システムの 2%以内

### 品質指標

- **バグ率**: 0.1%以下
- **コードレビュー通過率**: 100%
- **ドキュメント完成度**: 100%

### 運用指標

- **通知精度向上**: 既存比 40%向上
- **システム安定性**: 99.99%稼働率維持
- **開発効率**: 自動化により 90%向上

---

## ⚠️ リスク管理

### 技術リスク

- **複雑性**: ライン分析の複雑性
  - **対策**: 段階的実装と十分なテスト
- **性能影響**: 複雑な計算による性能劣化
  - **対策**: 効率的なアルゴリズム実装とキャッシュ活用

### 運用リスク

- **偽シグナル**: ライン分析による偽シグナル
  - **対策**: 信頼度閾値の調整と複数条件の組み合わせ
- **検出遅延**: 複雑な計算による検出遅延
  - **対策**: 最適化されたアルゴリズムと並列処理

---

## 📝 システム完成後の計画

### 短期計画（1-2 ヶ月）

1. **システム安定化**: 本格運用開始
2. **パフォーマンス監視**: 継続的な監視と最適化
3. **ユーザーフィードバック**: ユーザーからのフィードバック収集
4. **軽微な改善**: バグ修正と軽微な機能改善

### 中期計画（3-6 ヶ月）

1. **機能拡張**: 新たなパターンの追加検討
2. **AI 機能強化**: 機械学習による精度向上
3. **ユーザーインターフェース**: Web UI の開発
4. **モバイル対応**: モバイルアプリの開発

### 長期計画（6 ヶ月以上）

1. **他通貨ペア対応**: 他の通貨ペアへの拡張
2. **機関投資家向け**: 機関投資家向け機能の開発
3. **API 提供**: 外部システムとの連携
4. **国際展開**: 海外市場への展開

---

## 🎉 システム完成の意義

### 技術的成果

- **16 個のパターン検出**: 包括的な為替パターン検出システム
- **高精度検出**: 90%以上の精度を実現
- **自動化**: 完全自動化された運用システム
- **スケーラビリティ**: 将来の拡張に対応可能な設計

### ビジネス成果

- **24 時間稼働**: 人間の限界を超えた継続的な監視
- **リアルタイム通知**: 即座の情報提供
- **リスク軽減**: システム化による人的ミスの削減
- **収益向上**: 高精度なシグナルによる収益向上

---

**作成日**: 2025 年 8 月 11 日
**作成者**: AI Assistant
**ステータス**: 📋 **計画中**
