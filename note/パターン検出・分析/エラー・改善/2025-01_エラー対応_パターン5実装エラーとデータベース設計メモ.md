# パターン 5 実装エラーとデータベース設計メモ

**旧ファイル名**: `パターン5実装エラーとデータベース設計メモ.md`

## 実装中に発生したエラーと解決策

### 1. データ構造の不一致エラー

**エラー内容**: モックデータの構造と検出器が期待するデータ構造が一致しない

**具体的な問題**:

- H4 条件: ボリンジャーバンドの`middle`キーが存在しない
- H1 条件: 価格変動計算で`calculate_volatility`メソッドの結果と期待値が異なる

**解決策**:

```python
# ボリンジャーバンドにmiddleキーを追加
bb["middle"] = bb_middle

# 価格変動計算ロジックを修正
price_changes = []
for i in range(1, len(price_list)):
    if price_list[i-1] > 0:
        change = (price_list[i] - price_list[i-1]) / price_list[i-1]
        price_changes.append(change)
```

### 2. メソッド未定義エラー

**エラー内容**: `'PatternUtils' object has no attribute 'get_current_time'`

**解決策**:

```python
# RSIBattleDetectorで直接datetimeを使用
from datetime import datetime
current_time = datetime.now().isoformat()
```

### 3. 条件判定の閾値問題

**エラー内容**:

- H4 条件: 価格-BB ミドル差が 0.038000 で閾値 0.001 を大幅に超過
- H1 条件: 変動性計算で期待値と実際の値が異なる

**解決策**:

- モックデータの価格を BB ミドルの ±0.0001%以内に調整
- 変動性計算ロジックを統一（価格変化率の標準偏差を使用）

## 5 分おき為替データ取得時のデータベース設計

### 必要なデータ構造

#### 1. 基本価格データ（5 分間隔）

```sql
-- 価格テーブル
CREATE TABLE price_data (
    id BIGINT PRIMARY KEY AUTO_INCREMENT,
    currency_pair VARCHAR(10) NOT NULL,  -- USD/JPY, EUR/USD等
    timestamp DATETIME NOT NULL,         -- 5分間隔のタイムスタンプ
    open_price DECIMAL(10,5) NOT NULL,
    high_price DECIMAL(10,5) NOT NULL,
    low_price DECIMAL(10,5) NOT NULL,
    close_price DECIMAL(10,5) NOT NULL,
    volume BIGINT,                       -- 取引量（利用可能な場合）
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    INDEX idx_currency_timestamp (currency_pair, timestamp)
);
```

#### 2. 技術指標データ

```sql
-- RSIテーブル
CREATE TABLE rsi_data (
    id BIGINT PRIMARY KEY AUTO_INCREMENT,
    currency_pair VARCHAR(10) NOT NULL,
    timestamp DATETIME NOT NULL,
    rsi_value DECIMAL(5,2) NOT NULL,     -- RSI値（0-100）
    period INT DEFAULT 14,               -- RSI期間
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    INDEX idx_currency_timestamp (currency_pair, timestamp)
);

-- MACDテーブル
CREATE TABLE macd_data (
    id BIGINT PRIMARY KEY AUTO_INCREMENT,
    currency_pair VARCHAR(10) NOT NULL,
    timestamp DATETIME NOT NULL,
    macd_line DECIMAL(10,6) NOT NULL,    -- MACDライン
    signal_line DECIMAL(10,6) NOT NULL,  -- シグナルライン
    histogram DECIMAL(10,6) NOT NULL,    -- ヒストグラム
    fast_period INT DEFAULT 12,
    slow_period INT DEFAULT 26,
    signal_period INT DEFAULT 9,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    INDEX idx_currency_timestamp (currency_pair, timestamp)
);

-- ボリンジャーバンドテーブル
CREATE TABLE bollinger_bands_data (
    id BIGINT PRIMARY KEY AUTO_INCREMENT,
    currency_pair VARCHAR(10) NOT NULL,
    timestamp DATETIME NOT NULL,
    upper_band DECIMAL(10,5) NOT NULL,   -- 上限バンド
    middle_band DECIMAL(10,5) NOT NULL,  -- ミドルバンド（SMA）
    lower_band DECIMAL(10,5) NOT NULL,   -- 下限バンド
    period INT DEFAULT 20,
    std_dev DECIMAL(3,1) DEFAULT 2.0,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    INDEX idx_currency_timestamp (currency_pair, timestamp)
);
```

#### 3. パターン検出結果テーブル

```sql
-- パターン検出結果テーブル
CREATE TABLE pattern_detections (
    id BIGINT PRIMARY KEY AUTO_INCREMENT,
    currency_pair VARCHAR(10) NOT NULL,
    pattern_number INT NOT NULL,         -- パターン番号（1-6）
    pattern_name VARCHAR(100) NOT NULL,  -- パターン名
    priority INT NOT NULL,               -- 優先度（10-100）
    confidence_score DECIMAL(3,2) NOT NULL, -- 信頼度スコア（0-1）
    detection_time DATETIME NOT NULL,    -- 検出時刻
    notification_title VARCHAR(200),     -- 通知タイトル
    notification_color VARCHAR(10),      -- 通知色
    strategy TEXT,                       -- 戦略
    entry_condition TEXT,                -- エントリー条件
    description TEXT,                    -- 説明
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    INDEX idx_currency_pattern (currency_pair, pattern_number),
    INDEX idx_detection_time (detection_time)
);

-- パターン詳細分析テーブル
CREATE TABLE pattern_analysis (
    id BIGINT PRIMARY KEY AUTO_INCREMENT,
    pattern_detection_id BIGINT NOT NULL,
    timeframe VARCHAR(3) NOT NULL,       -- D1, H4, H1, M5
    analysis_data JSON NOT NULL,         -- 分析データ（JSON形式）
    condition_met BOOLEAN NOT NULL,      -- 条件達成フラグ
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    FOREIGN KEY (pattern_detection_id) REFERENCES pattern_detections(id),
    INDEX idx_pattern_timeframe (pattern_detection_id, timeframe)
);
```

### データ取得・蓄積の考慮事項

#### 1. データ品質管理

- **欠損データの処理**: 5 分間隔で取得できない場合の補完方法
- **異常値の検出**: 極端な価格変動の検出と処理
- **データ整合性**: 各指標の計算に必要な最小データ数の確保

#### 2. パフォーマンス最適化

- **インデックス設計**: 頻繁にクエリされる項目へのインデックス
- **パーティショニング**: 日付ベースのテーブルパーティショニング
- **データ保持期間**: 古いデータの削除・アーカイブ戦略

#### 3. リアルタイム処理

- **ストリーミング処理**: 5 分おきのデータ更新をリアルタイムで処理
- **バッチ処理**: 大量データの一括処理
- **キャッシュ戦略**: 頻繁にアクセスされるデータのキャッシュ

### 実装時の注意点

#### 1. データ形式の統一

- 価格データ: 小数点以下 5 桁まで保持
- 指標データ: 適切な精度での保存
- タイムスタンプ: UTC 統一

#### 2. エラーハンドリング

- データ取得失敗時の再試行ロジック
- データベース接続エラーの処理
- 計算エラーのログ記録

#### 3. スケーラビリティ

- 複数通貨ペアの同時処理
- 将来的な指標追加への対応
- データ量増加への対応

### 参考実装パターン

#### 1. データ取得サービス

```python
class ForexDataCollector:
    def collect_5min_data(self, currency_pair: str):
        # 5分おきのデータ取得
        pass

    def calculate_indicators(self, price_data):
        # 技術指標の計算
        pass

    def store_data(self, data):
        # データベースへの保存
        pass
```

#### 2. パターン検出サービス

```python
class PatternDetectionService:
    def detect_patterns(self, currency_pair: str):
        # マルチタイムフレームデータの取得
        # パターン検出の実行
        # 結果の保存
        pass
```

このメモを参考に、5 分おきの為替データ取得システムを構築する際は、データの整合性とパフォーマンスを重視した設計を行うことが重要です。
