# CLI データベース初期化システム実装計画書 - Phase 3: 差分更新処理

## 📋 概要

### 目的

- 基盤データを基準とした差分更新システムの実装
- 基盤データ復元機能の実装
- 差分データ更新機能の実装とテスト

### 期間

**2-3 日**

### 基本方針

- **基盤データ活用**: Phase 2 で取得したデータを基盤として活用
- **差分更新**: 基盤データ以降の差分データのみを取得
- **効率性**: API 制限を考慮した最適な差分データ取得
- **データ品質**: 差分データの検証と品質保証

## 🎯 Phase 3 の目標

### 主要成果物

1. **基盤データ復元機能**

   - 基盤データバックアップからの復元
   - 復元結果の検証
   - エラーハンドリング

2. **差分データ更新機能**

   - 差分期間の計算
   - 差分データの取得
   - 重複チェックと更新

3. **差分更新テストシステム**
   - 差分データの正確性テスト
   - 統合テスト
   - パフォーマンステスト

## 📋 詳細タスク

### タスク 3.1: 基盤データ復元実装

**担当**: 開発者
**期間**: 1 日
**優先度**: 高

#### 詳細タスク

**3.1.1 ファイル作成**

- [ ] `scripts/cron/base_data_restorer.py`の作成
- [ ] 必要なインポート文の追加
- [ ] 基本クラス構造の定義

**3.1.2 BaseDataRestorer クラスの実装**

- [ ] `__init__()`メソッドの実装
  - [ ] 基盤データパスの設定
  - [ ] 現在のデータベースパスの設定
  - [ ] セッション管理の初期化
- [ ] `restore_base_data()`メソッドの実装
  - [ ] バックアップファイルの存在確認
  - [ ] 現在のデータベースのバックアップ
  - [ ] 基盤データの復元
  - [ ] 復元結果の確認
- [ ] `_backup_current_database()`メソッドの実装
  - [ ] 現在のデータベースの存在確認
  - [ ] タイムスタンプ付きバックアップの作成
  - [ ] バックアップ結果の通知
- [ ] `_restore_from_backup()`メソッドの実装
  - [ ] 基盤データの復元処理
  - [ ] 復元結果の通知
- [ ] `_verify_restoration()`メソッドの実装
  - [ ] データベース接続の確認
  - [ ] データ件数の確認
  - [ ] 各時間足の件数確認
  - [ ] 復元結果のレポート生成
- [ ] `_get_data_counts()`メソッドの実装
  - [ ] 各時間足のデータ件数取得
  - [ ] データソース別の件数集計

**3.1.3 エラーハンドリングの実装**

- [ ] バックアップファイル不存在エラーの処理
- [ ] 復元処理エラーの処理
- [ ] データベース接続エラーの処理
- [ ] ユーザーフレンドリーなエラーメッセージ

**3.1.4 CLI コマンドとの連携実装**

- [ ] `restore`コマンドの実装
  - [ ] コマンド定義
  - [ ] オプション設定
  - [ ] BaseDataRestorer の呼び出し
- [ ] オプション機能の実装
  - [ ] カスタムバックアップパスの指定
  - [ ] 復元確認のスキップ
- [ ] 進捗表示の実装
  - [ ] 復元進捗の表示
  - [ ] 結果レポートの表示
  - [ ] エラー情報の表示

#### 成果物

- `scripts/cron/base_data_restorer.py`
- 更新された CLI コマンド
- エラーハンドリング機能

#### 受け入れ基準

- [ ] 基盤データの正常な復元
- [ ] 復元結果の正確な確認
- [ ] エラー時の適切な処理
- [ ] CLI コマンドからの正常な実行

### タスク 3.2: 差分データ更新実装

**担当**: 開発者
**期間**: 1 日
**優先度**: 高

#### 詳細タスク

**3.2.1 ファイル作成**

- [ ] `scripts/cron/differential_updater.py`の作成
- [ ] 必要なインポート文の追加
- [ ] 基本クラス構造の定義

**3.2.2 DifferentialUpdater クラスの実装**

- [ ] `__init__()`メソッドの実装
  - [ ] 通貨ペアの設定
  - [ ] セッション管理の初期化
  - [ ] リポジトリの初期化
  - [ ] Yahoo Finance クライアントの初期化
  - [ ] 基盤データの最終更新日時の設定
- [ ] `update_all_timeframes()`メソッドの実装
  - [ ] 全時間足の差分更新実行
  - [ ] 各時間足の結果集計
  - [ ] 進捗表示
- [ ] `update_timeframe()`メソッドの実装
  - [ ] 特定時間足の差分更新
  - [ ] 差分期間の計算
  - [ ] 差分データの取得
  - [ ] 結果の返却
- [ ] `_calculate_differential_period()`メソッドの実装
  - [ ] データベース内の最新タイムスタンプ取得
  - [ ] 差分期間の計算
  - [ ] 差分存在チェック
- [ ] `_get_latest_timestamp()`メソッドの実装
  - [ ] 特定時間足の最新タイムスタンプ取得
  - [ ] SQLAlchemy クエリの実行
  - [ ] 結果の返却
- [ ] `_fetch_differential_data()`メソッドの実装
  - [ ] Yahoo Finance API からのデータ取得
  - [ ] データの前処理
  - [ ] データベースへの保存
- [ ] `_save_dataframe_to_db()`メソッドの実装
  - [ ] DataFrame のデータベース保存
  - [ ] 重複チェック
  - [ ] エラーハンドリング
- [ ] `initialize()`メソッドの実装
  - [ ] セッションの初期化
  - [ ] リポジトリの初期化
  - [ ] 接続確認
- [ ] `cleanup()`メソッドの実装
  - [ ] セッションのクローズ
  - [ ] リソースのクリーンアップ

**3.2.3 差分期間計算ロジックの実装**

- [ ] 各時間足の差分期間計算
  - [ ] 5 分足: 最新タイムスタンプ + 5 分 ～ 現在
  - [ ] 1 時間足: 最新タイムスタンプ + 1 時間 ～ 現在
  - [ ] 4 時間足: 最新タイムスタンプ + 4 時間 ～ 現在
  - [ ] 日足: 最新タイムスタンプ + 1 日 ～ 現在
- [ ] 差分存在チェックロジック
- [ ] エッジケースの処理

**3.2.4 データ取得と保存の実装**

- [ ] Yahoo Finance API からの差分データ取得
- [ ] データの前処理と検証
- [ ] データベースへの保存
- [ ] 重複チェック機能
- [ ] エラーハンドリング

**3.2.5 CLI コマンドとの連携実装**

- [ ] `update`コマンドの実装
  - [ ] コマンド定義
  - [ ] オプション設定
  - [ ] DifferentialUpdater の呼び出し
- [ ] オプション機能の実装
  - [ ] 特定時間足の更新
  - [ ] 全時間足の更新
  - [ ] 差分期間の指定
- [ ] 進捗表示の実装
  - [ ] 更新進捗の表示
  - [ ] 結果レポートの表示
  - [ ] エラー情報の表示

#### 成果物

- `scripts/cron/differential_updater.py`
- 更新された CLI コマンド
- 差分更新機能

#### 受け入れ基準

- [ ] 差分期間の正確な計算
- [ ] 差分データの正常な取得
- [ ] 重複データの適切な処理
- [ ] CLI コマンドからの正常な実行

### タスク 3.3: 差分更新テスト

**担当**: 開発者
**期間**: 0.5 日
**優先度**: 中

#### 詳細タスク

**3.3.1 基盤データ復元の単体テスト**

- [ ] バックアップファイル存在確認のテスト
- [ ] 復元処理のテスト
- [ ] 復元結果確認のテスト
- [ ] エラーハンドリングのテスト

**3.3.2 差分データ更新の単体テスト**

- [ ] 差分期間計算のテスト
- [ ] 最新タイムスタンプ取得のテスト
- [ ] 差分データ取得のテスト
- [ ] データ保存のテスト

**3.3.3 統合テスト**

- [ ] 基盤データ復元 → 差分更新の統合テスト
- [ ] データフローの検証
- [ ] データの整合性確認
- [ ] エラー伝播のテスト

**3.3.4 差分データの正確性テスト**

- [ ] 差分データの正確性確認
- [ ] データの連続性確認
- [ ] 重複データの確認
- [ ] データ品質の確認

**3.3.5 パフォーマンステスト**

- [ ] 差分更新の処理時間測定
- [ ] メモリ使用量の測定
- [ ] API 呼び出し回数の確認
- [ ] ボトルネックの特定

#### 成果物

- テスト結果レポート
- バグ修正（必要に応じて）
- パフォーマンス改善（必要に応じて）

#### 受け入れ基準

- [ ] 全テストケースが成功
- [ ] 差分データの正確性が確認される
- [ ] パフォーマンス要件を満たす
- [ ] エラーケースが適切に処理される

## 🎯 Phase 3 完了基準

### 機能要件

- [ ] 基盤データ復元が正常に動作
- [ ] 差分データ更新が正常に動作
- [ ] CLI コマンドが正常に動作
- [ ] エラーハンドリングが適切に機能

### 品質要件

- [ ] 全テストが成功
- [ ] 差分データの正確性が確認される
- [ ] パフォーマンス要件を満たす
- [ ] コードレビュー完了

### 技術要件

- [ ] 基盤データが適切に活用されている
- [ ] 差分更新が適切に実装されている
- [ ] エラー処理が適切に実装されている
- [ ] 拡張性が考慮されている

## 📊 品質保証

### テスト戦略

1. **単体テスト**: 各コンポーネントの個別テスト
2. **統合テスト**: コンポーネント間の連携テスト
3. **差分更新テスト**: 差分データの正確性テスト
4. **パフォーマンステスト**: 処理時間とリソース使用量のテスト

### コーディングルール

#### コード品質基準

**1. 行長制限**

- **最大行長**: 88 文字（Black フォーマッタのデフォルト）
- **推奨行長**: 80 文字以下
- **例外**: 長い URL、ファイルパス、コメントは可

**2. インポート文の整理**

- 標準ライブラリ → サードパーティ → ローカルモジュールの順
- 各グループ間に空行を挿入
- 未使用インポートの削除

**3. 文字列フォーマット**

- f-string の使用を推奨
- 長い文字列は複数行に分割
- 文字列連結は`+`ではなく`join()`を使用

**4. 関数・メソッド定義**

- 引数が多い場合は複数行に分割
- 型ヒントの使用
- デフォルト引数の適切な配置

**5. 条件文・ループ**

- 長い条件は複数行に分割
- ネストは 3 レベル以下
- 早期リターンの使用

#### 実装時のチェックリスト

**コード作成時**

- [ ] 行長が 88 文字以下であることを確認
- [ ] インポート文が整理されている
- [ ] 未使用の変数・インポートがない
- [ ] 適切な型ヒントが付いている
- [ ] エラーハンドリングが適切

**コードレビュー時**

- [ ] 行長制限の遵守
- [ ] コードの可読性
- [ ] 命名規則の統一
- [ ] ドキュメンテーションの充実
- [ ] テストカバレッジの確認

#### 自動化ツール

**1. フォーマッタ**

- **Black**: コードフォーマットの自動化
- **isort**: インポート文の自動整理
- **autopep8**: PEP8 準拠の自動修正

**2. リント**

- **flake8**: コード品質チェック
- **pylint**: 包括的なコード分析
- **mypy**: 型チェック

**3. 設定ファイル**

```toml
# pyproject.toml
[tool.black]
line-length = 88
target-version = ['py39']

[tool.isort]
profile = "black"
line_length = 88

[tool.flake8]
max-line-length = 88
extend-ignore = ["E203", "W503"]
```

#### 実装前の準備

**1. 開発環境の設定**

- [ ] Black フォーマッタのインストール
- [ ] isort のインストール
- [ ] flake8 のインストール
- [ ] エディタの設定（自動フォーマット）

**2. プレコミットフック**

- [ ] コードフォーマットの自動実行
- [ ] リントチェックの自動実行
- [ ] 型チェックの自動実行

**3. CI/CD パイプライン**

- [ ] 自動フォーマットチェック
- [ ] リントエラーの検出
- [ ] テストの自動実行

### コードレビュー

- 基盤データの活用状況
- 差分更新の適切性
- エラーハンドリングの確認
- パフォーマンスの確認
- **行長制限の遵守を重点的にチェック**

### 受け入れテスト

- 機能要件の満足度確認
- 差分更新要件の満足度確認
- パフォーマンス要件の確認
- **コード品質基準の確認**

## 🚨 リスク管理

### 技術的リスク

1. **基盤データの破損**
   - **対策**: 基盤データのバックアップと検証機能
2. **差分更新時のデータ不整合**
   - **対策**: 差分データの検証機能とロールバック機能
3. **Yahoo Finance API 制限**
   - **対策**: エラーハンドリングと再試行機能

### スケジュールリスク

1. **差分更新の複雑性**
   - **対策**: 段階的な実装とバッファ時間の確保
2. **テスト時間不足**
   - **対策**: 優先度の調整

### 品質リスク

1. **差分データの不正確性**
   - **対策**: 包括的な差分更新テスト
2. **パフォーマンス劣化**
   - **対策**: 早期のパフォーマンステスト

## 📈 成功指標

### 技術的指標

- **テストカバレッジ**: 90%以上
- **バグ密度**: 1000 行あたり 1 バグ以下
- **処理時間**: 差分更新が 5 分以内で完了
- **成功率**: 95%以上の成功率
- **差分更新精度**: 100%の正確性

### 差分更新指標

- **基盤データ活用**: 100%の基盤データ活用
- **差分更新品質**: 適切な差分更新実装
- **データ連続性**: データの連続性確保

### 保守性指標

- **コード品質**: 読みやすく保守しやすいコード
- **拡張性**: 新機能追加が容易な設計
- **ドキュメント**: 最新で正確なドキュメント

## 🔄 次の Phase への準備

### Phase 4 への引き継ぎ事項

- [ ] 基盤データ復元機能の動作確認
- [ ] 差分データ更新機能の動作確認
- [ ] 差分更新テストの結果確認
- [ ] テスト環境の準備

### 技術的負債の確認

- [ ] 未実装機能の確認
- [ ] 改善点の特定
- [ ] 次の Phase での対応計画

## 🎯 新しいワークフローの利点

### 効率性

- 基盤データを毎回再取得する必要がない
- 差分データのみを取得することで処理時間を短縮
- API 制限への影響を最小化

### 継続性

- 基盤データとの連続性を保つ
- 時系列データの整合性を維持
- データの信頼性を向上

### 実用性

- 定期的な差分更新が可能
- 基盤データへの簡単な復旧が可能
- 運用コストの削減

### 保守性

- 基盤データを基準とした明確な管理
- 差分データの追跡が容易
- 問題発生時の原因特定が容易

---

**作成日**: 2025 年 1 月
**バージョン**: 2.0
**作成者**: AI Assistant
**承認者**: ユーザー
**更新日**: 2025 年 8 月 14 日
**更新内容**: Phase 3 を差分更新処理に変更、新しいワークフローへの対応
