# CLI データベース初期化システム設計書

## 📋 概要

### 目的

- データベース初期化プロセスを明確で使いやすいシステムに改善
- 各処理の責任を分離し、保守性と拡張性を向上
- ユーザビリティの向上とエラーハンドリングの強化

### 設計原則

1. **単一責任の原則**: 各コマンド・スクリプトは明確な責任を持つ
2. **段階的実行**: 処理を段階的に実行可能
3. **柔軟性**: 必要に応じて部分的な実行が可能
4. **透明性**: 各処理の進捗と結果が明確

## 🏗️ システム構成

### CLI コマンド構成

```bash
exchange-analytics data init              # データベースクリーンアップ
exchange-analytics data load              # データ取得
exchange-analytics data complete          # データ補完処理
exchange-analytics data calculate         # テクニカル指標計算
exchange-analytics data setup             # 全処理を一括実行
```

### 処理フロー

```
データベース初期化 → データ取得 → データ補完 → テクニカル指標計算
```

## 📁 ファイル構成

### 新規作成ファイル

```
scripts/cron/
├── database_cleanup.py           # データベースクリーンアップ
├── data_loader.py               # データ取得処理
├── data_completion.py           # データ補完処理（hybrid_initialization.pyから改名）
├── technical_calculator.py      # テクニカル指標計算
└── unified_setup.py            # 一括実行スクリプト
```

### 削除予定ファイル

```
scripts/cron/
├── unified_initialization.py    # 削除（責任が複雑すぎる）
├── initial_data_load.py         # 削除（data_loader.pyに統合）
├── simple_initial_load.py       # 削除（data_loader.pyに統合）
├── multi_timeframe_initial_load.py # 削除（data_loader.pyに統合）
└── hybrid_initialization.py     # 削除（data_completion.pyに改名）
```

## 🔧 各コンポーネントの詳細設計

### 1. データベースクリーンアップ (`database_cleanup.py`)

#### 責任

- データベースファイルの削除
- テーブル構造の再作成
- クリーンな環境の提供

#### クラス設計

```python
class DatabaseCleanup:
    async def cleanup_database(self) -> bool:
        """データベースをクリーンアップ"""

    async def create_tables(self) -> bool:
        """テーブル構造を作成"""

    async def verify_cleanup(self) -> bool:
        """クリーンアップの確認"""
```

#### CLI コマンド

```bash
exchange-analytics data init [--force]
```

### 2. データ取得処理 (`data_loader.py`)

#### 責任

- Yahoo Finance API からのデータ取得
- マルチタイムフレームデータの取得
- データの検証と保存

#### クラス設計

```python
class DataLoader:
    async def load_multi_timeframe_data(self) -> int:
        """マルチタイムフレームデータを取得"""

    async def load_timeframe_data(self, timeframe: str) -> int:
        """特定時間足のデータを取得"""

    async def verify_data_quality(self) -> bool:
        """データ品質の確認"""
```

#### CLI コマンド

```bash
exchange-analytics data load [--timeframe 5m|1h|4h|1d] [--days 7]
```

### 3. データ補完処理 (`data_completion.py`)

#### 責任

- 5 分足データから 1 時間足・4 時間足の補完
- 欠損データの埋め合わせ
- データ連続性の確保

#### クラス設計

```python
class DataCompletionProcessor:
    async def complete_1h_data(self) -> int:
        """1時間足データを補完"""

    async def complete_4h_data(self) -> int:
        """4時間足データを補完"""

    async def verify_completion(self) -> dict:
        """補完結果の確認"""
```

#### CLI コマンド

```bash
exchange-analytics data complete [--timeframe 1h|4h|all]
```

### 4. テクニカル指標計算 (`technical_calculator.py`)

#### 責任

- 移動平均線の計算
- ボリンジャーバンドの計算
- RSI、MACD 等の指標計算

#### クラス設計

```python
class TechnicalCalculator:
    async def calculate_moving_averages(self) -> int:
        """移動平均線を計算"""

    async def calculate_bollinger_bands(self) -> int:
        """ボリンジャーバンドを計算"""

    async def calculate_all_indicators(self) -> int:
        """全テクニカル指標を計算"""
```

#### CLI コマンド

```bash
exchange-analytics data calculate [--indicator ma|bb|rsi|macd|all]
```

### 5. 一括実行スクリプト (`unified_setup.py`)

#### 責任

- 全処理の一括実行
- 処理間の依存関係管理
- エラーハンドリングと復旧

#### クラス設計

```python
class UnifiedSetup:
    async def run_full_setup(self) -> bool:
        """全処理を一括実行"""

    async def run_step_by_step(self) -> bool:
        """段階的に実行"""

    async def handle_errors(self, step: str, error: Exception) -> bool:
        """エラーハンドリング"""
```

#### CLI コマンド

```bash
exchange-analytics data setup [--step-by-step] [--skip-completion]
```

## 🔄 処理フロー詳細

### 1. データベースクリーンアップ

```
1. 既存データベースファイルの削除
2. データベース接続の初期化
3. テーブル構造の作成
4. クリーンアップの確認
```

### 2. データ取得

```
1. Yahoo Finance API接続の確認
2. 各時間足のデータ取得
   - 5分足: 7日分
   - 1時間足: 30日分
   - 4時間足: 60日分
   - 日足: 365日分
3. データ品質の検証
4. データベースへの保存
```

### 3. データ補完

```
1. 5分足データの状況確認
2. 1時間足データの補完
   - 7日分の5分足データを使用
   - 12件の5分足から1時間足を作成
3. 4時間足データの補完
   - 30日分の5分足データを使用
   - 48件の5分足から4時間足を作成
4. 補完結果の確認
```

### 4. テクニカル指標計算

```
1. 各時間足のデータ確認
2. 移動平均線の計算
   - SMA: 5, 10, 20, 50, 100, 200期間
   - EMA: 12, 26期間
3. ボリンジャーバンドの計算
4. RSI、MACD等の計算
5. 計算結果の保存
```

## 🛠️ 実装計画

### Phase 1: 基盤整備

1. **データベースクリーンアップ** (`database_cleanup.py`)
2. **CLI コマンドの基本構造** (`data_commands.py`の更新)

### Phase 2: データ処理

3. **データ取得処理** (`data_loader.py`)
4. **データ補完処理** (`data_completion.py`)

### Phase 3: 分析処理

5. **テクニカル指標計算** (`technical_calculator.py`)
6. **一括実行スクリプト** (`unified_setup.py`)

### Phase 4: 統合・テスト

7. **全処理の統合テスト**
8. **エラーハンドリングの強化**
9. **ドキュメントの更新**

## 📊 エラーハンドリング戦略

### エラー分類

1. **軽微なエラー**: 警告として処理を継続
2. **重要なエラー**: 処理を停止し、ユーザーに選択を求める
3. **致命的なエラー**: 処理を完全に停止

### 復旧オプション

- **再試行**: 同じ処理を再実行
- **スキップ**: 問題のある処理をスキップ
- **ロールバック**: 前の状態に戻す

## 🔍 品質保証

### テスト戦略

1. **単体テスト**: 各コンポーネントの個別テスト
2. **統合テスト**: 処理間の連携テスト
3. **エンドツーエンドテスト**: 全フローのテスト

### 監視項目

- データ取得成功率
- 処理時間
- エラー発生率
- データ品質指標

## 📈 将来の拡張性

### 追加可能な機能

1. **データバックアップ・復元**
2. **増分データ更新**
3. **複数通貨ペア対応**
4. **リアルタイムデータ取得**
5. **データ品質監視ダッシュボード**

### 設定の外部化

- データベース設定
- API 設定
- 処理パラメータ
- ログ設定

## 📝 移行計画

### 段階的移行

1. **新システムの並行開発**
2. **段階的な機能移行**
3. **旧システムの段階的廃止**
4. **完全移行の確認**

### データ移行

- 既存データの保持
- データ形式の互換性確保
- 移行スクリプトの提供

---

**作成日**: 2025 年 1 月
**バージョン**: 1.0
**作成者**: AI Assistant
**承認者**: ユーザー
