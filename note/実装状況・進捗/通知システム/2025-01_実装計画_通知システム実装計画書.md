**旧ファイル名**: `notification_implementation_plan_2025.md`  

# 🔧 Discord 通知パターン実装計画（2025 年 8 月版）

## 📋 実装概要

`discord_notification_patterns_2025.md`で定義した 6 つの通知パターンを技術的に実装するための詳細計画です。

---

## 🏗️ **実装アーキテクチャ**

### 1. 通知パターン判定エンジン

```
TechnicalIndicatorsAnalyzer
├── マルチタイムフレーム分析
├── パターン判定ロジック
├── 優先度管理システム
└── 通知テンプレート生成
```

### 2. 通知管理システム

```
NotificationManager
├── パターン検出
├── 重複防止
├── 優先度制御
└── Discord送信
```

---

## 📁 **フォルダ構成設計**

### **現在の構造**

```
/app/
├── src/
│   ├── infrastructure/
│   │   ├── analysis/
│   │   │   ├── technical_indicators.py
│   │   │   └── currency_correlation_analyzer.py
│   │   ├── messaging/
│   │   │   └── discord_client.py
│   │   └── external_apis/
│   │       └── yahoo_finance_client.py
│   └── utils/
│       └── logging_config.py
├── scripts/
│   └── cron/
│       ├── integrated_ai_discord.py
│       └── real_ai_discord_v2.py
└── note/
    ├── discord_notification_patterns_2025.md
    └── notification_implementation_plan_2025.md
```

### **新規追加予定の構造**

```
/app/
├── src/
│   ├── infrastructure/
│   │   ├── analysis/
│   │   │   ├── technical_indicators.py
│   │   │   ├── currency_correlation_analyzer.py
│   │   │   ├── notification_pattern_analyzer.py  ← 新規
│   │   │   └── pattern_detectors/                ← 新規ディレクトリ
│   │   │       ├── __init__.py
│   │   │       ├── trend_reversal_detector.py    ← 新規
│   │   │       ├── pullback_detector.py          ← 新規
│   │   │       ├── divergence_detector.py        ← 新規
│   │   │       ├── breakout_detector.py          ← 新規
│   │   │       ├── rsi_battle_detector.py        ← 新規
│   │   │       └── composite_signal_detector.py  ← 新規
│   │   ├── messaging/
│   │   │   ├── discord_client.py
│   │   │   ├── notification_manager.py          ← 新規
│   │   │   └── templates/                       ← 新規ディレクトリ
│   │   │       ├── __init__.py
│   │   │       ├── pattern_1_template.py        ← 新規
│   │   │       ├── pattern_2_template.py        ← 新規
│   │   │       ├── pattern_2_2_template.py      ← 新規
│   │   │       ├── pattern_3_template.py        ← 新規
│   │   │       ├── pattern_4_template.py        ← 新規
│   │   │       ├── pattern_5_template.py        ← 新規
│   │   │       └── pattern_6_template.py        ← 新規
│   │   └── external_apis/
│   │       └── yahoo_finance_client.py
│   ├── domain/
│   │   ├── entities/
│   │   │   └── notification_pattern.py          ← 新規
│   │   └── value_objects/
│   │       └── pattern_priority.py              ← 新規
│   └── utils/
│       ├── logging_config.py
│       └── pattern_utils.py                     ← 新規
├── scripts/
│   └── cron/
│       ├── integrated_ai_discord.py
│       ├── real_ai_discord_v2.py
│       └── notification_cron.py                 ← 新規
├── tests/
│   ├── unit/
│   │   ├── test_technical_indicators.py
│   │   ├── test_notification_patterns.py        ← 新規
│   │   └── test_pattern_detectors.py            ← 新規
│   └── integration/
│       ├── test_notification_flow.py            ← 新規
│       └── test_discord_integration.py          ← 新規
└── note/
    ├── discord_notification_patterns_2025.md
    ├── notification_implementation_plan_2025.md
    └── folder_structure_2025.md                 ← 新規
```

### **ファイル詳細説明**

#### **新規コアファイル**

- **`notification_pattern_analyzer.py`**: メインのパターン分析エンジン
- **`notification_manager.py`**: 通知管理・優先度制御システム
- **`notification_pattern.py`**: パターンエンティティ定義
- **`pattern_priority.py`**: 優先度値オブジェクト

#### **パターン検出器（Detectors）**

- **`trend_reversal_detector.py`**: パターン 1（強力なトレンド転換）
- **`pullback_detector.py`**: パターン 2・2-2（押し目・戻り売り）
- **`divergence_detector.py`**: パターン 3（ダイバージェンス警戒）
- **`breakout_detector.py`**: パターン 4（ブレイクアウト狙い）
- **`rsi_battle_detector.py`**: パターン 5（RSI50 ライン攻防）
- **`composite_signal_detector.py`**: パターン 6（複合シグナル）

#### **通知テンプレート**

- **`pattern_*_template.py`**: 各パターン専用の Discord 通知テンプレート
- **`notification_cron.py`**: 通知専用の cron スクリプト

#### **テストファイル**

- **`test_notification_patterns.py`**: パターン分析の単体テスト
- **`test_pattern_detectors.py`**: 各検出器の単体テスト
- **`test_notification_flow.py`**: 通知フローの統合テスト

### **フォルダ構成の利点**

#### **1. モジュール性**

- **各パターン検出器**: 独立したファイルで保守性向上
- **テンプレート分離**: 通知内容とロジックの分離
- **テスト分離**: 単体・統合テストの明確な分離

#### **2. 拡張性**

- **新パターン追加**: `pattern_detectors/`に新ファイル追加のみ
- **新テンプレート追加**: `templates/`に新ファイル追加のみ
- **設定変更**: 各ファイル独立して修正可能

#### **3. 保守性**

- **責任分離**: 各ファイルが単一責任を持つ
- **依存関係明確**: import 文で依存関係が明確
- **デバッグ容易**: 問題箇所の特定が容易

#### **4. テスト容易性**

- **単体テスト**: 各検出器を独立してテスト
- **統合テスト**: 全体フローをテスト
- **モック化**: 依存関係のモック化が容易

---

## 📊 **実装フェーズ**

### **フェーズ 1: 基盤実装（優先度: 高）**

#### 1.1 TechnicalIndicatorsAnalyzer 拡張

```python
class NotificationPatternAnalyzer:
    def __init__(self):
        self.patterns = {
            'pattern_1': self._check_trend_reversal,
            'pattern_2': self._check_pullback_buy,
            'pattern_2_2': self._check_pullback_sell,
            'pattern_3': self._check_divergence,
            'pattern_4': self._check_breakout,
            'pattern_5': self._check_rsi_50_battle,
            'pattern_6': self._check_composite_signal
        }

    async def analyze_notification_patterns(self, currency_pair: str):
        """全パターンを分析して通知判定"""
        results = {}
        for pattern_name, pattern_func in self.patterns.items():
            results[pattern_name] = await pattern_func(currency_pair)
        return results
```

#### 1.2 パターン判定メソッド実装

```python
async def _check_trend_reversal(self, currency_pair: str):
    """パターン1: 強力なトレンド転換シグナル"""
    # D1, H4, H1, M5の全時間軸データ取得
    # RSI > 70 + MACD デッドクロス + ボリンジャーバンド +2σ
    pass

async def _check_pullback_buy(self, currency_pair: str):
    """パターン2: 押し目買いチャンス"""
    # D1: RSI 30-50 + MACD上昇継続
    # H4/H1: RSI 30-40 + ボリンジャーバンド -2σ
    pass

async def _check_pullback_sell(self, currency_pair: str):
    """パターン2-2: 戻り売りチャンス"""
    # D1: RSI 50-70 + MACD下降継続
    # H4/H1: RSI 60-70 + ボリンジャーバンド +2σ
    pass

async def _check_divergence(self, currency_pair: str):
    """パターン3: ダイバージェンス警戒"""
    # 価格新高値 vs RSI前回高値未達
    # 全時間軸での価格上昇 vs RSI下降
    pass
```

### **フェーズ 2: 通知テンプレート実装（優先度: 中）**

#### 2.1 Discord 通知テンプレート

```python
class DiscordNotificationTemplates:
    @staticmethod
    def pattern_1_trend_reversal(data):
        return {
            "title": "🚨 強力な売りシグナル検出！",
            "description": f"📊 {data['currency_pair']} 全時間軸一致",
            "fields": [
                {"name": "🎯 エントリー", "value": f"{data['current_price']}", "inline": True},
                {"name": "🎯 利確", "value": f"{data['take_profit']}", "inline": True},
                {"name": "🎯 損切り", "value": f"{data['stop_loss']}", "inline": True}
            ],
            "color": 0xFF0000  # 赤色（警戒）
        }

    @staticmethod
    def pattern_2_pullback_buy(data):
        return {
            "title": "📈 押し目買いチャンス！",
            "description": f"📊 {data['currency_pair']} トレンド継続中",
            "fields": [
                {"name": "🎯 エントリー", "value": f"{data['current_price']}", "inline": True},
                {"name": "🎯 利確", "value": f"{data['take_profit']}", "inline": True},
                {"name": "🎯 損切り", "value": f"{data['stop_loss']}", "inline": True}
            ],
            "color": 0x00FF00  # 緑色（買い）
        }
```

### **フェーズ 3: 通知管理システム実装（優先度: 中）**

#### 3.1 NotificationManager

```python
class NotificationManager:
    def __init__(self):
        self.pattern_analyzer = NotificationPatternAnalyzer()
        self.discord_client = DiscordClient()
        self.notification_history = {}
        self.priority_weights = {
            'pattern_1': 100,  # 最高優先度
            'pattern_6': 90,   # 高優先度
            'pattern_2': 70,   # 中優先度
            'pattern_2_2': 70, # 中優先度
            'pattern_4': 70,   # 中優先度
            'pattern_3': 70,   # 中優先度
            'pattern_5': 50    # 低優先度
        }

    async def process_notifications(self, currency_pair: str):
        """通知パターンを処理してDiscord送信"""
        # 1. パターン分析
        patterns = await self.pattern_analyzer.analyze_notification_patterns(currency_pair)

        # 2. 優先度フィルタリング
        high_priority_patterns = self._filter_high_priority(patterns)

        # 3. 重複チェック
        new_patterns = self._check_duplicates(high_priority_patterns)

        # 4. Discord送信
        for pattern in new_patterns:
            await self._send_discord_notification(pattern)
```

---

## 🔧 **技術的実装詳細**

### **1. マルチタイムフレームデータ取得**

```python
async def get_multi_timeframe_data(self, currency_pair: str):
    """全時間軸のデータを一括取得"""
    timeframes = {
        'D1': '1d',
        'H4': '4h',
        'H1': '1h',
        'M5': '5m'
    }

    data = {}
    for tf_name, tf_interval in timeframes.items():
        # 十分なデータポイントを取得（テクニカル指標計算用）
        period_map = {
            'D1': '3mo',   # 3ヶ月分
            'H4': '1mo',   # 1ヶ月分
            'H1': '1wk',   # 1週間分
            'M5': '1d'     # 1日分
        }

        hist_data = await self.yahoo_client.get_historical_data(
            currency_pair,
            period=period_map[tf_name],
            interval=tf_interval
        )

        if hist_data is not None:
            # テクニカル指標計算
            indicators = await self.technical_analyzer.calculate_all_indicators(
                hist_data, tf_name
            )
            data[tf_name] = {
                'price_data': hist_data,
                'indicators': indicators
            }

    return data
```

### **2. パターン判定ロジック**

```python
def _check_trend_reversal_conditions(self, data):
    """パターン1の条件判定"""
    conditions = {
        'D1': {
            'rsi_overbought': data['D1']['indicators']['rsi']['current_value'] > 70,
            'macd_dead_cross': self._check_macd_dead_cross(data['D1']['indicators']['macd']),
            'price_high': data['D1']['price_data']['Close'].iloc[-1] > data['D1']['price_data']['Close'].iloc[-2]
        },
        'H4': {
            'rsi_overbought': data['H4']['indicators']['rsi']['current_value'] > 70,
            'bb_upper_touch': self._check_bb_upper_touch(data['H4']['indicators']['bollinger_bands'])
        },
        'H1': {
            'rsi_overbought': data['H1']['indicators']['rsi']['current_value'] > 70,
            'bb_upper_touch': self._check_bb_upper_touch(data['H1']['indicators']['bollinger_bands'])
        },
        'M5': {
            'rsi_overbought': data['M5']['indicators']['rsi']['current_value'] > 70,
            'wick_formation': self._check_wick_formation(data['M5']['price_data'])
        }
    }

    # 全時間軸の条件一致をチェック
    return self._check_all_timeframe_conditions(conditions)
```

### **3. ダイバージェンス検出**

```python
def _detect_divergence(self, price_data, rsi_data, lookback_periods=10):
    """価格とRSIのダイバージェンス検出"""
    # 価格の高値・安値を検出
    price_highs = self._find_peaks(price_data['High'], lookback_periods)
    price_lows = self._find_peaks(-price_data['Low'], lookback_periods)

    # RSIの高値・安値を検出
    rsi_highs = self._find_peaks(rsi_data, lookback_periods)
    rsi_lows = self._find_peaks(-rsi_data, lookback_periods)

    # ダイバージェンス判定
    bearish_divergence = self._check_bearish_divergence(price_highs, rsi_highs)
    bullish_divergence = self._check_bullish_divergence(price_lows, rsi_lows)

    return {
        'bearish': bearish_divergence,
        'bullish': bullish_divergence
    }
```

---

## 📅 **実装スケジュール**

### **Week 1: 基盤実装**

- [ ] フォルダ構成作成
  - [ ] `src/infrastructure/analysis/pattern_detectors/` ディレクトリ作成
  - [ ] `src/infrastructure/messaging/templates/` ディレクトリ作成
  - [ ] `src/domain/entities/notification_pattern.py` 作成
  - [ ] `src/domain/value_objects/pattern_priority.py` 作成
  - [ ] `src/utils/pattern_utils.py` 作成
- [ ] NotificationPatternAnalyzer クラス作成
- [ ] マルチタイムフレームデータ取得機能
- [ ] 基本的なパターン判定ロジック

### **Week 2: パターン実装**

- [ ] パターン検出器（Detectors）実装
  - [ ] `trend_reversal_detector.py` (パターン 1)
  - [ ] `pullback_detector.py` (パターン 2・2-2)
  - [ ] `divergence_detector.py` (パターン 3)
  - [ ] `breakout_detector.py` (パターン 4)
  - [ ] `rsi_battle_detector.py` (パターン 5)
  - [ ] `composite_signal_detector.py` (パターン 6)
- [ ] 各パターンの単体テスト作成

### **Week 3: 通知システム**

- [ ] Discord 通知テンプレート実装
  - [ ] `pattern_1_template.py` (トレンド転換)
  - [ ] `pattern_2_template.py` (押し目買い)
  - [ ] `pattern_2_2_template.py` (戻り売り)
  - [ ] `pattern_3_template.py` (ダイバージェンス)
  - [ ] `pattern_4_template.py` (ブレイクアウト)
  - [ ] `pattern_5_template.py` (RSI50 攻防)
  - [ ] `pattern_6_template.py` (複合シグナル)
- [ ] NotificationManager 実装
- [ ] 優先度管理システム
- [ ] `notification_cron.py` 作成

### **Week 4: テスト・最適化**

- [ ] 統合テスト実装
  - [ ] `test_notification_flow.py` (通知フロー統合テスト)
  - [ ] `test_discord_integration.py` (Discord 統合テスト)
- [ ] 全パターンのテスト実行
- [ ] 通知精度の測定・分析
- [ ] パフォーマンス最適化
- [ ] ドキュメント更新
  - [ ] `folder_structure_2025.md` 作成

---

## 🎯 **実装優先順位**

### **Phase 1: 高優先度（即座実装）**

1. **パターン 1**: 強力なトレンド転換シグナル
2. **パターン 6**: 複合シグナル強化
3. **基盤システム**: NotificationPatternAnalyzer

### **Phase 2: 中優先度（1-2 週間後）**

4. **パターン 2**: 押し目買いチャンス
5. **パターン 2-2**: 戻り売りチャンス
6. **パターン 4**: ブレイクアウト狙い
7. **パターン 3**: ダイバージェンス警戒

### **Phase 3: 低優先度（3-4 週間後）**

8. **パターン 5**: RSI50 ライン攻防
9. **高度な機能**: 機械学習による精度向上

---

## 📊 **期待効果**

### **短期的効果**

- **通知精度**: マルチタイムフレームによる信頼度向上
- **エントリータイミング**: 下位足による精度向上
- **リスク管理**: ダイバージェンス検出による警戒

### **長期的効果**

- **トレード成績**: 体系的な分析による勝率向上
- **学習効果**: パターン認識能力の向上
- **システム安定性**: 自動化による一貫性確保

---

_本実装計画は、市場状況とユーザーフィードバックに応じて継続的に調整されます。_
