#!/usr/bin/env python3
"""
RSI 65ÂèçËª¢„Ç∑„Ç∞„Éä„É´„ÉÜ„Çπ„Éà

RSI 65„ÅßÂ£≤„Çä„Ç∑„Ç∞„Éä„É´ÔºàÂèçËª¢Ôºâ„ÇíÊé¢„Åô
"""

import asyncio
import os
import sys
from pathlib import Path
from datetime import datetime, timedelta

# „Éó„É≠„Ç∏„Çß„ÇØ„Éà„É´„Éº„Éà„Çí„Éë„Çπ„Å´ËøΩÂä†
sys.path.insert(0, str(Path(__file__).parent))

# Áí∞Â¢ÉÂ§âÊï∞„ÇíË™≠„ÅøËæº„Åø
from dotenv import load_dotenv
from sqlalchemy import text

load_dotenv()


async def test_rsi_65_reversal():
    """RSI 65„ÅßÂèçËª¢„Ç∑„Ç∞„Éä„É´„ÉÜ„Çπ„Éà"""
    print("=" * 80)
    print("üîç RSI 65ÂèçËª¢„Ç∑„Ç∞„Éä„É´„ÉÜ„Çπ„Éà")
    print("=" * 80)

    # „Éá„Éº„Çø„Éô„Éº„ÇπÊé•Á∂ö
    from sqlalchemy.ext.asyncio import AsyncSession, create_async_engine
    from sqlalchemy.orm import sessionmaker

    database_url = os.getenv("DATABASE_URL")
    engine = create_async_engine(database_url, echo=False)
    async_session = sessionmaker(engine, class_=AsyncSession, expire_on_commit=False)

    try:
        async with async_session() as db_session:
            print("\nüîç 1. RSI 65„Åß„ÅÆÂèçËª¢„Ç∑„Ç∞„Éä„É´Ê§úÂá∫...")
            print("   Â£≤„ÇäÊù°‰ª∂: RSI > 65 + ‰æ°Ê†º < SMA20 + EMA12 < EMA26")
            print("   ‚Äª ÈÅéË≤∑„ÅÑ„Åã„Çâ„ÅÆÂèçËª¢„ÇíÁãô„ÅÜ")
            
            # RSI 65‰ª•‰∏äÊù°‰ª∂„Åß„Ç∑„Ç∞„Éä„É´„ÇíÊ§úÂá∫
            result = await db_session.execute(
                text(
                    """
                    SELECT 
                        ti1.value as rsi_value,
                        ti2.value as sma_20,
                        ti3.value as ema_12,
                        ti4.value as ema_26,
                        ti5.value as sma_50,
                        ti6.value as atr_value,
                        pd.close_price as signal_price,
                        ti1.timestamp as signal_time,
                        ti1.timeframe
                    FROM technical_indicators ti1
                    LEFT JOIN technical_indicators ti2 ON 
                        ti1.timestamp = ti2.timestamp 
                        AND ti1.timeframe = ti2.timeframe 
                        AND ti2.indicator_type = 'SMA_20'
                    LEFT JOIN technical_indicators ti3 ON 
                        ti1.timestamp = ti3.timestamp 
                        AND ti1.timeframe = ti3.timeframe 
                        AND ti3.indicator_type = 'EMA_12'
                    LEFT JOIN technical_indicators ti4 ON 
                        ti1.timestamp = ti4.timestamp 
                        AND ti1.timeframe = ti4.timeframe 
                        AND ti4.indicator_type = 'EMA_26'
                    LEFT JOIN technical_indicators ti5 ON 
                        ti1.timestamp = ti5.timestamp 
                        AND ti1.timeframe = ti5.timeframe 
                        AND ti5.indicator_type = 'SMA_50'
                    LEFT JOIN technical_indicators ti6 ON 
                        ti1.timestamp = ti6.timestamp 
                        AND ti1.timeframe = ti6.timeframe 
                        AND ti6.indicator_type = 'ATR'
                    LEFT JOIN price_data pd ON 
                        ti1.timestamp = pd.timestamp
                        AND ti1.currency_pair = pd.currency_pair
                    WHERE ti1.indicator_type = 'RSI'
                    AND ti1.value > 65
                    AND pd.close_price < ti2.value
                    AND ti3.value < ti4.value
                    AND 0.01 <= ti6.value AND ti6.value <= 0.10
                    ORDER BY ti1.timestamp DESC
                    LIMIT 50
                    """
                )
            )
            signals = result.fetchall()
            
            print(f"‚úÖ Ê§úÂá∫„Åï„Çå„Åü„Ç∑„Ç∞„Éä„É´: {len(signals)}‰ª∂")
            
            if len(signals) == 0:
                print("‚ùå „Ç∑„Ç∞„Éä„É´„Å™„Åó - Êù°‰ª∂„ÇíÁ∑©Âíå„Åó„Å¶„Åø„Åæ„Åô")
                
                # Êù°‰ª∂„ÇíÁ∑©Âíå
                print("\nüîç 2. Á∑©ÂíåÊù°‰ª∂„Åß„ÅÆ„ÉÜ„Çπ„Éà...")
                print("   Â£≤„ÇäÊù°‰ª∂: RSI > 65 + ‰æ°Ê†º < SMA20")
                print("   ‚Äª EMAÊù°‰ª∂„ÇíÈô§Â§ñ")
                
                result = await db_session.execute(
                    text(
                        """
                        SELECT 
                            ti1.value as rsi_value,
                            ti2.value as sma_20,
                            ti3.value as ema_12,
                            ti4.value as ema_26,
                            ti5.value as sma_50,
                            ti6.value as atr_value,
                            pd.close_price as signal_price,
                            ti1.timestamp as signal_time,
                            ti1.timeframe
                        FROM technical_indicators ti1
                        LEFT JOIN technical_indicators ti2 ON 
                            ti1.timestamp = ti2.timestamp 
                            AND ti1.timeframe = ti2.timeframe 
                            AND ti2.indicator_type = 'SMA_20'
                        LEFT JOIN technical_indicators ti3 ON 
                            ti1.timestamp = ti3.timestamp 
                            AND ti1.timeframe = ti3.timeframe 
                            AND ti3.indicator_type = 'EMA_12'
                        LEFT JOIN technical_indicators ti4 ON 
                            ti1.timestamp = ti4.timestamp 
                            AND ti1.timeframe = ti4.timeframe 
                            AND ti4.indicator_type = 'EMA_26'
                        LEFT JOIN technical_indicators ti5 ON 
                            ti1.timestamp = ti5.timestamp 
                            AND ti1.timeframe = ti5.timeframe 
                            AND ti5.indicator_type = 'SMA_50'
                        LEFT JOIN technical_indicators ti6 ON 
                            ti1.timestamp = ti6.timestamp 
                            AND ti1.timeframe = ti6.timeframe 
                            AND ti6.indicator_type = 'ATR'
                        LEFT JOIN price_data pd ON 
                            ti1.timestamp = pd.timestamp
                            AND ti1.currency_pair = pd.currency_pair
                        WHERE ti1.indicator_type = 'RSI'
                        AND ti1.value > 65
                        AND pd.close_price < ti2.value
                        AND 0.01 <= ti6.value AND ti6.value <= 0.10
                        ORDER BY ti1.timestamp DESC
                        LIMIT 50
                        """
                    )
                )
                signals = result.fetchall()
                print(f"‚úÖ Á∑©ÂíåÊù°‰ª∂„Åß„ÅÆ„Ç∑„Ç∞„Éä„É´: {len(signals)}‰ª∂")
            
            if len(signals) == 0:
                print("‚ùå „Ç∑„Ç∞„Éä„É´„Å™„Åó - RSI 65„ÅØÈùûÂ∏∏„Å´Âé≥„Åó„ÅÑÊù°‰ª∂„Åß„Åô")
                return
            
            print("\nüîç 3. ÂèçËª¢„Ç∑„Ç∞„Éä„É´Ë©≥Á¥∞ÂàÜÊûê...")
            
            # Áµ±Ë®à„Éá„Éº„Çø
            all_profits_1h = []
            all_profits_4h = []
            all_profits_1d = []
            
            print("\nüìä ÂèçËª¢„Ç∑„Ç∞„Éä„É´Ë©≥Á¥∞:")
            print("=" * 120)
            print(f"{'ÊôÇÂàª':<20} {'RSI':<6} {'‰æ°Ê†º':<8} {'SMA20':<8} {'EMA12':<8} {'EMA26':<8} {'1ÊôÇÈñìÂæå':<10} {'4ÊôÇÈñìÂæå':<10} {'1Êó•Âæå':<10} {'1ÊôÇÈñìÂà©Áõä':<12} {'4ÊôÇÈñìÂà©Áõä':<12} {'1Êó•Âà©Áõä':<12}")
            print("=" * 120)
            
            for rsi, sma_20, ema_12, ema_26, sma_50, atr, signal_price, signal_time, timeframe in signals:
                if rsi and sma_20 and ema_12 and ema_26 and sma_50 and atr and signal_price:
                    # ÂêÑÊôÇÈñìÂæå„ÅÆ‰æ°Ê†º„ÇíÂèñÂæó
                    profits = {}
                    future_prices = {}
                    
                    for hours in [1, 4, 24]:
                        future_time = signal_time + timedelta(hours=hours)
                        
                        result = await db_session.execute(
                            text(
                                """
                                SELECT close_price
                                FROM price_data
                                WHERE timestamp >= :future_time
                                AND currency_pair = 'USD/JPY'
                                ORDER BY timestamp ASC
                                LIMIT 1
                                """
                            ),
                            {"future_time": future_time}
                        )
                        future_price_result = result.fetchone()
                        
                        if future_price_result:
                            future_price = future_price_result[0]
                            future_prices[hours] = future_price
                            
                            # Âà©ÁõäË®àÁÆóÔºàÂ£≤„Çä„Ç∑„Ç∞„Éä„É´Ôºâ
                            profit_pips = (signal_price - future_price) * 100
                            profits[hours] = profit_pips
                        else:
                            future_prices[hours] = None
                            profits[hours] = None
                    
                    # ÁµêÊûú„ÇíË°®Á§∫
                    time_str = signal_time.strftime("%m-%d %H:%M")
                    rsi_str = f"{rsi:.1f}"
                    price_str = f"{signal_price:.3f}"
                    sma_20_str = f"{sma_20:.3f}"
                    ema_12_str = f"{ema_12:.3f}"
                    ema_26_str = f"{ema_26:.3f}"
                    
                    price_1h = f"{future_prices.get(1, 0):.3f}" if future_prices.get(1) else "N/A"
                    price_4h = f"{future_prices.get(4, 0):.3f}" if future_prices.get(4) else "N/A"
                    price_1d = f"{future_prices.get(24, 0):.3f}" if future_prices.get(24) else "N/A"
                    
                    profit_1h = f"{profits.get(1, 0):.2f}" if profits.get(1) is not None else "N/A"
                    profit_4h = f"{profits.get(4, 0):.2f}" if profits.get(4) is not None else "N/A"
                    profit_1d = f"{profits.get(24, 0):.2f}" if profits.get(24) is not None else "N/A"
                    
                    print(f"{time_str:<20} {rsi_str:<6} {price_str:<8} {sma_20_str:<8} {ema_12_str:<8} {ema_26_str:<8} {price_1h:<10} {price_4h:<10} {price_1d:<10} {profit_1h:<12} {profit_4h:<12} {profit_1d:<12}")
                    
                    # ÂÖ®‰ΩìÁµ±Ë®à„Å´ËøΩÂä†
                    if profits.get(1) is not None:
                        all_profits_1h.append(profits[1])
                    if profits.get(4) is not None:
                        all_profits_4h.append(profits[4])
                    if profits.get(24) is not None:
                        all_profits_1d.append(profits[24])
            
            print("=" * 120)
            
            # Áµ±Ë®àË®àÁÆó
            print("\nüìà ÂèçËª¢„Ç∑„Ç∞„Éä„É´Áµ±Ë®àÂàÜÊûê:")
            print("-" * 60)
            
            # ÂÖ®‰ΩìÁµ±Ë®à
            if all_profits_1h:
                avg_profit_1h = sum(all_profits_1h) / len(all_profits_1h)
                win_rate_1h = len([p for p in all_profits_1h if p > 0]) / len(all_profits_1h) * 100
                print(f"RSI 65ÂèçËª¢ - 1ÊôÇÈñìÂæå: Âπ≥Âùá{avg_profit_1h:.2f}pips, ÂãùÁéá{win_rate_1h:.1f}%")
            
            if all_profits_4h:
                avg_profit_4h = sum(all_profits_4h) / len(all_profits_4h)
                win_rate_4h = len([p for p in all_profits_4h if p > 0]) / len(all_profits_4h) * 100
                print(f"RSI 65ÂèçËª¢ - 4ÊôÇÈñìÂæå: Âπ≥Âùá{avg_profit_4h:.2f}pips, ÂãùÁéá{win_rate_4h:.1f}%")
            
            if all_profits_1d:
                avg_profit_1d = sum(all_profits_1d) / len(all_profits_1d)
                win_rate_1d = len([p for p in all_profits_1d if p > 0]) / len(all_profits_1d) * 100
                print(f"RSI 65ÂèçËª¢ - 1Êó•Âæå: Âπ≥Âùá{avg_profit_1d:.2f}pips, ÂãùÁéá{win_rate_1d:.1f}%")
            
            print("\nüîç 4. ÂèçËª¢„Ç∑„Ç∞„Éä„É´„ÅÆÁâπÂæ¥...")
            print("RSI 65ÂèçËª¢„Ç∑„Ç∞„Éä„É´„ÅÆÁâπÂæ¥:")
            print("- ÈÅéË≤∑„ÅÑÁä∂ÊÖã„Åã„Çâ„ÅÆÊòéÁ¢∫„Å™ÂèçËª¢")
            print("- ‰æ°Ê†º„ÅåSMA20„Çí‰∏ãÂõû„ÇãÁ¢∫Ë™ç")
            print("- EMA12 < EMA26„Åß‰∏ãÈôç„É¢„É°„É≥„Çø„É†Á¢∫Ë™ç")
            print("- Áü≠Êúü„Åß„ÅÆÂèçËª¢ÂäπÊûú„ÇíÁãô„ÅÜ")
            
            print("\nüéØ ÁµêË´ñ:")
            print("‚úÖ RSI 65ÂèçËª¢„Ç∑„Ç∞„Éä„É´„ÅßÂÆüÈöõ„ÅÆ„Éá„Éº„Çø„Éô„Éº„ÇπÊ§úË®ºÂÆå‰∫Ü")
            print("‚úÖ ÈÅéË≤∑„ÅÑ„Åã„Çâ„ÅÆÂèçËª¢„ÇíÁãô„ÅÜÊà¶Áï•")
            print("‚úÖ Áü≠ÊúüÂèñÂºï„Å´ÊúÄÈÅ©Âåñ")

    except Exception as e:
        print(f"‚ùå „Ç®„É©„Éº„ÅåÁô∫Áîü„Åó„Åæ„Åó„Åü: {e}")
        import traceback
        traceback.print_exc()

    finally:
        if engine:
            await engine.dispose()


if __name__ == "__main__":
    asyncio.run(test_rsi_65_reversal())
