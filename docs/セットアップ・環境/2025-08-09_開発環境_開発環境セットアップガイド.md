**旧ファイル名**: `DEVELOPMENT_SETUP.md`  

# 開発環境セットアップガイド

**作成日**: 2025 年 8 月 9 日
**目的**: Exchange Analytics 開発前の必須準備作業

## 🔍 現在の状況分析

### ✅ 既に準備済み

- Python 3.11.13 環境
- 基本的な requirements.txt
- Docker・docker-compose 設定
- 基本的な .env ファイル
- Git リポジトリ初期化
- 詳細設計書 (9 ファイル)
- TODO.yaml (実装計画)

### ❌ 不足している準備作業

## 1. 🏗️ プロジェクト構造の準備

### 1.1 ディレクトリ構造作成

```bash
mkdir -p src/{domain,application,infrastructure,presentation}
mkdir -p src/domain/{entities,value_objects,repositories,services}
mkdir -p src/application/{commands,queries,handlers,interfaces,dto,exceptions}
mkdir -p src/infrastructure/{database,external_apis,messaging,cache,monitoring}
mkdir -p src/presentation/{api,web,cli}
mkdir -p tests/{unit,integration,e2e}
mkdir -p config/{environments,plugins}
mkdir -p plugins/{interfaces,technical_indicators,analysis,reports}
mkdir -p docs/{api,architecture,deployment}
mkdir -p scripts/{setup,migration,deployment}
```

### 1.2 Python パッケージ初期化

```bash
find src tests plugins -type d -exec touch {}/__init__.py \;
```

## 2. 📦 依存関係の完全化

### 2.1 requirements の分割・更新

現在の `requirements.txt` を分割して管理しやすくする：

**requirements/base.txt** (本番用基本パッケージ)

```
# Web Framework
Flask==3.0.0
Flask-CORS==4.0.0

# Database
SQLAlchemy==2.0.23
alembic==1.12.1
asyncpg==0.29.0

# Dependencies Injection
dependency-injector==4.41.0

# Data & Analysis
pandas==2.1.4
numpy==1.25.2
ta==0.10.2

# External APIs
aiohttp==3.9.1
requests==2.31.0
PyGithub==1.59.1
openai==1.3.8
alpha-vantage==2.3.1

# Async Support
asyncio-mqtt==0.16.1

# Caching
redis==5.0.1

# Monitoring
psutil==5.9.6
prometheus-client==0.19.0

# Validation
marshmallow==3.20.1
pydantic==2.5.0

# Environment
python-dotenv==1.0.0

# Discord Integration
discord-webhook==1.3.0

# Job Scheduling
APScheduler==3.10.4

# Cryptography
cryptography==41.0.8
```

**requirements/development.txt**

```
-r base.txt

# Testing
pytest==7.4.3
pytest-cov==4.1.0
pytest-asyncio==0.21.1
pytest-mock==3.12.0
factory-boy==3.3.0

# Code Quality
black==23.11.0
flake8==6.1.0
isort==5.12.0
mypy==1.7.1
bandit==1.7.5

# Documentation
sphinx==7.2.6
sphinx-rtd-theme==1.3.0

# Development Tools
pre-commit==3.5.0
ipython==8.17.2
jupyter==1.0.0

# Database Tools
psycopg2-binary==2.9.9
```

**requirements/production.txt**

```
-r base.txt

# Production WSGI Server
gunicorn==21.2.0

# Production Database
psycopg2==2.9.9

# Monitoring
sentry-sdk==1.38.0
```

### 2.2 依存関係インストール

```bash
pip install -r requirements/development.txt
```

## 3. ⚙️ 設定ファイルの整備

### 3.1 環境設定の分割

**config/base.py**

```python
"""基本設定クラス"""
import os
from typing import Optional

class BaseConfig:
    """基本設定"""
    # Flask
    SECRET_KEY: str = os.getenv('SECRET_KEY', 'dev-secret-key-change-in-production')
    DEBUG: bool = False
    TESTING: bool = False

    # Database
    DATABASE_URL: str = os.getenv('DATABASE_URL', 'sqlite:///exchange_app.db')
    DATABASE_ECHO: bool = os.getenv('DATABASE_ECHO', 'False').lower() == 'true'

    # Redis
    REDIS_URL: str = os.getenv('REDIS_URL', 'redis://localhost:6379/0')

    # External APIs
    ALPHA_VANTAGE_API_KEY: Optional[str] = os.getenv('ALPHA_VANTAGE_API_KEY')
    OPENAI_API_KEY: Optional[str] = os.getenv('OPENAI_API_KEY')

    # GitHub
    GITHUB_TOKEN: Optional[str] = os.getenv('GITHUB_TOKEN')
    GITHUB_WEBHOOK_SECRET: Optional[str] = os.getenv('GITHUB_WEBHOOK_SECRET')

    # Discord
    DISCORD_WEBHOOK_URL: Optional[str] = os.getenv('DISCORD_WEBHOOK_URL')

    # Logging
    LOG_LEVEL: str = os.getenv('LOG_LEVEL', 'INFO')
    LOG_FORMAT: str = '%(asctime)s - %(name)s - %(levelname)s - %(message)s'
```

**config/development.py**

```python
from .base import BaseConfig

class DevelopmentConfig(BaseConfig):
    DEBUG = True
    DATABASE_ECHO = True
    LOG_LEVEL = 'DEBUG'
```

**config/production.py**

```python
from .base import BaseConfig

class ProductionConfig(BaseConfig):
    DEBUG = False
    TESTING = False
    DATABASE_ECHO = False
```

**config/testing.py**

```python
from .base import BaseConfig

class TestingConfig(BaseConfig):
    TESTING = True
    DATABASE_URL = 'sqlite:///:memory:'
    REDIS_URL = 'redis://localhost:6379/1'
```

### 3.2 .env.example の更新

```bash
# Flask Configuration
SECRET_KEY=your-secret-key-here
FLASK_ENV=development
DEBUG=True

# Database
DATABASE_URL=postgresql://user:password@localhost:5432/exchange_analytics
DATABASE_ECHO=False

# Redis
REDIS_URL=redis://localhost:6379/0

# External API Keys
ALPHA_VANTAGE_API_KEY=your-alpha-vantage-key
OPENAI_API_KEY=your-openai-key

# GitHub Integration
GITHUB_TOKEN=your-github-token
GITHUB_WEBHOOK_SECRET=your-webhook-secret
GITHUB_REPO_OWNER=your-username
GITHUB_REPO_NAME=exchange-analytics

# Discord Integration
DISCORD_WEBHOOK_URL=your-discord-webhook-url
DISCORD_CHANNEL_ID=your-channel-id

# Email Configuration (Optional)
SMTP_SERVER=smtp.gmail.com
SMTP_PORT=587
EMAIL_USERNAME=your-email@gmail.com
EMAIL_PASSWORD=your-app-password

# Monitoring
LOG_LEVEL=INFO
SENTRY_DSN=your-sentry-dsn

# AI Analysis
AI_REPORT_SCHEDULE=0 9 * * *  # Daily at 9 AM
OPENAI_MODEL=gpt-4
```

## 4. 🔧 開発ツールの設定

### 4.1 pre-commit 設定

**.pre-commit-config.yaml**

```yaml
repos:
  - repo: https://github.com/pre-commit/pre-commit-hooks
    rev: v4.5.0
    hooks:
      - id: trailing-whitespace
      - id: end-of-file-fixer
      - id: check-yaml
      - id: check-added-large-files
      - id: check-merge-conflict

  - repo: https://github.com/psf/black
    rev: 23.11.0
    hooks:
      - id: black

  - repo: https://github.com/pycqa/isort
    rev: 5.12.0
    hooks:
      - id: isort

  - repo: https://github.com/pycqa/flake8
    rev: 6.1.0
    hooks:
      - id: flake8

  - repo: https://github.com/pre-commit/mirrors-mypy
    rev: v1.7.1
    hooks:
      - id: mypy
        additional_dependencies: [types-requests, types-PyYAML]
```

### 4.2 pytest 設定

**pytest.ini**

```ini
[tool:pytest]
testpaths = tests
python_files = test_*.py
python_classes = Test*
python_functions = test_*
addopts =
    --verbose
    --tb=short
    --cov=src
    --cov-report=html
    --cov-report=term-missing
    --cov-fail-under=85
asyncio_mode = auto
```

### 4.3 mypy 設定

**mypy.ini**

```ini
[mypy]
python_version = 3.11
warn_return_any = True
warn_unused_configs = True
disallow_untyped_defs = True
disallow_incomplete_defs = True
check_untyped_defs = True
disallow_untyped_decorators = True
no_implicit_optional = True
warn_redundant_casts = True
warn_unused_ignores = True
warn_no_return = True
warn_unreachable = True
strict_equality = True

[mypy-tests.*]
disallow_untyped_defs = False
```

### 4.4 flake8 設定

**.flake8**

```ini
[flake8]
max-line-length = 88
extend-ignore = E203, W503
exclude =
    .git,
    __pycache__,
    .pytest_cache,
    .mypy_cache,
    .venv,
    venv,
    migrations
```

### 4.5 black & isort 設定

**pyproject.toml**

```toml
[tool.black]
line-length = 88
target-version = ['py311']
include = '\.pyi?$'
extend-exclude = '''
/(
  migrations
)/
'''

[tool.isort]
profile = "black"
multi_line_output = 3
include_trailing_comma = true
force_grid_wrap = 0
use_parentheses = true
ensure_newline_before_comments = true
line_length = 88
skip = ["migrations"]
```

## 5. 🗄️ データベース準備

### 5.1 Alembic 初期化

```bash
pip install alembic
alembic init migrations
```

### 5.2 SQLAlchemy 設定

**src/infrastructure/database/**init**.py**

```python
from sqlalchemy.ext.asyncio import AsyncSession, create_async_engine
from sqlalchemy.orm import sessionmaker

engine = None
async_session = None

def init_db(database_url: str):
    global engine, async_session
    engine = create_async_engine(database_url, echo=True)
    async_session = sessionmaker(engine, class_=AsyncSession, expire_on_commit=False)
```

## 6. 🐳 Docker 環境整備

### 6.1 Dockerfile の最適化

**Dockerfile**

```dockerfile
FROM python:3.11-slim

WORKDIR /app

# システム依存関係
RUN apt-get update && apt-get install -y \
    gcc \
    g++ \
    && rm -rf /var/lib/apt/lists/*

# Python 依存関係
COPY requirements/production.txt .
RUN pip install --no-cache-dir -r production.txt

# アプリケーションコード
COPY . .

# 非rootユーザーで実行
RUN useradd -m appuser && chown -R appuser:appuser /app
USER appuser

EXPOSE 8000

CMD ["gunicorn", "--bind", "0.0.0.0:8000", "--workers", "4", "src.presentation.api.app:create_app()"]
```

### 6.2 docker-compose の拡張

**docker-compose.yml**

```yaml
version: "3.8"

services:
  app:
    build: .
    ports:
      - "8000:8000"
    environment:
      - DATABASE_URL=postgresql://postgres:password@db:5432/exchange_analytics
      - REDIS_URL=redis://redis:6379/0
    depends_on:
      - db
      - redis
    volumes:
      - .:/app

  db:
    image: postgres:15
    environment:
      POSTGRES_DB: exchange_analytics
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: password
    volumes:
      - postgres_data:/var/lib/postgresql/data
    ports:
      - "5432:5432"

  redis:
    image: redis:7-alpine
    ports:
      - "6379:6379"
    volumes:
      - redis_data:/data

  nginx:
    image: nginx:alpine
    ports:
      - "80:80"
    volumes:
      - ./nginx.conf:/etc/nginx/nginx.conf
    depends_on:
      - app

volumes:
  postgres_data:
  redis_data:
```

## 7. 📝 ドキュメント準備

### 7.1 README.md の更新

### 7.2 API ドキュメント準備

### 7.3 開発者ガイド作成

## 8. 🔒 セキュリティ設定

### 8.1 secrets 管理

### 8.2 .gitignore の完全化

## ✅ セットアップ確認チェックリスト

- [ ] ディレクトリ構造作成
- [ ] requirements 分割・インストール
- [ ] 設定ファイル作成
- [ ] 開発ツール設定 (pre-commit, pytest, mypy 等)
- [ ] データベース初期化
- [ ] Docker 環境テスト
- [ ] Git hooks 設定
- [ ] 環境変数設定
- [ ] ドキュメント更新
- [ ] セキュリティ設定

この準備が完了後、TODO.yaml の Phase 1 から実装開始できます。
