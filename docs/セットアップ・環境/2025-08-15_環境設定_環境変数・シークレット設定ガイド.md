**旧ファイル名**: `ENVIRONMENT_SECRETS_SETUP.md`  

# 🔐 Environment Secrets 設定ガイド

## 📋 概要

GitHub Environment Secrets を設定することで、本番環境での 24 時間稼働システムをより安全に運用できます。Repository Secrets よりも高度なセキュリティと制御が可能です。

## 🎯 Environment Secrets の利点

### 🔒 セキュリティ向上

- **環境別アクセス制御**: 本番環境への限定的なアクセス
- **保護ルール**: main ブランチのみ実行可能
- **承認フロー**: 重要な変更時の承認プロセス
- **ログ追跡**: 環境別の実行履歴管理

### 🔧 運用管理

- **環境分離**: production/staging/development
- **API Key 管理**: 環境ごとの異なるキー
- **デプロイ制御**: 段階的リリース
- **モニタリング**: 環境別パフォーマンス監視

### 📊 プロジェクト特有の利点

- **本番 Discord vs テスト Discord**: チャンネル分離
- **本番 OpenAI vs 開発 OpenAI**: API 使用量分離
- **24 時間稼働の安全性**: 誤動作防止

## ⚙️ Environment 設定手順

### 1️⃣ Production Environment 作成

1. **GitHub リポジトリにアクセス**

   ```
   https://github.com/m37335/exchangeApp
   ```

2. **Settings → Environments をクリック**

   - 「New environment」ボタンをクリック

3. **Environment 名を入力**

   ```
   Environment name: production
   ```

4. **「Configure environment」をクリック**

### 2️⃣ Environment 保護ルール設定

**Protected branches (推奨)**:

```
☑️ Required reviewers: 0 (個人プロジェクトの場合)
☑️ Restrict pushes to protected branches only
    Selected branches: main
```

**Deployment branches**:

```
☑️ Selected branches
    Branch name pattern: main
```

### 3️⃣ Environment Secrets 設定

**Environment secrets セクションで「Add secret」**:

#### 🤖 OPENAI_API_KEY

```
Name: OPENAI_API_KEY
Value: sk-xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
```

#### 📢 DISCORD_WEBHOOK_URL

```
Name: DISCORD_WEBHOOK_URL
Value: https://discord.com/api/webhooks/xxxxxxxxx/xxxxxxxxx
```

#### 📊 YAHOO_FINANCE_API_KEY (オプション)

```
Name: YAHOO_FINANCE_API_KEY
Value: your_yahoo_finance_api_key
```

### 4️⃣ 設定確認

**Environment secrets が表示される**:

```
✅ OPENAI_API_KEY (Last updated: just now)
✅ DISCORD_WEBHOOK_URL (Last updated: just now)
✅ YAHOO_FINANCE_API_KEY (Last updated: just now)
```

## 🔍 Repository Secrets vs Environment Secrets

### Repository Secrets (基本設定)

**用途**: 開発・テスト・手動実行
**設定場所**: Settings → Secrets and variables → Actions
**アクセス**: リポジトリ全体のワークフローから利用可能

**設定推奨項目**:

```
OPENAI_API_KEY_DEV (開発用)
DISCORD_WEBHOOK_URL_TEST (テスト用)
```

### Environment Secrets (本番設定)

**用途**: 本番 24 時間自動稼働
**設定場所**: Settings → Environments → production
**アクセス**: production 環境指定のワークフローのみ

**設定推奨項目**:

```
OPENAI_API_KEY (本番用)
DISCORD_WEBHOOK_URL (本番Discord)
YAHOO_FINANCE_API_KEY (本番API)
```

## 🚀 ワークフロー更新

### Environment 指定

**GitHub Actions ワークフロー**に以下を追加済み:

```yaml
jobs:
  integrated-analysis:
    name: 🎯 統合AI相関分析
    runs-on: ubuntu-latest
    environment: production # ← Environment指定
    # ...

  technical-analysis:
    name: 📈 個別テクニカル分析
    runs-on: ubuntu-latest
    environment: production # ← Environment指定
    # ...
```

### Environment 変数アクセス

**Secrets アクセス方法**（変更なし）:

```yaml
- name: 🔑 Setup Environment Variables
  run: |
    echo "OPENAI_API_KEY=${{ secrets.OPENAI_API_KEY }}" >> $GITHUB_ENV
    echo "DISCORD_WEBHOOK_URL=${{ secrets.DISCORD_WEBHOOK_URL }}" >> $GITHUB_ENV
    echo "YAHOO_FINANCE_API_KEY=${{ secrets.YAHOO_FINANCE_API_KEY }}" >> $GITHUB_ENV
```

**GitHub Actions が自動で production environment の secrets を参照**

## 📊 運用パターン

### パターン 1: Repository Secrets のみ（シンプル）

**メリット**: 設定が簡単、すぐに開始可能
**デメリット**: セキュリティレベルが基本的
**推奨**: 個人開発、学習目的

### パターン 2: Environment Secrets（推奨）

**メリット**: 高セキュリティ、本格運用対応
**デメリット**: 設定がやや複雑
**推奨**: 24 時間本番稼働、チーム開発

### パターン 3: 両方併用（最強）

**Repository Secrets**: 開発・テスト用
**Environment Secrets**: 本番用
**メリット**: 開発効率 + 本番安全性
**推奨**: プロフェッショナル運用

## 🔧 トラブルシューティング

### よくある問題

#### **Environment not found**

```
エラー: Environment 'production' not found
解決: Settings → Environments で production環境作成確認
```

#### **Environment secrets access denied**

```
エラー: Cannot access environment secrets
解決: Branch protection rules 確認、main ブランチから実行
```

#### **Secrets not loaded**

```
エラー: Environment variable not set
解決: Environment secrets 設定確認、名前のスペルチェック
```

### デバッグ方法

**Environment 確認**:

```yaml
- name: 🔍 Environment Info
  run: |
    echo "Environment: ${{ github.environment }}"
    echo "Ref: ${{ github.ref }}"
    echo "Actor: ${{ github.actor }}"
```

## 📈 監視・運用

### Environment 別ログ確認

**GitHub Actions 実行履歴**:

```
Actions → Workflow runs → Environment: production
```

**Environment 別統計**:

```
Settings → Environments → production → Deployments
```

### セキュリティ監査

**定期確認項目**:

- Environment secrets の更新日
- 不要なアクセス権限の削除
- Branch protection rules の確認
- 実行ログの異常検知

## 💡 ベストプラクティス

### Secrets 命名規則

```
# Repository Secrets (開発用)
OPENAI_API_KEY_DEV
DISCORD_WEBHOOK_URL_TEST
SLACK_WEBHOOK_URL_DEV

# Environment Secrets (本番用)
OPENAI_API_KEY
DISCORD_WEBHOOK_URL
SLACK_WEBHOOK_URL
```

### 環境別設定例

```yaml
# 開発環境 (Repository Secrets使用)
- name: Development Test
  if: github.event_name == 'workflow_dispatch'
  run: python test.py
  env:
    API_KEY: ${{ secrets.OPENAI_API_KEY_DEV }}

# 本番環境 (Environment Secrets使用)
- name: Production Deploy
  if: github.event_name == 'schedule'
  environment: production
  run: python deploy.py
  env:
    API_KEY: ${{ secrets.OPENAI_API_KEY }}
```

---

## 🎯 実装チェックリスト

### ✅ Environment 設定

```
□ GitHub → Settings → Environments
□ Environment名: production
□ Branch protection: main only
□ Environment secrets 3項目設定
□ ワークフロー environment: production 指定
```

### ✅ Secrets 設定

```
□ OPENAI_API_KEY (production)
□ DISCORD_WEBHOOK_URL (production)
□ YAHOO_FINANCE_API_KEY (production)
□ テスト実行・動作確認
```

### ✅ 運用開始

```
□ 24時間自動稼働スケジュール確認
□ Discord配信テスト成功
□ ログ監視体制確立
□ エラー対応フロー確認
```

---

**🌟 Environment Secrets 設定で最高レベルのセキュリティを実現！**

**本格的な 24 時間稼働システムの完成です！** 🔐🚀✨
