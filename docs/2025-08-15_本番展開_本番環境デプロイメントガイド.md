**旧ファイル名**: `PRODUCTION_DEPLOYMENT.md`  

# USD/JPY Trading System - Production Deployment

## 概要

USD/JPY特化のトレーディングシステムの本番デプロイが完了しました。このドキュメントでは、デプロイされたシステムの使用方法と運用方法について説明します。

## デプロイ完了項目

### ✅ Phase 1: データベース基盤
- [x] データベースモデル実装
- [x] リポジトリ実装
- [x] 接続管理
- [x] マイグレーション

### ✅ Phase 2: データ取得システム
- [x] Yahoo Finance API統合
- [x] 5分間隔データ取得
- [x] エラーハンドリング
- [x] リトライ機能

### ✅ Phase 3: 通知統合
- [x] パターン検出サービス
- [x] 通知統合サービス
- [x] Discord通知
- [x] 重複防止機能

### ✅ Phase 4: 本番運用準備
- [x] 設定管理サービス
- [x] データクリーンアップサービス
- [x] 統合テスト
- [x] Cronスクリプト

### ✅ Phase 5: 本番デプロイ
- [x] 本番環境設定
- [x] データ移行
- [x] 運用開始
- [x] 監視システム

## システム構成

### コアサービス
- **DataFetcherService**: Yahoo Finance APIからのデータ取得
- **TechnicalIndicatorService**: テクニカル指標計算
- **PatternDetectionService**: パターン検出
- **NotificationIntegrationService**: 通知統合
- **SystemConfigService**: 設定管理
- **DataCleanupService**: データクリーンアップ

### スケジューラー
- **USDJPYDataScheduler**: 5分間隔データ取得
- **TechnicalIndicatorScheduler**: テクニカル指標計算

### Cronスクリプト
- **usdjpy_data_cron.py**: データ取得定期実行
- **technical_analysis_cron.py**: テクニカル分析定期実行

### デプロイスクリプト
- **production_setup.py**: 本番環境設定
- **data_migration.py**: データ移行
- **production_startup.py**: 運用開始
- **deploy_production.py**: 統合デプロイ

## 使用方法

### 1. 本番デプロイ実行

```bash
# 完全デプロイ
python scripts/deployment/deploy_production.py

# 段階的デプロイ
python scripts/deployment/deploy_production.py --skip-setup
python scripts/deployment/deploy_production.py --skip-migration
python scripts/deployment/deploy_production.py --skip-startup

# 自動確認モード
python scripts/deployment/deploy_production.py --auto-confirm
```

### 2. 個別コンポーネント実行

```bash
# 本番環境設定
python scripts/deployment/production_setup.py

# データ移行
python scripts/migration/data_migration.py

# 運用開始
python scripts/deployment/production_startup.py
```

### 3. 定期実行設定

```bash
# crontab設定例
# 5分間隔でデータ取得
*/5 * * * * cd /app && python scripts/cron/usdjpy_data_cron.py >> /var/log/usdjpy_data.log 2>&1

# 10分間隔でテクニカル分析
*/10 * * * * cd /app && python scripts/cron/technical_analysis_cron.py >> /var/log/technical_analysis.log 2>&1
```

## 環境変数設定

必須の環境変数：

```bash
# データベース接続
export DATABASE_URL="postgresql+asyncpg://user:password@localhost/dbname"

# Discord通知
export DISCORD_WEBHOOK_URL="https://discord.com/api/webhooks/..."

# Yahoo Finance API
export YAHOO_FINANCE_API_KEY="your_api_key"

# ログレベル
export LOG_LEVEL="INFO"
```

## 監視とログ

### ログファイル
- `logs/system.log`: システムログ
- `logs/error.log`: エラーログ
- `logs/deployment.log`: デプロイログ
- `logs/migration.log`: 移行ログ

### 監視項目
- データベース接続状態
- スケジューラー実行状況
- データ取得成功率
- 通知送信状況
- システムパフォーマンス

### ヘルスチェック
```bash
# システム状態確認
python scripts/deployment/production_startup.py

# データベース接続確認
python -c "from src.infrastructure.database.connection import get_async_session; print('DB OK')"
```

## トラブルシューティング

### よくある問題

#### 1. データ取得エラー
```bash
# 原因: Yahoo Finance API接続問題
# 解決: APIキーとネットワーク接続を確認
export YAHOO_FINANCE_API_KEY="valid_api_key"
```

#### 2. データベース接続エラー
```bash
# 原因: データベース接続設定問題
# 解決: DATABASE_URLを確認
export DATABASE_URL="postgresql+asyncpg://user:password@localhost/dbname"
```

#### 3. Discord通知エラー
```bash
# 原因: Webhook URL無効
# 解決: Discord Webhook URLを確認
export DISCORD_WEBHOOK_URL="https://discord.com/api/webhooks/..."
```

#### 4. パフォーマンス問題
```bash
# 原因: データベース負荷
# 解決: データクリーンアップ実行
python -c "
from src.infrastructure.database.services.data_cleanup_service import DataCleanupService
# クリーンアップ実行
"
```

### 緊急時対応

#### システム停止
```bash
# プロセス終了
pkill -f "python.*scheduler"
pkill -f "python.*cron"
```

#### データ復旧
```bash
# バックアップからの復旧
python scripts/migration/data_migration.py
```

#### 設定リセット
```bash
# デフォルト設定への復帰
python scripts/deployment/production_setup.py
```

## パフォーマンス最適化

### 推奨設定
- データ保持期間: 90日
- クリーンアップ間隔: 日次
- 接続プールサイズ: 10-20
- バッチサイズ: 1000

### 監視指標
- データ取得成功率: >95%
- 通知送信成功率: >90%
- システム応答時間: <5秒
- データベース接続数: <80%

## セキュリティ

### 推奨事項
- 環境変数の安全な管理
- データベースアクセス制限
- ログファイルの権限設定
- 定期的なセキュリティ更新

### 監査ログ
- 設定変更履歴
- データアクセス履歴
- エラー発生履歴
- パフォーマンス統計

## 運用マニュアル

詳細な運用マニュアルは以下で生成されます：
- `docs/operation_manual.md`: 自動生成される運用マニュアル

## サポート

### 連絡先
- システム管理者: [管理者連絡先]
- 緊急時連絡先: [緊急時連絡先]

### ドキュメント
- 設計書: `note/database_implementation_design_2025.md`
- 実装計画: `note/database_implementation_plan_2025.yaml`
- チャート設定: `note/trade_chart_settings_complete_2025.md`

## 更新履歴

- **2025-01-XX**: 本番デプロイ完了
- **2025-01-XX**: Phase 4実装完了
- **2025-01-XX**: Phase 3実装完了
- **2025-01-XX**: Phase 2実装完了
- **2025-01-XX**: Phase 1実装完了

---

**注意**: このシステムはUSD/JPY特化設計です。他の通貨ペアへの適用には追加開発が必要です。
