**旧ファイル名**: `advanced_analysis_system.md`  

# 高度な分析システム 設計書

## 1. システム概要

### システム名

**Advanced Analysis System**

### 目的

ダイバージェンス検出、サポート・レジスタンス分析、モメンタム分析を統合し、包括的な市場分析と投資判断をサポートする高度な分析システム

### 主な機能

- **ダイバージェンス検出**: 価格とテクニカル指標の乖離を自動検出
- **サポート・レジスタンス分析**: 移動平均線を活用した重要レベルの自動検出
- **モメンタム分析**: 指標の変化速度と方向性の分析
- **統合分析**: 3 つの分析を統合した市場状況の総合判断
- **高度なシグナル分析**: 包括的シグナル分析と信頼度評価
- **CLI 統合**: コマンドラインからの直感的な操作
- **視認性向上**: 色分け、アイコン、構造化された出力

## 2. システム構成

### 2.1 ファイル・フォルダ構造

```
/app/
├── docs/
│   ├── advanced_analysis_system.md          # 本設計書
│   ├── technical_indicators_visualization_system.md
│   ├── architecture/
│   │   └── DESIGN.md
│   └── README.md
├── scripts/
│   └── cron/
│       ├── divergence_detector.py           # ダイバージェンス検出
│       ├── support_resistance_analyzer.py   # サポート・レジスタンス分析
│       ├── momentum_analyzer.py             # モメンタム分析
│       ├── advanced_signal_analyzer.py      # 高度なシグナル分析
│       ├── technical_visualizer.py          # テクニカル指標可視化
│       ├── unified_technical_calculator.py  # 統合テクニカル指標計算
│       ├── base_data_restorer.py            # 基盤データ復元
│       ├── differential_updater.py          # 差分データ更新
│       └── technical_indicators_calculator.py  # 既存テクニカル指標計算（AI分析用）
├── src/
│   ├── infrastructure/
│   │   ├── database/
│   │   │   ├── models/
│   │   │   │   ├── price_data_model.py      # 価格データモデル
│   │   │   │   └── technical_indicator_model.py  # テクニカル指標モデル
│   │   │   ├── repositories/
│   │   │   │   ├── price_data_repository.py
│   │   │   │   └── technical_indicator_repository.py
│   │   │   └── connection.py                # データベース接続
│   │   ├── external_apis/
│   │   │   └── yahoo_finance_client.py      # Yahoo Finance API クライアント
│   │   └── analysis/
│   │       └── technical_indicators.py      # 既存テクニカル指標分析
│   └── presentation/
│       └── cli/
│           ├── main.py                      # CLI メインエントリーポイント
│           └── commands/
│               └── data_commands.py         # データ関連コマンド
├── data/
│   ├── exchange_analytics.db                # メインデータベース
│   └── exchange_analytics_phase2_complete_2025-08-14.db  # 基盤データバックアップ
├── note/
│   └── CLIデータベース初期化システム実装仕様書_2025.md  # 実装仕様書
└── requirements.txt                         # 依存関係
```

### 2.2 主要ファイルの役割

#### 2.2.1 分析機能スクリプト

| ファイル名                        | 役割                       | 主要クラス                   |
| --------------------------------- | -------------------------- | ---------------------------- |
| `divergence_detector.py`          | ダイバージェンス検出       | `DivergenceDetector`         |
| `support_resistance_analyzer.py`  | サポート・レジスタンス分析 | `SupportResistanceAnalyzer`  |
| `momentum_analyzer.py`            | モメンタム分析             | `MomentumAnalyzer`           |
| `advanced_signal_analyzer.py`     | 高度なシグナル分析         | `AdvancedSignalAnalyzer`     |
| `technical_visualizer.py`         | テクニカル指標可視化       | `TechnicalVisualizer`        |
| `unified_technical_calculator.py` | 統合テクニカル指標計算     | `UnifiedTechnicalCalculator` |

#### 2.2.2 データ管理スクリプト

| ファイル名                           | 役割                   | 主要クラス                      |
| ------------------------------------ | ---------------------- | ------------------------------- |
| `base_data_restorer.py`              | 基盤データ復元         | `BaseDataRestorer`              |
| `differential_updater.py`            | 差分データ更新         | `DifferentialUpdater`           |
| `technical_indicators_calculator.py` | 既存テクニカル指標計算 | `TechnicalIndicatorsCalculator` |

#### 2.2.3 CLI コマンド

| ファイル名         | 役割               | 主要コマンド                                                                                     |
| ------------------ | ------------------ | ------------------------------------------------------------------------------------------------ |
| `data_commands.py` | データ関連コマンド | `detect-divergences`, `analyze-support-resistance`, `analyze-momentum`, `comprehensive-analysis` |

#### 2.2.4 データベースモデル

| ファイル名                     | 役割                 | 主要クラス                |
| ------------------------------ | -------------------- | ------------------------- |
| `price_data_model.py`          | 価格データモデル     | `PriceDataModel`          |
| `technical_indicator_model.py` | テクニカル指標モデル | `TechnicalIndicatorModel` |

### 2.3 依存関係

#### 2.3.1 外部ライブラリ

```txt
# requirements.txt
typer>=0.9.0
rich>=13.0.0
pandas>=2.0.0
numpy>=1.24.0
sqlalchemy>=2.0.0
aiosqlite>=0.19.0
TA-Lib>=0.4.0
yfinance>=0.2.0
pytz>=2023.3
```

#### 2.3.2 内部依存関係

```
scripts/cron/divergence_detector.py
├── src/infrastructure/database/connection.py
├── src/infrastructure/database/models/price_data_model.py
├── src/infrastructure/database/models/technical_indicator_model.py
└── rich.console

scripts/cron/support_resistance_analyzer.py
├── src/infrastructure/database/connection.py
├── src/infrastructure/database/models/price_data_model.py
├── src/infrastructure/database/models/technical_indicator_model.py
└── rich.console

scripts/cron/momentum_analyzer.py
├── src/infrastructure/database/connection.py
├── src/infrastructure/database/models/technical_indicator_model.py
└── rich.console

src/presentation/cli/commands/data_commands.py
├── scripts/cron/divergence_detector.py
├── scripts/cron/support_resistance_analyzer.py
├── scripts/cron/momentum_analyzer.py
├── scripts/cron/advanced_signal_analyzer.py
├── scripts/cron/technical_visualizer.py
└── rich.console
```

### 2.4 データフロー

```
┌─────────────────────────────────────────────────────────────────┐
│                        CLI Layer                                │
│  ┌─────────────────┐  ┌─────────────────┐  ┌─────────────────┐  │
│  │ comprehensive-  │  │ detect-         │  │ analyze-        │  │
│  │ analysis        │  │ divergences     │  │ support-        │  │
│  │                 │  │                 │  │ resistance      │  │
│  └─────────────────┘  └─────────────────┘  └─────────────────┘  │
└─────────────────────────────────────────────────────────────────┘
                              │
┌─────────────────────────────────────────────────────────────────┐
│                    Business Logic Layer                         │
│  ┌─────────────────┐  ┌─────────────────┐  ┌─────────────────┐  │
│  │ Divergence      │  │ Support         │  │ Momentum        │  │
│  │ Detector        │  │ Resistance      │  │ Analyzer        │  │
│  │                 │  │ Analyzer        │  │                 │  │
│  └─────────────────┘  └─────────────────┘  └─────────────────┘  │
└─────────────────────────────────────────────────────────────────┘
                              │
┌─────────────────────────────────────────────────────────────────┐
│                      Data Layer                                 │
│  ┌─────────────────┐  ┌─────────────────┐  ┌─────────────────┐  │
│  │ Technical       │  │ Price Data      │  │ Yahoo Finance   │  │
│  │ Indicators      │  │ Repository      │  │ Client          │  │
│  │ Repository      │  │                 │  │                 │  │
│  └─────────────────┘  └─────────────────┘  └─────────────────┘  │
└─────────────────────────────────────────────────────────────────┘
                              │
┌─────────────────────────────────────────────────────────────────┐
│                   Database Layer                                │
│  ┌─────────────────────────────────────────────────────────────┐  │
│  │              SQLite Database                                │  │
│  │  ┌─────────────────┐  ┌─────────────────┐  ┌─────────────┐  │  │
│  │  │ technical_      │  │ price_data      │  │ exchange_   │  │
│  │  │ indicators      │  │                 │  │ analytics   │  │
│  │  └─────────────────┘  └─────────────────┘  └─────────────┘  │  │
│  └─────────────────────────────────────────────────────────────┘  │
└─────────────────────────────────────────────────────────────────┘
```

### 2.5 クラス間の関係図

```
┌─────────────────────────────────────────────────────────────────┐
│                    CLI Commands                                 │
│  ┌─────────────────┐  ┌─────────────────┐  ┌─────────────────┐  │
│  │ data_commands   │  │ comprehensive_  │  │ detect-         │  │
│  │                 │  │ analysis        │  │ divergences     │  │
│  └─────────────────┘  └─────────────────┘  └─────────────────┘  │
└─────────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────────┐
│                  Analysis Components                            │
│  ┌─────────────────┐  ┌─────────────────┐  ┌─────────────────┐  │
│  │ Divergence      │  │ Support         │  │ Momentum        │  │
│  │ Detector        │  │ Resistance      │  │ Analyzer        │  │
│  │                 │  │ Analyzer        │  │                 │  │
│  │ ┌─────────────┐ │  │ ┌─────────────┐ │  │ ┌─────────────┐ │  │
│  │ │ Divergence  │ │  │ │ Support     │ │  │ │ Momentum    │ │  │
│  │ │ Signal      │ │  │ │ Resistance  │ │  │ │ Signal      │ │  │
│  │ │             │ │  │ │ Level       │ │  │ │             │ │  │
│  │ └─────────────┘ │  │ └─────────────┘ │  │ └─────────────┘ │  │
│  └─────────────────┘  └─────────────────┘  └─────────────────┘  │
└─────────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────────┐
│                    Data Access Layer                            │
│  ┌─────────────────┐  ┌─────────────────┐  ┌─────────────────┐  │
│  │ Technical       │  │ Price Data      │  │ Database        │  │
│  │ Indicator       │  │ Repository      │  │ Connection      │  │
│  │ Repository      │  │                 │  │                 │  │
│  └─────────────────┘  └─────────────────┘  └─────────────────┘  │
└─────────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────────┐
│                   Database Models                               │
│  ┌─────────────────┐  ┌─────────────────┐  ┌─────────────────┐  │
│  │ Technical       │  │ Price Data      │  │ Base Model      │  │
│  │ Indicator       │  │ Model           │  │                 │  │
│  │ Model           │  │                 │  │                 │  │
│  └─────────────────┘  └─────────────────┘  └─────────────────┘  │
└─────────────────────────────────────────────────────────────────┘
```

### 2.6 実行フロー

#### 2.6.1 統合分析の実行フロー

```
1. CLI コマンド実行
   └── exchange-analytics data comprehensive-analysis

2. コマンド処理 (data_commands.py)
   ├── パラメータ検証
   ├── 環境変数設定
   └── サブプロセス実行

3. 分析スクリプト実行
   ├── divergence_detector.py
   ├── support_resistance_analyzer.py
   └── momentum_analyzer.py

4. データアクセス
   ├── データベース接続
   ├── データ取得
   └── データ処理

5. 結果統合
   ├── 各分析結果の収集
   ├── 総合判断の実行
   └── 推奨アクションの生成

6. 結果表示
   ├── 構造化された出力
   ├── 色分けとアイコン
   └── 総合評価の表示
```

#### 2.6.2 個別分析の実行フロー

```
1. ダイバージェンス検出
   ├── 価格データ取得
   ├── テクニカル指標データ取得
   ├── ピーク検出
   ├── ダイバージェンス判定
   └── 信頼度計算

2. サポート・レジスタンス分析
   ├── 価格データ取得
   ├── 移動平均線データ取得
   ├── レベル検出
   ├── 強度計算
   └── ピボットポイント計算

3. モメンタム分析
   ├── テクニカル指標データ取得
   ├── 変化率計算
   ├── 速度計算
   ├── モメンタムタイプ判定
   └── 総合評価
```

### 技術スタック

- **Backend**: Python 3.9+
- **Database**: SQLite (統合データベース)
- **Libraries**:
  - **TA-Lib**: 高性能テクニカル指標計算
  - **Pandas**: データ処理・分析
  - **NumPy**: 数値計算・線形回帰
  - **Rich**: 美しい CLI 表示
  - **SQLAlchemy**: データベース ORM
  - **Typer**: CLI フレームワーク
- **External APIs**: Yahoo Finance API (価格データ取得)

### アーキテクチャ

```
┌─────────────────────────────────────────────────────────────────┐
│                    CLI Layer (Typer)                            │
│  ┌─────────────────┐  ┌─────────────────┐  ┌─────────────────┐  │
│  │ detect-         │  │ analyze-        │  │ comprehensive-  │  │
│  │ divergences     │  │ support-        │  │ analysis        │  │
│  │                 │  │ resistance      │  │                 │  │
│  └─────────────────┘  └─────────────────┘  └─────────────────┘  │
│  ┌─────────────────┐  ┌─────────────────┐  ┌─────────────────┐  │
│  │ analyze-        │  │ analyze-        │  │ visualize       │  │
│  │ momentum        │  │ signals         │  │                 │  │
│  │                 │  │                 │  │                 │  │
│  └─────────────────┘  └─────────────────┘  └─────────────────┘  │
└─────────────────────────────────────────────────────────────────┘
                              │
┌─────────────────────────────────────────────────────────────────┐
│                  Business Logic Layer                           │
│  ┌─────────────────┐  ┌─────────────────┐  ┌─────────────────┐  │
│  │ Divergence      │  │ Support         │  │ Momentum        │  │
│  │ Detector        │  │ Resistance      │  │ Analyzer        │  │
│  │                 │  │ Analyzer        │  │                 │  │
│  └─────────────────┘  └─────────────────┘  └─────────────────┘  │
│  ┌─────────────────┐  ┌─────────────────┐  ┌─────────────────┐  │
│  │ Advanced        │  │ Technical       │  │ Comprehensive   │  │
│  │ Signal          │  │ Visualizer      │  │ Analysis        │  │
│  │ Analyzer        │  │                 │  │                 │  │
│  └─────────────────┘  └─────────────────┘  └─────────────────┘  │
└─────────────────────────────────────────────────────────────────┘
                              │
┌─────────────────────────────────────────────────────────────────┐
│                    Data Layer                                   │
│  ┌─────────────────┐  ┌─────────────────┐  ┌─────────────────┐  │
│  │ Technical       │  │ Price Data      │  │ Yahoo Finance   │  │
│  │ Indicators      │  │ Repository      │  │ Client          │  │
│  │ Repository      │  │                 │  │                 │  │
│  └─────────────────┘  └─────────────────┘  └─────────────────┘  │
└─────────────────────────────────────────────────────────────────┘
                              │
┌─────────────────────────────────────────────────────────────────┐
│                   Database Layer                                │
│  ┌─────────────────────────────────────────────────────────────┐  │
│  │              SQLite Database                                │  │
│  │  ┌─────────────────┐  ┌─────────────────┐  ┌─────────────┐  │  │
│  │  │ technical_      │  │ price_data      │  │ exchange_   │  │
│  │  │ indicators      │  │                 │  │ analytics   │  │
│  │  └─────────────────┘  └─────────────────┘  └─────────────┘  │  │
│  └─────────────────────────────────────────────────────────────┘  │
└─────────────────────────────────────────────────────────────────┘
```

## 3. 分析機能詳細仕様

### 3.1 ダイバージェンス検出システム

#### 3.1.1 機能概要

価格とテクニカル指標の乖離を分析し、ダイバージェンスを自動検出する機能

#### 3.1.2 対応指標

- **RSI**: 相対力指数
- **MACD**: 移動平均収束拡散
- **ストキャスティクス**: ストキャスティックオシレーター

#### 3.1.3 ダイバージェンスタイプ

##### 強気ダイバージェンス (Bullish Divergence)

- **定義**: 価格が下落しているが、指標が上昇している状態
- **シグナル**: 買いシグナル（反発期待）
- **視覚化**: 🟢 緑色で表示

##### 弱気ダイバージェンス (Bearish Divergence)

- **定義**: 価格が上昇しているが、指標が下落している状態
- **シグナル**: 売りシグナル（調整期待）
- **視覚化**: 🔴 赤色で表示

#### 3.1.4 検出アルゴリズム

```python
def _find_peaks(self, data: np.ndarray, window: int = 5) -> List[int]:
    """ピーク（極値）を検出"""
    peaks = []
    for i in range(window, len(data) - window):
        if all(data[i] >= data[j] for j in range(i - window, i)) and \
           all(data[i] >= data[j] for j in range(i + 1, i + window + 1)):
            peaks.append(i)
    return peaks
```

#### 3.1.5 信頼度計算

```python
def _calculate_divergence_confidence(self, data: pd.DataFrame, price_peak1: int, price_peak2: int,
                                   indicator_peak1: int, indicator_peak2: int) -> float:
    """ダイバージェンスの信頼度を計算"""
    # ピーク間の距離と価格変動の大きさから信頼度を計算
    price_change = abs(data.iloc[price_peak1]["close"] - data.iloc[price_peak2]["close"])
    indicator_change = abs(data.iloc[indicator_peak1]["close"] - data.iloc[indicator_peak2]["close"])

    # 基本的な信頼度（0.5-0.9の範囲）
    base_confidence = 0.5

    # 価格変動が大きいほど信頼度が高い
    if price_change > 1.0:
        base_confidence += 0.2
    elif price_change > 0.5:
        base_confidence += 0.1

    # 指標変動が大きいほど信頼度が高い
    if indicator_change > 10:
        base_confidence += 0.2
    elif indicator_change > 5:
        base_confidence += 0.1

    return min(base_confidence, 0.9)
```

#### 3.1.6 使用例

```bash
# 基本使用
exchange-analytics data detect-divergences

# 時間足と期間指定
exchange-analytics data detect-divergences --timeframe H1 --days 3

# 通貨ペア指定
exchange-analytics data detect-divergences --pair EUR/JPY
```

### 3.2 サポート・レジスタンス分析システム

#### 3.2.1 機能概要

移動平均線を活用した重要レベルの自動検出機能

#### 3.2.2 レベルタイプ

##### サポートレベル (Support Level)

- **定義**: 価格が下落を止める重要な価格レベル
- **視覚化**: 🟢 緑色で表示
- **強度**: 0.3-0.9 の範囲

##### レジスタンスレベル (Resistance Level)

- **定義**: 価格が上昇を止める重要な価格レベル
- **視覚化**: 🔴 赤色で表示
- **強度**: 0.3-0.9 の範囲

#### 3.2.3 検出方法

##### 移動平均線ベース

- **SMA**: 単純移動平均線
- **EMA**: 指数移動平均線
- **強度計算**: 移動平均線の傾きと価格との相関から計算

```python
def _calculate_ma_strength(self, data: pd.DataFrame, ma_type: str) -> float:
    """移動平均線の強度を計算"""
    # 移動平均線の傾きを計算
    ma_values = data[ma_type].dropna()
    x = np.arange(len(ma_values))
    slope, _ = np.polyfit(x, ma_values, 1)

    # 価格との相関を計算
    price_values = data["close"].iloc[:len(ma_values)]
    correlation = np.corrcoef(ma_values, price_values)[0, 1]

    # 強度を計算（0.3-0.9の範囲）
    base_strength = 0.3
    slope_factor = min(abs(slope) * 10, 0.3)
    correlation_factor = abs(correlation) * 0.3

    return min(base_strength + slope_factor + correlation_factor, 0.9)
```

##### ピボットポイントベース

- **R2**: 強力なレジスタンスレベル
- **R1**: レジスタンスレベル
- **S1**: サポートレベル
- **S2**: 強力なサポートレベル

```python
def _detect_pivot_levels(self, price_data: pd.DataFrame, timeframe: str) -> List[SupportResistanceLevel]:
    """ピボットポイントベースのレベルを検出"""
    # ピボットポイントを計算
    high = price_data["high"].max()
    low = price_data["low"].min()
    close = price_data["close"].iloc[-1]

    # 標準的なピボットポイント計算
    pivot = (high + low + close) / 3
    r1 = 2 * pivot - low
    s1 = 2 * pivot - high
    r2 = pivot + (high - low)
    s2 = pivot - (high - low)
```

#### 3.2.4 使用例

```bash
# 基本使用
exchange-analytics data analyze-support-resistance

# 時間足と期間指定
exchange-analytics data analyze-support-resistance --timeframe H4 --days 7

# 通貨ペア指定
exchange-analytics data analyze-support-resistance --pair EUR/JPY
```

### 3.3 モメンタム分析システム

#### 3.3.1 機能概要

指標の変化速度を分析する機能

#### 3.3.2 モメンタムタイプ

##### 強い上昇 (Strong Up)

- **条件**: 変化率 > 5.0% または 速度 > 5.0
- **視覚化**: 🟢 緑色で表示
- **シグナル**: 強い買いシグナル

##### 上昇 (Up)

- **条件**: 変化率 > 1.0% または 速度 > 1.0
- **視覚化**: 🟢 緑色で表示
- **シグナル**: 買いシグナル

##### 中立 (Neutral)

- **条件**: -1.0% < 変化率 < 1.0% かつ -1.0 < 速度 < 1.0
- **視覚化**: ⚪ 白色で表示
- **シグナル**: 中立

##### 下降 (Down)

- **条件**: 変化率 < -1.0% または 速度 < -1.0
- **視覚化**: 🔴 赤色で表示
- **シグナル**: 売りシグナル

##### 強い下降 (Strong Down)

- **条件**: 変化率 < -5.0% または 速度 < -5.0
- **視覚化**: 🔴 赤色で表示
- **シグナル**: 強い売りシグナル

#### 3.3.3 対応指標

- **RSI**: 相対力指数
- **MACD**: 移動平均収束拡散
- **ストキャスティクス**: ストキャスティックオシレーター
- **移動平均線**: SMA、EMA

#### 3.3.4 計算方法

```python
def _determine_momentum_type(self, velocity: float, change_rate: float) -> MomentumType:
    """モメンタムタイプを決定"""
    # 変化率と速度の両方を考慮
    if change_rate > 5.0 or velocity > 5.0:
        return MomentumType.STRONG_UP
    elif change_rate > 1.0 or velocity > 1.0:
        return MomentumType.UP
    elif change_rate < -5.0 or velocity < -5.0:
        return MomentumType.STRONG_DOWN
    elif change_rate < -1.0 or velocity < -1.0:
        return MomentumType.DOWN
    else:
        return MomentumType.NEUTRAL
```

#### 3.3.5 使用例

```bash
# 基本使用
exchange-analytics data analyze-momentum

# 時間足と期間指定
exchange-analytics data analyze-momentum --timeframe M5 --days 3

# 通貨ペア指定
exchange-analytics data analyze-momentum --pair EUR/JPY
```

### 3.4 統合分析システム

#### 3.4.1 機能概要

3 つの分析機能を統合実行し、市場状況の総合判断を提供

#### 3.4.2 統合実行フロー

```
1. ダイバージェンス分析実行
2. サポート・レジスタンス分析実行
3. モメンタム分析実行
4. 各分析結果の統合
5. 市場状況の総合判断
6. 推奨アクションの生成
```

#### 3.4.3 総合判断ロジック

```python
# 各分析の傾向を判定
trends = []

# ダイバージェンス傾向
if "divergences" in results:
    bullish_count = results["divergences"].count("強気ダイバージェンス")
    bearish_count = results["divergences"].count("弱気ダイバージェンス")
    if bullish_count > bearish_count:
        trends.append("🟢 ダイバージェンス: 強気")
    elif bearish_count > bullish_count:
        trends.append("🔴 ダイバージェンス: 弱気")
    else:
        trends.append("⚪ ダイバージェンス: 中立")

# モメンタム傾向
if "momentum" in results:
    if "上昇傾向" in results["momentum"]:
        trends.append("🟢 モメンタム: 上昇")
    elif "下降傾向" in results["momentum"]:
        trends.append("🔴 モメンタム: 下降")
    else:
        trends.append("⚪ モメンタム: 中立")

# 総合判断
bullish_trends = sum(1 for t in trends if "🟢" in t)
bearish_trends = sum(1 for t in trends if "🔴" in t)

if bullish_trends > bearish_trends:
    overall_momentum = "強気市場 - 買い機会を探す"
elif bearish_trends > bullish_trends:
    overall_momentum = "弱気市場 - 売り機会を探す"
else:
    overall_momentum = "中立市場 - 様子見推奨"
```

#### 3.4.4 推奨アクション

##### 強気市場の場合

- サポートレベルでの買いエントリーを検討
- 強気ダイバージェンスの確認
- 上昇トレンドの継続を確認

##### 弱気市場の場合

- レジスタンスレベルでの売りエントリーを検討
- 弱気ダイバージェンスの確認
- 下降トレンドの継続を確認

##### 中立市場の場合

- 明確なシグナルを待つ
- レンジ相場での取引を検討
- リスク管理を強化

#### 3.4.5 使用例

```bash
# 全分析実行
exchange-analytics data comprehensive-analysis

# 特定分析のみ
exchange-analytics data comprehensive-analysis --no-momentum

# 時間足と期間指定
exchange-analytics data comprehensive-analysis --timeframe H1 --days 3

# 通貨ペア指定
exchange-analytics data comprehensive-analysis --pair EUR/JPY
```

## 4. データ構造

### 4.1 ダイバージェンスシグナル

```python
@dataclass
class DivergenceSignal:
    """ダイバージェンスシグナル"""
    divergence_type: DivergenceType
    indicator: str
    timeframe: str
    price_high: float
    price_low: float
    indicator_high: float
    indicator_low: float
    confidence: float
    timestamp: datetime
    description: str
```

### 4.2 サポート・レジスタンスレベル

```python
@dataclass
class SupportResistanceLevel:
    """サポート・レジスタンスレベル"""
    level_type: LevelType
    price_level: float
    strength: float  # 0.0-1.0
    timeframe: str
    indicator: str
    timestamp: datetime
    description: str
```

### 4.3 モメンタムシグナル

```python
@dataclass
class MomentumSignal:
    """モメンタムシグナル"""
    indicator: str
    momentum_type: MomentumType
    current_value: float
    previous_value: float
    change_rate: float  # 変化率（%）
    velocity: float  # 変化速度
    timeframe: str
    timestamp: datetime
    description: str
```

## 5. 出力仕様

### 5.1 ダイバージェンス検出出力

```
🎯 ダイバージェンス検出結果 (3件)
============================================================

🟢 強気ダイバージェンス (2件):
  1. MACD - 信頼度: 0.50
     価格下落、MACD上昇の強気ダイバージェンス
     検出時刻: 2025-08-14 15:25
  2. STOCH - 信頼度: 0.50
     価格下落、STOCH上昇の強気ダイバージェンス
     検出時刻: 2025-08-14 15:25

🔴 弱気ダイバージェンス (1件):
  1. STOCH - 信頼度: 0.50
     価格上昇、STOCH下落の弱気ダイバージェンス
     検出時刻: 2025-08-14 15:50

📋 総合評価:
  🟢 強気傾向 (2 vs 1)
```

### 5.2 サポート・レジスタンス分析出力

```
🎯 サポート・レジスタンス分析結果 (6件)
============================================================

🔴 レジスタンスレベル:
  1. 149.349 (強度: 0.80) - R2レジスタンスレベル
  2. 147.871 (強度: 0.70) - R1レジスタンスレベル
  3. 146.640 (強度: 0.60) - SMAレジスタンスレベル
  4. 146.657 (強度: 0.60) - EMAレジスタンスレベル

🟢 サポートレベル:
  1. 144.731 (強度: 0.80) - S2サポートレベル
  2. 145.562 (強度: 0.70) - S1サポートレベル

📊 現在価格との関係:
  現在価格: 147.000
  最寄りレジスタンス: 146.640 (距離: -0.360)
  最寄りサポート: 145.562 (距離: 1.438)
```

### 5.3 モメンタム分析出力

```
🎯 モメンタム分析結果
==================================================

📊 RSIモメンタム:
  🔴 強い下降
     変化率: -10.49%
     速度: -5.660
     説明: 📉 RSIが10.49%下降 (53.97 → 48.31)

📊 MACDモメンタム:
  🔴 下降
     変化率: -1.16%
     速度: -0.000
     説明: 📉 MACDが1.16%下降 (-0.01 → -0.01)

📊 STOCHモメンタム:
  🟢 上昇
     変化率: +4.63%
     速度: +2.770
     説明: 📈 ストキャスティクスが4.63%上昇 (59.83 → 62.60)

📋 総合モメンタム評価:
  🔴 下降傾向 (上昇: 1件, 下降: 2件)
```

### 5.4 統合分析出力

```
🎯 包括的分析機能
📊 分析対象: USD/JPY (M5時間足, 7日間)

================================================================================
🔍 ダイバージェンス分析実行中...
✅ ダイバージェンス分析完了

================================================================================
📈 サポート・レジスタンス分析実行中...
✅ サポート・レジスタンス分析完了

================================================================================
⚡ モメンタム分析実行中...
✅ モメンタム分析完了

================================================================================
📋 分析結果サマリー
================================================================================

🎯 ダイバージェンス検出結果
--------------------------------------------------
🟢 強気ダイバージェンス (2件):
  1. MACD - 信頼度: 0.50
  2. STOCH - 信頼度: 0.50

🔴 弱気ダイバージェンス (1件):
  1. STOCH - 信頼度: 0.50

📊 サポート・レジスタンス分析結果
--------------------------------------------------
🔴 レジスタンスレベル:
  1. 149.349 (強度: 0.80) - R2レジスタンスレベル
  2. 147.871 (強度: 0.70) - R1レジスタンスレベル

🟢 サポートレベル:
  1. 144.731 (強度: 0.80) - S2サポートレベル
  2. 145.562 (強度: 0.70) - S1サポートレベル

⚡ モメンタム分析結果
--------------------------------------------------
📊 RSIモメンタム: 🔴 強い下降 (-10.49%)
📊 MACDモメンタム: 🔴 下降 (-1.16%)
📊 STOCHモメンタム: 🟢 上昇 (+4.63%)

================================================================================
🎯 総合分析評価
================================================================================
  🔍 ダイバージェンス: 3件検出
  📊 サポート・レジスタンス: 4件検出
  ⚡ モメンタム: 下降傾向

--------------------------------------------------------------------------------
📈 市場状況の総合判断
--------------------------------------------------------------------------------
📊 分析結果:
  🟢 ダイバージェンス: 強気
  🔴 モメンタム: 下降

🎯 総合判断:
  ⚪ 中立市場 - 様子見推奨

💡 推奨アクション:
  • 明確なシグナルを待つ
  • レンジ相場での取引を検討
  • リスク管理を強化
```

## 6. パフォーマンス仕様

### 6.1 実行時間

- **ダイバージェンス検出**: ~5 秒
- **サポート・レジスタンス分析**: ~8 秒
- **モメンタム分析**: ~3 秒
- **統合分析**: ~15 秒

### 6.2 精度指標

- **ダイバージェンス検出精度**: 信頼度 0.5-0.9
- **サポート・レジスタンス精度**: 強度 0.3-0.9
- **モメンタム分析精度**: 変化率 ±5%以上で検出

### 6.3 データ要件

- **最小データ件数**: 20 件以上
- **推奨データ件数**: 100 件以上
- **分析期間**: 3 日-30 日
- **対応時間足**: M5, H1, H4, D1

## 7. エラーハンドリング

### 7.1 エラー分類

#### 軽微なエラー

- **データ不足**: 分析に必要な最小データ件数に満たない場合
- **対応**: 警告メッセージを表示し、処理を継続

#### 重要なエラー

- **データベース接続エラー**: データベースへの接続に失敗した場合
- **対応**: エラーメッセージを表示し、処理を停止

#### 致命的なエラー

- **システムエラー**: 予期しないエラーが発生した場合
- **対応**: エラーログを記録し、処理を完全に停止

### 7.2 復旧オプション

- **再試行**: 同じ処理を再実行
- **スキップ**: 問題のある処理をスキップ
- **ロールバック**: 前の状態に戻す
- **基盤データ復元**: 基盤データから再開始

## 8. セキュリティ

### 8.1 データ保護

- **データ暗号化**: 機密データの暗号化
- **アクセス制御**: 適切なアクセス権限の設定
- **監査ログ**: データアクセスの記録

### 8.2 API セキュリティ

- **認証**: API キーの適切な管理
- **レート制限**: API 呼び出しの制限
- **エラーハンドリング**: セキュリティ関連エラーの適切な処理

## 9. 監視とログ

### 9.1 監視項目

- **実行時間**: 各分析の実行時間
- **成功率**: 分析の成功率
- **エラー率**: エラーの発生率
- **データ品質**: データの品質指標

### 9.2 ログ出力

- **情報ログ**: 処理の進行状況
- **警告ログ**: 注意が必要な状況
- **エラーログ**: エラーの詳細情報
- **デバッグログ**: 開発時の詳細情報

## 10. 拡張性

### 10.1 新しい分析機能の追加

- **プラグイン方式**: 新しい分析機能の簡単追加
- **設定ファイル**: 外部設定による柔軟性
- **API 対応**: 将来的な Web API 化への準備

### 10.2 スケーラビリティ

- **並列処理**: 複数分析の並列実行
- **キャッシュ機能**: 計算結果のキャッシュ
- **分散処理**: 複数サーバーでの分散処理

## 11. 今後の展開

### 11.0 優先実装機能

#### Discord 配信機能（最優先）

- **リアルタイムシグナル通知**
  - 短期戦略（M5-H1）のシグナル自動配信
  - カスタマイズ可能な通知条件設定
  - 複数 Discord チャンネル対応
  - 通知頻度制御（即座/5 分/15 分/1 時間）
- **通知内容**
  - シグナルタイプ（買い/売り/ホールド）
  - 信頼度と強度
  - 指標値と価格レベル
  - 推奨アクション

#### アラートシステム

- **条件付き通知機能**
  - RSI 過買い/過売りアラート
  - MACD クロスオーバーアラート
  - ボリンジャーバンドブレイクアラート
  - 価格レベルアラート
- **通知方法**
  - Discord 通知
  - Email 通知
  - Push 通知
  - SMS 通知

### 11.1 短期計画（3 ヶ月）

#### 新機能追加

- **バックテスト機能**: 戦略の検証システム
- **ポートフォリオ管理**: 複数通貨ペアの統合管理
- **リスク管理**: ポジションサイズとストップロス管理

#### 既存機能強化

- **ダイバージェンス検出精度向上**: 隠れダイバージェンス対応
- **サポート・レジスタンス強化**: 自動検出精度向上
- **モメンタム分析強化**: より詳細な変化率分析

### 11.2 中期計画（6 ヶ月）

#### 分析機能強化

- **ダイバージェンス検出**: 隠れダイバージェンス対応
- **サポート・レジスタンス自動検出**: より高精度なレベル検出
- **ボラティリティ予測**: 将来のボラティリティ予測

#### 自動化機能

- **自動売買システム**: 基本的な自動売買機能
- **リスク管理自動化**: 自動ストップロス設定
- **ポートフォリオ最適化**: 自動リバランス機能

### 11.3 長期計画（1 年）

#### エコシステム構築

- **自動売買システム**: 完全自動化トレーディング
- **ソーシャルトレーディング**: コミュニティ機能
- **Web UI**: ブラウザベースのインターフェース

#### グローバル展開

- **多言語対応**: 英語、中国語、韓国語対応
- **地域別分析**: 地域特有の市場分析
- **規制対応**: 各国の金融規制への対応

---

**作成日**: 2025 年 1 月 27 日
**バージョン**: 1.0
**作成者**: AI Assistant
**承認者**: ユーザー
**更新日**: 2025 年 1 月 27 日
**更新内容**: 高度な分析システムの設計書作成
